<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags for IEEE Xplore immersive article -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description"
    content="An interactive article on using genetic algorithms to solve the 8-Queens problem. Learn how the choice of representation and operators affects your genetic algorithm.">
  <meta charset="utf8">
  <title>
    Multi-Magnification Attention Convolutional Neural Networks
  </title>

  <!-- Stylesheet for IEEE Xplore immersive article -->
  <link rel="stylesheet" href="fonts/stylesheet.css">
  <link rel="stylesheet" href="css/style.css">

  <!-- MathJax javascript library and implementation file/s -->
  <script type="text/javascript" async
    src="https://xploreqa.ieee.org/xploreAssets/MathJax-274/MathJax.js?config=default"></script>

  <!-- Example chessboard immersive app -->
  <script type="text/javascript" src="https://xploreqa.ieee.org/assets/vendor/jquery/jquery-3.5.1.min.js"></script>
  <link rel="stylesheet" href="">
  <script type="text/javascript" src=""></script>

  <script type="text/javascript" src="jquery-3.5.1.js"></script>
  <script type="text/javascript" src="bnt.js"></script>

  <link rel="stylesheet" href="bnt.css">
  <script type="text/javascript" src="table.js"></script>

</head>

<body>
  <!-- Article with large top spacing -->
  <article class="mt-lg">
    <header>
      <!-- Page container -->
      <div class="container">
        <!-- Page title -->
        <h1>
          Multi-Magnification Attention Convolutional Neural Networks
        </h1>
        <!-- Subheading -->
        <p class="subhead">
          An illustrative case of cell segmentation in liver histopathology images.
        </p>
        <!-- Header info general wrapper -->
        <div class="header-info">
          <!-- Header left info box -->
          <div class="header-left box">
            <!-- Header authors section -->
            <div class="header-authors">
              <h2>Authors</h2>
              <ul>
                <li>Chia-Wei Chao | National Cheng Kung University, TAIWAN</li>
                <li>Daniel Winden Hwang | National Cheng Kung University, TAIWAN</li>
                <li>Hung-Wen Tsai | National Cheng Kung University, TAIWAN</li>
                <li>Shih-Hsuan Lin | National Cheng Kung University, TAIWAN</li>
                <li>Wei-Li Chen | National Cheng Kung University, TAIWAN</li>
                <li>Chun-Rong Huang | National Cheng Kung University, TAIWAN</li>
                <li>Pau-Choo Chung | National Cheng Kung University, TAIWAN</li>    
                <!-- <li>Chia-Wei Chao, Daniel Winden Hwang, Hung-Wen Tsai, Shih-Hsuan Lin, Wei-Li Chen, Chun-Rong Huang, and Pau-Choo Chung</li>
National Cheng Kung University, TAIWAN    -->
              </ul>
            </div>
            <!-- Published info section -->
            <div class="header-published">
              <h2>Published</h2>
              <p>May. 2, 2023</p>
            </div>
          </div>
          <!-- Header legend section -->
          <div class="header-legend">
            <svg class="click-icon" data-name="Click" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 83.62 122.88">
              <title>Click</title>
              <path
                d="M40.59,14.63a3.36,3.36,0,0,1-1,2.39l0,0a3.39,3.39,0,0,1-4.77,0,3.42,3.42,0,0,1-1-2.4V3.39A3.4,3.4,0,0,1,37.2,0a3.34,3.34,0,0,1,2.39,1,3.39,3.39,0,0,1,1,2.4V14.63Zm25,76.65a1.89,1.89,0,0,1,3.77,0V99.9a1.89,1.89,0,1,1-3.77,0V91.28ZM54.46,87.47a1.89,1.89,0,0,1,3.77,0V99.9a1.89,1.89,0,1,1-3.77,0V87.47Zm-28-7.63a1.92,1.92,0,0,1-.35-.23q-5.24-4.24-10.44-8.53a8.36,8.36,0,0,0-3.57-1.79,3.54,3.54,0,0,0-2,.09A2,2,0,0,0,9,70.49a6.9,6.9,0,0,0-.4,3.24,12.47,12.47,0,0,0,1.11,4,26.49,26.49,0,0,0,2.92,4.94l17.68,26.74a2.37,2.37,0,0,1,.36,1,15.28,15.28,0,0,0,1.87,6.4,2.89,2.89,0,0,0,2.57,1.46c9,0,18.62-.34,27.53,0a8.33,8.33,0,0,0,4.69-1.51,15,15,0,0,0,4.29-5l.34-.57c3.4-5.87,6.71-11.57,7-18.33L78.85,85l0-.33,0-1.84c.06-5.74.16-14.54-4.62-15.4H71.14c.09,2.46,0,5-.18,7.3-.08,1.36-.15,2.63-.15,3.79a2.31,2.31,0,1,1-4.62,0c0-1.1.08-2.52.17-4,.32-5.73.75-13.38-3.24-14.14h-3a2.2,2.2,0,0,1-.58-.07,69.07,69.07,0,0,1-.13,8.29c-.07,1.36-.15,2.63-.15,3.79a2.31,2.31,0,1,1-4.61,0c0-1.1.08-2.52.16-4,.33-5.73.76-13.38-3.24-14.14h-3a2,2,0,0,1-.6-.08V66a2.31,2.31,0,1,1-4.61,0V42c0-4-1.64-6.55-3.73-7.61a5.32,5.32,0,0,0-4.71-.06l-.1.06c-2.07,1-3.69,3.59-3.69,7.7v42a2.31,2.31,0,1,1-4.62,0V79.84Zm44.14-17a2.49,2.49,0,0,1,.61-.08h3.19a2.33,2.33,0,0,1,.53.06c8.73,1.4,8.61,12.65,8.52,20,0,3.4.14,6.78.18,10.17-.39,7.91-4,14.1-7.67,20.47l-.32.55A19.49,19.49,0,0,1,70,120.55a12.88,12.88,0,0,1-7.29,2.32H35.17a7.23,7.23,0,0,1-6.44-3.5,19,19,0,0,1-2.56-7.88L8.94,85.42A31,31,0,0,1,5.5,79.58,16.88,16.88,0,0,1,4,74a11.42,11.42,0,0,1,.8-5.42,6.54,6.54,0,0,1,3.55-3.49A8.05,8.05,0,0,1,13,64.76a13.19,13.19,0,0,1,5.61,2.77L26.45,74V42.09c0-6.1,2.73-10,6.22-11.82l.15-.06a9.81,9.81,0,0,1,4.33-1,10,10,0,0,1,4.49,1.07C45.16,32.06,47.91,36,47.91,42v7.6a2.41,2.41,0,0,1,.6-.08H51.7a2.33,2.33,0,0,1,.53.06c3.82.61,5.73,3.16,6.63,6.47a2.25,2.25,0,0,1,1.23-.36h3.18a2.26,2.26,0,0,1,.53.06c4.07.65,6,3.49,6.79,7.11ZM14.63,37A3.33,3.33,0,0,1,17,38a3.39,3.39,0,0,1-2.39,5.79H3.39a3.36,3.36,0,0,1-2.39-1A3.4,3.4,0,0,1,3.39,37ZM23,20.55a3.39,3.39,0,0,1-2.4,5.79,3.4,3.4,0,0,1-2.4-1l-7.91-7.94a3.42,3.42,0,0,1-1-2.4,3.39,3.39,0,0,1,5.79-2.4L23,20.55ZM59.2,43.81a3.41,3.41,0,0,1-3.4-3.4A3.41,3.41,0,0,1,59.2,37H70.43a3.35,3.35,0,0,1,2.4,1,3.4,3.4,0,0,1-2.4,5.79ZM55.62,24.74a3.39,3.39,0,0,1-4.8-4.8l7.91-8a3.39,3.39,0,0,1,4.8,4.8l-7.91,8Z" />
            </svg>
            <p>Indicates interactive elements</p>
          </div>
        </div>
        <!-- Box of anchored links -->
        <div class="contents box">
          <h2>Contents:</h2>
          <ul>
            <li>
              <a href="#introduction">Introduction</a>
              <span class="separator">&nbsp;&nbsp;|&nbsp;&nbsp;</span>
            </li>
            <li>
              <a href="#mmacnn">MMA-CNN</a>
              <span class="separator">&nbsp;&nbsp;|&nbsp;&nbsp;</span>
            </li>
            <li>
              <a href="#illustrativecasestudy">Illustratative Case Study: Cell Segmentation In Liver Histopathology
                Images</a>
              <span class="separator">&nbsp;&nbsp;|&nbsp;&nbsp;</span>
            </li>
            <li>
              <a href="#experimentalresults">Experimental Results</a>
              <span class="separator">&nbsp;&nbsp;|&nbsp;&nbsp;</span>
            </li>
            <li>
              <a href="#conclusions">Conclusions</a>
            </li>
          </ul>
        </div>
      </div>
    </header>

    <!-- Content container with large top spacing -->
    <div class="container mt-lg">
      <!-- Anchor ID -->
      <section id="introduction">
        <!-- Section title -->
        <h2>I. Introduction</h2>
        <p>
          Convolutional neural networks (CNNs) are nowadays used for many image analysis tasks, including image 
          classification [<a href="#ref_1">1</a>] [<a href="#ref_2">2</a>], object detection [<a href="#ref_3">3</a>] 
          [<a href="#ref_4">4</a>], and image segmentation [<a href="#ref_5">5</a>] [<a href="#ref_6">6</a>]. 
          Even though CNNs perform well in many cases, they struggle to deal with applications involving 
          large-scale and high-resolution images, such as those frequently encountered in medicine [<a href="#ref_7">7</a>] 
          [<a href="#ref_8">8</a>] [<a href="#ref_9">9</a>] and environmental science [<a href="#ref_10">10</a>], which typically contain hundreds 
          of thousands of pixels.
        </p>
        <p>
          The large size of scanned images presents problems when they are directly input into CNNs. To overcome this
          problem, an intuitive approach is to split the input image into small patches, which are then input into the
          model in small batches. The model subsequently performs its assigned task (e.g., classification or segmentation) based
          on the input image patches. However, in many applications, it is necessary to scrutinize not only the
          local features of the input image patches but also the global features of the input image at lower magnifications. In other
          words, rather than the single-magnification view used in most CNN models, it is necessary to adopt a multi-magnification
          approach, in which the model accesses both the global and local features of the image for the final decision.
        </p>
        <p>
          Consider a case of a pathologist examining a tissue slide image through a microscope for possible evidence of 
          cancer. Typically, the pathologist commences by using a low-magnification setting to identify 
          possible regions of cancerous tissue in the image. Having identified a suspicious region, s/he then
          switches to a high-magnification view to examine the region in more detail. Based on the observation results 
          obtained in these two views, the pathologist determines whether the tissue is malignant or benign.
        </p>
        <p>
          Several automated methods have been proposed for imitating such multi-magnification observation processes.  
          For example, Das et al. [<a href="#ref_11">11</a>] applied a majority voting approach to the CNN inference 
          results obtained from image patches with different magnifications. Huang et al. [<a href="#ref_12">12</a>] 
          and Rasoolijaberi et al. [<a href="#ref_13">13</a>] used matched high- and low-magnification image patches as input pairs to the CNN 
          models. Tokunaga et al. [<a href="#ref_14">14</a>] used a weighted CNN to weight the features extracted 
          from image patches with different magnifications.
        </p>
        <p>
          Although [<a href="#ref_14">14</a>] enables the model to adaptively determine the general
          importance of all the features extracted at the same magnification level (i.e., all the features at the
          same magnification level are assigned the same weight), it is hard to ascertain the weights of
          each individual feature at each level of magnification. Consequently, attention mechanisms
          [<a href="#ref_15">15</a>], which allow the weights of the extracted features at each magnification
          to be adapted individually, have recently attracted a great deal of interest. 
        </p>
        <p>
          From the discussions above, it is clear that multi-scale observations and attention mechanisms provide an ideal 
          opportunity for facilitating the applications of CNNs in many fields. In this paper, a multi-magnification attention convolutional 
          neural network (MMA-CNN) is proposed to solve the aforementioned problems and applied to achieve patch-wise 
          classification and approximated segmentation of high-resolution pathology whole slide images (WSIs). 
          MMA-CNN combines multi-scale observations and attention mechanisms to improve the performance of CNNs, 
          which only consider a single-magnification view of the target object.
        </p>
        <p style="text-align: right">
          Chia-Wei Chao<br>
          May 2, 2023
        </p>
      </section>

      <section id="mmacnn">
        <h2>II. MMA-CNN</h2>
        <p>
          Table 1 and Fig. 1 show the basic architecture of the MMA-CNN model. The model contains three modules:
          the feature extraction module (FEM), the feature integration and magnification attention module (FIMAM), 
          and the classification module (CM).
        </p>

        <div class="framed">
          <div class="inside">
            <div class="eyebrow">
              Try moving your cursor over the table or figure. You will see that the corresponding layers and blocks light up as you do so. 
            </div>
            <div id="board-letsplay" style="width: 100%; margin: auto auto 10px;">
              <div style="border:5px solid white;">
                <p>
                <div id="canvaGroup">
                  <canvas id="featureTest" height="600" width="700" style="margin: 20 0 0 20; "></canvas>
                  <canvas id="MA_2d" height="600" width="700" style="margin: 20 0 0 20;  position: relative;"></canvas>
                </div>

                <script src="js/three.js"></script>

                <script>
                  //MA is abbreviation of "Model architecture"
                  //<Initial Condition Setting:---------------------------------->
                  //<Temporary variables:---------------------------------------->
                  var MA_Scene;
                  var MA_highlightModelNumber;
                  var MA_Canvas;
                  var MA_CanvasAspect;                                  //
                  var MA_d;                                             //margin, used by camera
                  var MA_Camera;                                        //Object of Three.js
                  var MA_Renderer;
                  var MA_2dCanvas;
                  var MA_2dCtx;

                  var ConvIdleMaterial;
                  var PollingIdleMaterial;
                  var highlightMaterial;
                  var Conv_1x1_IdleMaterial;
                  var Atrous_IdleMaterial;
                  var ConcatenatedFeatureMap_IdleMaterial;
                  var AttentionFeatureMap_IdleMaterial;

                  var tempLayers = [];
                  var MA_layersType;
                  var MA_layersSize;

                  var image_featureMapTest;

                  var ST_images = [];

                  var MA_canvasStyle;
                  var Canvas2ElementStyle;

                  var MA_canvasGroup;
                  var MA_canvasGroupStyle;
                  var table;
                  var hasPressedModel = false;

                  var imageLoaded = false;



     
                  var img_model_bricks;
                  var img_model_text;
                  var img_model_arrow1;
                  var img_model_arrow2;
                  var img_model_aspp;
                  var img_model_dashed;
                  var img_hpool1;
                  var img_hpool2;
                  var img_hpool3;
                  var img_hpool4;
                  var img_white;
                  var img_lpool1;
                  var img_lpool2;
                  var img_lpool3;
                  var img_lpool4;
                  var highOrLow = -1;
                  var highLightedModelNumber = 1;



                  //<---------------------------------------------->
                  MA_Initialization();


                  function MA_Initialization() {
                    MA_Scene = new THREE.Scene();
                    MA_highlightModelNumber = -1;
                    MA_Canvas = document.getElementById("featureTest");
                    MA_2dCanvas = document.getElementById("MA_2d");
                    MA_2dCtx = MA_2dCanvas.getContext('2d');
                    MA_canvasGroup = document.getElementById("canvaGroup");
                    MA_CanvasAspect = MA_Canvas.width / MA_Canvas.height;
                    MA_d = 40;
                    MA_Camera = new THREE.OrthographicCamera(- MA_d * MA_CanvasAspect, MA_d * MA_CanvasAspect, MA_d, - MA_d, 1, 1000);
                    MA_Camera.lookAt(MA_Scene.position);

                    MA_canvasStyle = MA_Canvas.style;
                    Canvas2ElementStyle = MA_2dCanvas.style;
                    MA_canvasGroupStyle = MA_canvasGroup.style;

                    MA_Renderer = new THREE.WebGLRenderer({
                      canvas: MA_Canvas,
                      antialias: true,
                      alpha: true,
                    });
                    MA_Renderer.setClearColor(0x000000, 0); // the default

                    MA_SceneAndLight();
                    MA_SetCamera();

                    ConvIdleMaterial = new THREE.MeshLambertMaterial({ color: 0x00ff00, emissive: 0x3c7029 });
                    PollingIdleMaterial = new THREE.MeshLambertMaterial({ color: 0x00ffff, emissive: 0x0071b3 });
                    Conv_1x1_IdleMaterial = new THREE.MeshLambertMaterial({ color: 0xf60404, emissive: 0x7b2828 });
                    highlightMaterial = new THREE.MeshLambertMaterial({ color: 0xf68504, emissive: 0xbb6c2a });
                    Atrous_IdleMaterial = new THREE.MeshLambertMaterial({ color: 0xce5f13, emissive: 0x7c3e13 });
                    ConcatenatedFeatureMap_IdleMaterial = new THREE.MeshLambertMaterial({ color: 0xf4f45f, emissive: 0x9e9e09 });
                    AttentionFeatureMap_IdleMaterial = new THREE.MeshLambertMaterial({ color: 0x725688, emissive: 0x7f4ea4 });
                    neuralnetwork_IdleMaterial = new THREE.MeshLambertMaterial({color:0xf60404,emissive: 0x7b2828  })
                    //https://threejs.org/docs/#api/en/materials/MeshLambertMaterial


                    MA_layersType = ["Conv", "Conv", "Pooling", "Conv", "Conv", "Pooling", "Conv", "Conv", "Conv", "Pooling", "Conv", "Conv", "Conv", "Pooling", "Conv", "Conv", "Conv", "Conv"
                      , "Conv", "Pooling", "Conv", "Conv", "Pooling", "Conv", "Conv", "Conv", "Pooling", "Conv", "Conv", "Conv", "Pooling", "Conv", "Conv", "Conv"
                      , "Conv_1x1", "Atrous", "Concatenated", "Attention", "Conv", "Conv", "Conv", "Pooling", "Neu", "Neu", "Neu"];
                    MA_layersSize = [14, 14, 12, 12, 12, 10, 10, 10, 10, 8, 8, 8, 8, 6, 6, 6, 6];

                    var elementStyle = MA_2dCanvas.style;

                    elementStyle.position = "relative";
                    elementStyle.up = "600";
                    
                    MA_DrawCanvas();
                    MA_ShowModelArchitecture();

                    var MA_CanvasRect = MA_Canvas.getBoundingClientRect();
                    var deltaY = 0;

                    let canvas1AbsolutePosition_y = window.pageYOffset + MA_CanvasRect.top - 290;
                    let canvas1AbsolutePosition_X = window.pageXOffset + MA_CanvasRect.left + 500;

                    //calculate canvas2's offset
                    offset = canvas1AbsolutePosition_y + deltaY;
                    text2 = offset.toString() + "px";
                    elementStyle.top = elementStyle.up = text2;

                    offset = canvas1AbsolutePosition_X - 500;
                    text2 = offset.toString() + "px";
                    elementStyle.right = elementStyle.left = text2;
                    elementStyle.zIndex = "2";
                    MA_canvasGroupStyle.position = "absolute";
                    Canvas2ElementStyle.top = Canvas2ElementStyle.up = "0px";
                    Canvas2ElementStyle.right = Canvas2ElementStyle.left = "0px";


                    let num = 2900 + (MA_highlightModelNumber + 1) * 15 - 500;
                    let text = num.toString() + "px";

                    let test = document.getElementById("tableId");
                    MA_canvasGroupStyle.top = MA_canvasGroupStyle.up = text;

                    //let bodyRect = document.body.getBoundingClientRect();
                    //let elemRect = test.getBoundingClientRect();
                    //offset   = elemRect.top - bodyRect.top;
                    //console.log(offset);

                  }

                  function MA_DrawCanvas() {
                    var count = 0;

                   

                    img_model_bricks = new Image();
                    img_model_bricks.src = "img/model/network_model_bricks.png";
                    img_model_bricks.onload = on_model_bricks_loaded;
                    function on_model_bricks_loaded() {
                      onImageLoaded();
                    }


                

                    img_model_text = new Image();
                    img_model_text.src = "img/model/network_model_text.png";
                    img_model_text.onload = on_model_text_loaded;
                    function on_model_text_loaded() {
                      onImageLoaded();
                    }


                    img_model_arrow1 = new Image();
                    img_model_arrow1.src = "img/model/concate.png";
                    img_model_arrow1.onload = on_model_arrow1_loaded;
                    function on_model_arrow1_loaded() {
                      onImageLoaded();
                    }


                    img_model_mblock = new Image();
                    img_model_mblock.src = "img/model/magblock.png";
                    img_model_mblock.onload = on_model_mlock_loaded;
                    function on_model_mlock_loaded() {
                      onImageLoaded();
                    }


                    img_model_aspp = new Image();
                    img_model_aspp.src = "img/model/network_model_aspp.png";
                    img_model_aspp.onload = on_model_aspp_loaded;
                    function on_model_aspp_loaded() {
                      onImageLoaded();
                    }


                    img_model_dashed = new Image();
                    img_model_dashed.src = "img/model/dash1.png";
                    img_model_dashed.onload = on_model_dashed_loaded;
                    function on_model_dashed_loaded() {
                      onImageLoaded();
                    }
                    img_bracket = new Image();
                    img_bracket.src = "img/model/brackets.png";
                    img_bracket.onload = on_model_bracket_loaded;
                    function on_model_bracket_loaded() {
                      onImageLoaded();
                    }
                    img_bracket2 = new Image();
                    img_bracket2.src = "img/model/bracket2.png";
                    img_bracket2.onload = on_model_bracket2_loaded;
                    function on_model_bracket2_loaded() {
                      onImageLoaded();
                    }
                    img_bracket3 = new Image();
                    img_bracket3.src = "img/model/bracket3.png";
                    img_bracket3.onload = on_model_bracket3_loaded;
                    function on_model_bracket3_loaded() {
                      onImageLoaded();
                    }

                    MA_2dCtx.fillStyle = "black";
                    MA_2dCtx.font = 'normal  bold 16px "Arial"';
                    MA_2dCtx.fillText('High-Magnification ', 30, 255);
                    MA_2dCtx.fillText('Feature Extractor ', 35, 275);
                    MA_2dCtx.fillText('Low-Magnification ', 30, 565);
                    MA_2dCtx.fillText('Feature Extractor ', 35, 585);
                    MA_2dCtx.font = 'normal  bold 14px "Arial"';
                    MA_2dCtx.fillText('Concatenate ', 270, 355);
                    MA_2dCtx.fillText('Neural', 530, 455);
                    MA_2dCtx.fillText('Network ', 525, 475);

                    MA_2dCtx.font = 'normal  bold 13px "Arial"';
                    MA_2dCtx.fillText('Atrous Feature Maps',340,395);
                    MA_2dCtx.fillText('Concatenated Feature Maps',340,430);
                    MA_2dCtx.fillText('Convolution Feature Maps',340,465);
                    MA_2dCtx.fillText('Pooling Feature Maps',340,500);
                    MA_2dCtx.fillText('Attention Feature Maps',340,535);

                    MA_2dCtx.font = 'normal  bold 18px "Arial"';
                    
                    MA_2dCtx.fillText('FEM ', 110, 15);
                    MA_2dCtx.fillText('FIMAM ', 320, 15);
                    MA_2dCtx.fillText('CM ', 510, 13);
                    var imagePaths = [
                      "img/model/network_model_arrows.png",
                      "img/model/network_model_bricks.png",
                      "img/model/network_model_neural.png",
                      "img/model/network_model_text.png",
                      "img/model/network_model_arrow1.png",
                      "img/model/network_model_arrow2.png",
                      "img/model/network_model_aspp.png",
                      "img/model/brackets.png",
                      "img/featuremap/ASPP_dashboard.png",
                      
                    ]

                    function onImageLoaded() {
                      count += 1;
                      if (count >= imagePaths.length) {
                        draw2dImage();
                      }
                    }

                    //https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/drawImage
                    function draw2dImage() {
                      imageLoaded = true;
                      MA_2dCtx.drawImage(img_model_bricks, 270, 360, 255, 190);
                      MA_2dCtx.drawImage(img_model_text, 290, 160, 160, 90);
                      MA_2dCtx.drawImage(img_model_arrow1, 140, 140, 150, 310);
                      MA_2dCtx.drawImage(img_model_mblock, 310, 245, 120, 50);
                      MA_2dCtx.drawImage(img_model_aspp, 165, 500, 104, 48);
                      MA_2dCtx.drawImage(img_model_dashed, 175, 372, 80, 150);
                      MA_2dCtx.drawImage(img_bracket, 20, 15, 240, 50);
                      MA_2dCtx.drawImage(img_bracket, 253, 15, 210, 50);
                      MA_2dCtx.drawImage(img_bracket, 460, 15, 130, 50);
                    }


                  }

                  function MA_SceneAndLight() {
                    let pointLight = new THREE.PointLight(0xffffff);
                    pointLight.position.set(20, 100, 0);
                    MA_Scene.add(pointLight);
                  }

                  function MA_SetCamera() {
                    MA_Camera.position.z = 50;
                    MA_Camera.position.x = 30;
                    MA_Camera.position.y = 5;
                    MA_Camera.lookAt(new THREE.Vector3(0, 0, 0));
                    MA_Camera.up.set(0, 0, 0);
                  }

                  function MA_ShowModelArchitecture() {
                    var startPositionX = -43;
                    var marginOfPositionX = 1;
                    var i;
                    for (i = 0; i < MA_layersSize.length; i++) {
                      let tempgemoetry = new THREE.BoxGeometry(.7, MA_layersSize[i] * 1.5, MA_layersSize[i] * 1.5);
                      let cube;

                      if (MA_layersType[i] == "Conv") {
                        cube = new THREE.Mesh(tempgemoetry, ConvIdleMaterial);
                      }
                      else if (MA_layersType[i] == "Pooling") {
                        cube = new THREE.Mesh(tempgemoetry, PollingIdleMaterial);
                      }
                      else {
                        cube = new THREE.Mesh(tempgemoetry, ConvIdleMaterial);
                      }
                      cube.position.x = startPositionX + i * marginOfPositionX;
                      cube.rotation.y -= 0;
                      cube.position.y += 20;
                      cube.rotation.x += .17;
                      cube.rotation.z -= .1;
                      tempLayers.push(cube);
                      MA_Scene.add(cube);
                    }

                    for (i = 0; i < MA_layersSize.length; i++) {
                      let tempgemoetry = new THREE.BoxGeometry(.7, MA_layersSize[i] * 1.5, MA_layersSize[i] * 1.5);
                      let cube;

                      if (MA_layersType[i] == "Conv") {
                        cube = new THREE.Mesh(tempgemoetry, ConvIdleMaterial);
                      }
                      else if (MA_layersType[i] == "Pooling") {
                        cube = new THREE.Mesh(tempgemoetry, PollingIdleMaterial);
                      }
                      else {
                        cube = new THREE.Mesh(tempgemoetry, ConvIdleMaterial);
                      }
                      cube.position.x = startPositionX + i * marginOfPositionX;
                      cube.rotation.y -= 0;
                      cube.position.y -= 20;
                      cube.rotation.x += .17;
                      cube.rotation.z -= .1;
                      tempLayers.push(cube);
                      MA_Scene.add(cube);
                    }
                    //1x1 Conv
                    let Conv_1x1_Geometry = new THREE.BoxGeometry(6, 5, 5);
                    let cube_1x1Conv = new THREE.Mesh(Conv_1x1_Geometry, ConvIdleMaterial);
                    tempLayers.push(cube_1x1Conv);
                    MA_Scene.add(cube_1x1Conv);
                    cube_1x1Conv.rotation.x += .17;
                    cube_1x1Conv.rotation.z -= .1;
                    cube_1x1Conv.position.x = startPositionX + 21 * marginOfPositionX + 2;
                    cube_1x1Conv.position.y -= 17;
                    cube_1x1Conv.position.z += 2;

                    //Atrous Feature Maps
                    let Atrous_Geometry = new THREE.BoxGeometry(6, 5, 5);
                    let cube_Atrous = new THREE.Mesh(Atrous_Geometry, Atrous_IdleMaterial);
                    tempLayers.push(cube_Atrous);
                    MA_Scene.add(cube_Atrous);
                    cube_Atrous.rotation.x += .17;
                    cube_Atrous.rotation.z -= .1;
                    cube_Atrous.position.x = startPositionX + 21 * marginOfPositionX + 2;
                    cube_Atrous.position.y -= 23;
                    cube_Atrous.position.z += 2;

                    //Concatenated Feature Maps
                    let ConcatenatedFeatureMap_Geometry = new THREE.BoxGeometry(2, 8, 6);
                    let cube_ConcatenatedFeatureMap = new THREE.Mesh(ConcatenatedFeatureMap_Geometry, ConcatenatedFeatureMap_IdleMaterial);
                    tempLayers.push(cube_ConcatenatedFeatureMap);
                    MA_Scene.add(cube_ConcatenatedFeatureMap);
                    cube_ConcatenatedFeatureMap.rotation.x += .17;
                    cube_ConcatenatedFeatureMap.rotation.z -= .1;
                    cube_ConcatenatedFeatureMap.position.x = startPositionX + 21 * marginOfPositionX + 2 + 13;
                    //cube_ConcatenatedFeatureMap.position.y -= 23;
                    cube_ConcatenatedFeatureMap.position.z -= 0.5;

                    let AttentionFeatureMap_Geometry = new THREE.BoxGeometry(2, 8, 6);
                    let cube_AttentionFeatureMap = new THREE.Mesh(AttentionFeatureMap_Geometry, AttentionFeatureMap_IdleMaterial);
                    tempLayers.push(cube_AttentionFeatureMap);
                    MA_Scene.add(cube_AttentionFeatureMap);
                    cube_AttentionFeatureMap.rotation.x += .17;
                    cube_AttentionFeatureMap.rotation.z -= .1;
                    cube_AttentionFeatureMap.position.x = startPositionX + 21 * marginOfPositionX + 15 + 20 + 2;
                    //cube_ConcatenatedFeatureMap.position.y -= 23;
                    cube_AttentionFeatureMap.position.z += 2;

                    let Conv14_Geometry = new THREE.BoxGeometry(.7, 8, 8);
                    let cube_Conv14 = new THREE.Mesh(Conv14_Geometry, ConvIdleMaterial);
                    tempLayers.push(cube_Conv14);
                    MA_Scene.add(cube_Conv14);
                    cube_Conv14.rotation.x += .17;
                    cube_Conv14.rotation.z -= .1;
                    cube_Conv14.position.x = startPositionX + 21 * marginOfPositionX + 2 + 15 + 25;

                    let Conv15_Geometry = new THREE.BoxGeometry(.7, 8, 8);
                    let cube_Conv15 = new THREE.Mesh(Conv15_Geometry, ConvIdleMaterial);
                    tempLayers.push(cube_Conv15);
                    MA_Scene.add(cube_Conv15);
                    cube_Conv15.rotation.x += .17;
                    cube_Conv15.rotation.z -= .1;
                    cube_Conv15.position.x = startPositionX + 21 * marginOfPositionX + 2 + 15 + 25 + 1.5;

                    let Conv16_Geometry = new THREE.BoxGeometry(.7, 8, 8);
                    let cube_Conv16 = new THREE.Mesh(Conv16_Geometry, ConvIdleMaterial);
                    tempLayers.push(cube_Conv16);
                    MA_Scene.add(cube_Conv16);
                    cube_Conv16.rotation.x += .17;
                    cube_Conv16.rotation.z -= .1;
                    cube_Conv16.position.x = startPositionX + 21 * marginOfPositionX + 2 + 15 + 25 + 1.5 + 1.5;

                    let Polling5_Geometry = new THREE.BoxGeometry(.7, 8, 8);
                    let cube_Polling5 = new THREE.Mesh(Polling5_Geometry, PollingIdleMaterial);
                    tempLayers.push(cube_Polling5);
                    MA_Scene.add(cube_Polling5);
                    cube_Polling5.rotation.x += .17;
                    cube_Polling5.rotation.z -= .1;
                    cube_Polling5.position.x = startPositionX + 21 * marginOfPositionX + 2 + 15 + 25 + 1.5 + 1.5 + 1.5;

                    // FC1/2

                    let FC_Geometry = new THREE.BoxGeometry(.7, 30, 1);
                    let FC = new THREE.Mesh(FC_Geometry, neuralnetwork_IdleMaterial);
                    tempLayers.push(FC);
                    MA_Scene.add(FC);
                    FC.rotation.x += .17;
                    FC.rotation.z -= .1;
                    FC.position.x = startPositionX + 21 * marginOfPositionX + 16 + 25 + 2 + 8;

                    let neuralnetwork_Geometry = new THREE.BoxGeometry(.7, 30, 1);
                    let neuralnetwork = new THREE.Mesh(neuralnetwork_Geometry, neuralnetwork_IdleMaterial);
                    tempLayers.push(neuralnetwork);
                    MA_Scene.add(neuralnetwork);
                    neuralnetwork.rotation.x += .17;
                    neuralnetwork.rotation.z -= .1;
                    neuralnetwork.position.x = startPositionX + 21 * marginOfPositionX + 16 + 25 + 1 + 1.5 + 1.5 + 8;

                    let output_Geometry = new THREE.BoxGeometry(.7, 5, 1);
                    let output = new THREE.Mesh(output_Geometry, neuralnetwork_IdleMaterial);
                    tempLayers.push(output);
                    MA_Scene.add(output);
                    output.rotation.x += .17;
                    output.rotation.z -= .1;
                    output.position.x = startPositionX + 21 * marginOfPositionX + 16 + 25 + 4.5 + 1.5 + 8;

                    var Canvas2ElementStyle = MA_2dCanvas.style;
                    Canvas2ElementStyle.position = "absolute";
                    var bodyRect = document.body.getBoundingClientRect();
                    var elemRect = MA_Canvas.getBoundingClientRect();
                    offset = elemRect.top - bodyRect.top - 337;
                    text2 = offset.toString() + "px";
                    Canvas2ElementStyle.top = Canvas2ElementStyle.up = text2;
                    offset = elemRect.left - bodyRect.left + 5;
                    text2 = offset.toString() + "px";
                    Canvas2ElementStyle.right = Canvas2ElementStyle.left = text2;
                    Canvas2ElementStyle.zIndex = "2"
                  }


                  MA_Renderer.render(MA_Scene, MA_Camera);


                  function showrow(index) { }  //This function called by another js code, so left the empty one here.

                  //https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/drawImage

                  function showFeatureMap(index) { }

                  const pickPosition = { x: 0, y: 0 };
                  class PickHelper {
                    constructor() {
                      this.raycaster = new THREE.Raycaster();
                      this.pickedObject = null;
                      this.pickedObjectSavedColor = 0;
                    }
                    pick(normalizedPosition, scene, camera) {
                      if (this.pickedObject) {
                        if (MA_layersType[tempLayers.indexOf(this.pickedObject)] == "Conv") {
                          this.pickedObject.material = ConvIdleMaterial;

                        }
                        else if (MA_layersType[tempLayers.indexOf(this.pickedObject)] == "Pooling") {
                          this.pickedObject.material = PollingIdleMaterial;
                        }
                        else if (MA_layersType[tempLayers.indexOf(this.pickedObject)] == "Conv_1x1") {
                          this.pickedObject.material = ConvIdleMaterial;
                        }
                        else if (MA_layersType[tempLayers.indexOf(this.pickedObject)] == "Atrous") {
                          this.pickedObject.material = Atrous_IdleMaterial;
                        }
                        else if (MA_layersType[tempLayers.indexOf(this.pickedObject)] == "Concatenated") {
                          this.pickedObject.material = ConcatenatedFeatureMap_IdleMaterial;
                        }
                        else if (MA_layersType[tempLayers.indexOf(this.pickedObject)] == "Attention") {
                          this.pickedObject.material = AttentionFeatureMap_IdleMaterial;
                        }
                        else if (MA_layersType[tempLayers.indexOf(this.pickedObject)] == "Neu") {
                          this.pickedObject.material = neuralnetwork_IdleMaterial;
                        }
                        this.pickedObject = undefined;
                      }
                      this.raycaster.setFromCamera(normalizedPosition, camera);
                      // get the list of objects the ray intersected
                      const intersectedObjects = this.raycaster.intersectObjects(scene.children);
                      if (intersectedObjects.length) {
                        // pick the first object. It's the closest one
                        this.pickedObject = intersectedObjects[0].object;
                        // save its color
                        this.pickedObjectSavedColor = this.pickedObject.material.emissive.getHex();
                        this.pickedObject.material = highlightMaterial;
                        var indexOfTempLayers = tempLayers.indexOf(this.pickedObject);

                        if (indexOfTempLayers >= 17 && indexOfTempLayers <= 33) {
                          MA_highlightModelNumber = indexOfTempLayers - 17;
                          highOrLow = 2;
                        }
                        else if (indexOfTempLayers >= 38) {
                          MA_highlightModelNumber = indexOfTempLayers - 17 + 3;
                        }
                        else if (indexOfTempLayers >= 33) {
                          MA_highlightModelNumber = indexOfTempLayers - 17;
                        }
                        else {
                          MA_highlightModelNumber = indexOfTempLayers;
                          highOrLow = 1;
                        }
                      }

                      MA_highlightModelNumber = intersectedObjects.length == 0 ? -1 : MA_highlightModelNumber;
                      showrow(MA_highlightModelNumber + 1);
                    }
                  }
                  function resizeRendererToDisplaySize(renderer) {
                    const canvas = renderer.domElement;
                    const width = canvas.clientWidth;
                    const height = canvas.clientHeight;
                    const needResize = canvas.width !== width || canvas.height !== height;
                    if (needResize) {
                      renderer.setSize(width, height, false);
                    }
                    return needResize;
                  }
                  function getCanvasRelativePosition(event) {
                    const canvas = MA_Renderer.domElement;
                    const rect = canvas.getBoundingClientRect();
                    return {
                      x: event.clientX - rect.left,
                      y: event.clientY - rect.top,
                    };
                  }

                  function setPickPosition(event) {
                    const canvas = MA_Renderer.domElement;
                    const pos = getCanvasRelativePosition(event);
                    pickPosition.x = (pos.x / canvas.clientWidth) * 2 - 1;
                    pickPosition.y = (pos.y / canvas.clientHeight) * -2 + 1;  // note we flip Y
                  }

                  function clearPickPosition() {
                    MA_highlightModelNumber = -1;
                    pickPosition.x = -100000;
                    pickPosition.y = -100000;
                  }

                  function checkClickPosition() {
                    showrow(MA_highlightModelNumber + 1);
                    showFeatureMap(MA_highlightModelNumber + 1);

                    Canvas2ElementStyle.top = Canvas2ElementStyle.up = "0px";
                    Canvas2ElementStyle.right = Canvas2ElementStyle.left = "0px";
                    //abosulte 
                    if (MA_highlightModelNumber != -1) {
                      let num = 2900 + (MA_highlightModelNumber + 1) * 15;
                      let num2 = num - 600;
                      let text = num.toString() + "px";
                      let text2 = num2.toString() + "px";
                      highLightedModelNumber = MA_highlightModelNumber;
                      var table = document.getElementById("tableId");
                      MA_canvasGroupStyle.top = MA_canvasGroupStyle.up = text;

                      MA_canvasStyle.zIndex = "1";
                      var TableRect = table.getBoundingClientRect();
                      var MA_CanvasRect = MA_Canvas.getBoundingClientRect();

                      hasPressedModel = true;
                    }

                  }

                  function test1() {
                    showFeatureMap(MA_highlightModelNumber + 1);
                  }

                  window.addEventListener('click', checkClickPosition);
                  window.addEventListener('mousemove', test1)
                  window.addEventListener('mousemove', setPickPosition);
                  window.addEventListener('mouseout', clearPickPosition);
                  window.addEventListener('mouseleave', clearPickPosition);
                  window.addEventListener('touchstart', (event) => {
                    event.preventDefault();
                    setPickPosition(event.touches[0]);
                  }, { passive: false });

                  window.addEventListener('touchmove', (event) => {
                    setPickPosition(event.touches[0]);
                  });

                  window.addEventListener('touchend', clearPickPosition);
                  const pickHelper = new PickHelper();


                  function render() {
                    if (resizeRendererToDisplaySize(MA_Renderer)) {
                      const canvas = MA_Renderer.domElement;
                      MA_Camera.aspect = canvas.clientWidth / canvas.clientHeight;
                      MA_Camera.updateProjectionMatrix();
                    }
                    pickHelper.pick(pickPosition, MA_Scene, MA_Camera);
                    MA_Renderer.render(MA_Scene, MA_Camera);
                    requestAnimationFrame(render);

                    table = document.getElementById("tableId");
                    var tableWidth = table ? table.offsetWidth + 200 : 0;
                    MA_canvasGroupStyle.right = MA_canvasGroupStyle.left = (window.innerWidth / 2 - 60).toString() + "px";
                    var bodyRect = document.body.getBoundingClientRect();
                    var elemRect = table ? table.getBoundingClientRect() : 0;
                    var offset = elemRect.top - bodyRect.top - 30;


                    let num = offset + (highLightedModelNumber + 1) * 30;
                    let text = num.toString() + "px";
                    MA_canvasGroupStyle.top = MA_canvasGroupStyle.up = text;
                  }
                  var currentHighlightIndex = 5;
                  function highLightModel(modelNumber) {
                    if (modelNumber == -1 || modelNumber <= -1 || modelNumber >= tempLayers.length + 1) {
                      var i = 0;
                      for (i = 0; i < tempLayers.length + 1; i++) {
                        if (MA_layersType[i] == "Conv") {
                          tempLayers[i].material = ConvIdleMaterial;
                        }
                        else if (MA_layersType[i] == "Pooling") {
                          tempLayers[i].material = PollingIdleMaterial;
                        }
                        else if (MA_layersType[i] == "Conv_1x1") {
                          tempLayers[i].material = ConvIdleMaterial;
                        }
                        else if (MA_layersType[i] == "Atrous") {
                          tempLayers[i].material = Atrous_IdleMaterial;
                        }
                        else if (MA_layersType[i] == "Concatenated") {
                          tempLayers[i].material = ConcatenatedFeatureMap_IdleMaterial;
                        }
                        else if (MA_layersType[i] == "Attention") {
                          tempLayers[i].material = AttentionFeatureMap_IdleMaterial;
                        }
                      }
                      return;
                    }
                    if (modelNumber == 0)
                      return;
                    if (modelNumber <= 17) {
                      tempLayers[modelNumber - 1].material = highlightMaterial;
                      tempLayers[modelNumber - 1 + 17].material = highlightMaterial;
                    }
                    else if (modelNumber <= 21) {
                      tempLayers[modelNumber - 1 + 17].material = highlightMaterial;
                    }
                    else if (modelNumber >= 25 && modelNumber <= 31) {
                      tempLayers[modelNumber - 1 - 3 + 17].material = highlightMaterial;
                    }
                  }
                  requestAnimationFrame(render);
                </script>
                </p>
                <p>&nbsp;</p>
                <br>
              </div>
              <div style="bottom:700px;position: relative; left : 0px; top: 0px;z-index: 3;">
                <table class="tableId" id="tableId" style="border: 1px solid black;">
                  <thead>
                    <tr>
                      <th id="title_l" rowspan="2" colspan="3">Layers</th>
                      <th id="title_n" rowspan="2">Output Size</th>
                      <th id="title_p" colspan="8" class='inline-math'>Kernel size($$k$$), Stride($$s$$), ASPP
                        dilation
                        rates($$r$$)</th>

                    </tr>
                    <tr>
                      <td colspan="4">High</td>
                      <td colspan="4">Low</td>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="3" id="1">Conv 1</td>
                      <td hover>256×256×64</td>
                      <td colspan="8" class='inline-math'>$$k$$=3, $$s$$=1</td>
                    </tr>
                    <tr>
                      <td colspan="3" id="2">Conv 2</td>
                      <td>256×256×64</td>
                      <td colspan="8" class='inline-math'>$$k$$=3, $$s$$=1</td>
                    </tr>
                    <tr>
                      <td colspan="3" id="3">Max pooling 1</td>
                      <td>128×128×64</td>
                      <td colspan="8" class='inline-math'>$$k$$=2, $$s$$=2</td>
                    </tr>

                    <tr>
                      <td colspan="3" id="4">Conv 3</td>
                      <td>128×128×128</td>
                      <td colspan="8" class='inline-math'>$$k$$=3, $$s$$=1</td>
                    </tr>
                    <tr>
                      <td colspan="3" id="5">Conv 4</td>
                      <td>128×128×128</td>
                      <td colspan="8" class='inline-math'>$$k$$=3, $$s$$=1</td>
                    </tr>
                    <tr>
                      <td colspan="3" id="6">Max pooling 2</td>
                      <td>64×64×128</td>
                      <td colspan="8" class='inline-math'>$$k$$=3, $$s$$=1</td>
                    </tr>
                    <tr>
                      <td colspan="3" id="7">Conv 5</td>
                      <td>64×64×256</td>
                      <td colspan="8" class='inline-math'>$$k$$=3, $$s$$=1</td>
                    </tr>
                    <tr>
                      <td colspan="3" id="8">Conv 6</td>
                      <td>64×64×256</td>
                      <td colspan="8" class='inline-math'>$$k$$=3, $$s$$=1</td>
                    </tr>
                    <tr>
                      <td colspan="3" id="9">Conv 7</td>
                      <td>64×64×256</td>
                      <td colspan="8" class='inline-math'>$$k$$=3, $$s$$=1</td>
                    </tr>
                    <tr>
                      <td colspan="3" id="10">Max pooling 3</td>
                      <td>32×32×256</td>
                      <td colspan="8" class='inline-math'>$$k$$=2, $$s$$=2</td>
                    </tr>
                    <tr>
                      <td colspan="3" id="11">Conv 8</td>
                      <td>32×32×512</td>
                      <td colspan="8" class='inline-math'>$$k$$=3, $$s$$=1</td>
                    </tr>
                    <tr>
                      <td colspan="3" id="12">Conv 9</td>
                      <td>32×32×512</td>
                      <td colspan="8" class='inline-math'>$$k$$=3, $$s$$=1</td>
                    </tr>
                    <tr>
                      <td colspan="3" id="13">Conv 10</td>
                      <td>32×32×512</td>
                      <td colspan="8" class='inline-math'>$$k$$=3, $$s$$=1</td>
                    </tr>
                    <tr>
                      <td colspan="3" id="14">Max pooling 4</td>
                      <td>16×16×512</td>
                      <td colspan="8" class='inline-math'>$$k$$=2, $$s$$=2</td>
                    </tr>
                    <tr>
                      <td colspan="3" id="15">Conv 11</td>
                      <td>16×16×512</td>
                      <td colspan="8" class='inline-math'>$$k$$=3, $$s$$=1</td>
                    </tr>
                    <tr>
                      <td colspan="3" id="16">Conv 12</td>
                      <td>16×16×512</td>
                      <td colspan="8" class='inline-math'>$$k$$=3, $$s$$=1</td>
                    </tr>
                    <tr>
                      <td colspan="3" id="17">Conv 13</td>
                      <td>16×16×512</td>
                      <td colspan="8" class='inline-math'>$$k$$=3, $$s$$=1</td>
                    </tr>
                    <tr>
                      <td rowspan="2" style="background-color: white;">ASPP<br>block</td>
                      <td>Conv<br>(1×1)</td>
                      <td>16×16×512</td>
                      <td colspan="1"> None</td>
                      <td colspan="8" class='inline-math'>$$k$$=1, $$s$$=1,<br> $$r$$=1</td>

                    </tr>
                    <tr>
                      <td id="19">Atrous<br>1-2</td>
                      <td>16×16×512</td>
                      <td colspan="1"> None</td>
                      <td colspan="8" class='inline-math'>$$k$$=3, $$s$$=1,<br>$$r$$=2</td>
                    </tr>
                    <tr>
                      <td colspan="3" id="20">Concatenate 1</td>
                      <td>16×16×1024</td>
                      <td colspan="8">None</td>
                    </tr>

                    <tr>
                      <td rowspan="4" style="background-color: white;">Magnification-attention</td>
                      <td colspan="2" id="21">Global Average Pooling 1</td>
                      <td>1×1×1024</td>
                      <td colspan="8" class='inline-math'>$$k$$=8, $$s$$=1</td>
                    </tr>
                    <tr>
                      <td colspan="2" id="22">FC1(+ReLU)</td>
                      <td>1×1×64</td>
                      <td rowspan="3" colspan="8" style="background-color: white;">None</td>
                    </tr>
                    <tr>
                      <td colspan="2" id="23">FC2(+sigmoid)</td>
                      <td>1×1×1024</td>
                    </tr>
                    <tr>
                      <td colspan="2">Scale</td>
                      <td>16×16×1024</td>
                    </tr>
                    <tr>
                      <td colspan="3" id="24">Conv 14</td>
                      <td>16×16×512</td>
                      <td colspan="8" class='inline-math'>$$k$$=3, $$s$$=1</td>
                    </tr>
                    <tr>
                      <td colspan="3" id="25">Conv 15</td>
                      <td>16×16×512</td>
                      <td colspan="8" class='inline-math'>$$k$$=3, $$s$$=1</td>
                    </tr>
                    <tr>
                      <td colspan="3" id="26">Conv 16</td>
                      <td>16×16×512</td>
                      <td colspan="8" class='inline-math'>$$k$$=3, $$s$$=1</td>
                    </tr>
                    <tr>
                      <td colspan="3" id="27">Max pooling 5</td>
                      <td>8×8×512</td>
                      <td colspan="8" class='inline-math'>$$k$$=2, $$s$$=2</td>
                    </tr>
                    <tr>
                      <td colspan="3" id="28">FC1</td>
                      <td>4096</td>
                      <td rowspan="3" colspan="8" style="background-color: white;">None</td>
                    </tr>
                    <tr>
                      <td colspan="3" id="29">FC2</td>
                      <td>4096</td>
                    </tr>
                    <tr>
                      <td colspan="3" id="30">Output</td>
                      <td>3</td>
                    </tr>
                  </tbody>
                </table>
                <script type="text/javascript" src="table.js"></script>
              </div>
            </div>
            <div class="caption"><b>Figure 1 & Table 1. </b><br>Model architecture.</div>

            <script type="module" src=""></script>
          </div>
        </div>

        <p>
          Having skimmed through the overall structure of MMA-CNN, let us now take a closer look at each of the
          modules within.
        </p>

        <h3>2.1 Feature Extraction Module (FEM)</h3>
        <p class="inline-math">
          The FEM contains two parallel VGG-16 CNNs, which extract the feature maps of the image patches with high and 
          low magnifications, respectively.
          As shown in Table I, the two parallel VGG-16 networks contain convolutional (Conv) layers and 
          max-pooling layers to extract the deep feature maps of the image patches with different magnifications. The 
          resolutions and channels of the feature maps in each layer are shown in the second column of the table. 
          In addition, the kernel sizes ($$k$$), strides ($$s$$), and ASPP dilation rates ($$r$$) for the high- 
          and low-magnification VGG-16 networks are shown in the third column. 
        </p>
        <p>
          Fig. 2 shows some typical feature maps generated at different layers of the MMA-CNN model for the 
          illustrative cases of histopathology image inputs. Move your cursor slowly over the two feature extractors 
          on the left-hand side of the figure. When you hover over a particular convolutional block (consisting of 
          several convolutional layers and one max-pooling layer), six randomly-chosen feature maps are displayed at 
          the top of the figure. Since the early layers capture low-level features such as edges, you can see that 
          some of the characteristics of the feature maps are similar to those of the input images. However, the 
          deeper layers capture more complex features such as object structures, and as a result, the feature maps 
          of these deeper layers tend to be more abstract. 
        </p>

        <div class="framed">
          <div class="inside" style="height: 850px;">
            <div class="eyebrow">
              Select the class of the image patches and move your cursor slowly over the two feature extractors 
              on the left-hand side of the figure. When you hover over a particular convolutional block, six randomly-chosen feature maps are displayed on 
              the top of the figure.
            </div>
            <div id="board-letsplay" style="width: 100%; margin: auto auto 10px;">
              <div style="border:5px solid white;">
                <p>
                <label><b>Class of the image patches:</b>
                  <select id="class_Selector" style="font-size:15px;text-align:center;margin:0 20px 0 0px;"
                    onchange="ST_Getvalue();">
                    <option value="1" selected>Normal</option>
                    <option value="2">Tumorous</option>
                    <option value="3">Necrotic</option>
                  </select>
                </label>
                <div id="ST_canvaGroup">
                  <canvas id="ST_featureTest" height="600" width="1000"
                    style="margin: 20 0 0 20;"></canvas>
                  <canvas id="ST_MA_2d" height="600" width="1000"
                    style="margin: 20 0 0 20;  position: relative;"></canvas>
                  <div class="caption" style="position: relative; left : 10px; "><b>Figure 2. </b> <br>Visualization of the extracted feature maps in FEM.
                  </div>
                </div>


                <script src="js/three.js"></script>

                <script>
                  //ST is abbreviation of "Structure"
                  //<Initial Condition Setting:---------------------------------->
                  //<Temporary variables:---------------------------------------->
                  var ST_Scene;
                  var ST_highlightModelNumber;
                  var ST_Canvas;
                  var ST_CanvasAspect;                                  //
                  var ST_d;                                             //margin, used by camera
                  var ST_Camera;                                        //Object of Three.js
                  var ST_Renderer;
                  var ST_2dCanvas;
                  var ST_2dCtx;

                  var ST_ConvIdleMaterial;
                  var ST_PollingIdleMaterial;
                  var ST_highlightMaterial;
                  var ST_Conv_1x1_IdleMaterial;
                  var ST_Atrous_IdleMaterial;
                  var ST_ConcatenatedFeatureMap_IdleMaterial;
                  var ST_AttentionFeatureMap_IdleMaterial;

                  var ST_tempLayers = [];
                  var ST_layersType;
                  var ST_layersSize;

                  var ST_image_featureMapTest;

                  var ST_images = [];


                  var ST_canvasStyle;
                  var ST_Canvas2ElementStyle;

                  var ST_canvasGroup;
                  var ST_canvasGroupStyle;
                  var ST_table;
                  var ST_hasPressedModel = false;

                  var ST_imageLoaded = false;

                  let selectors = new Array("", "normal","tumor", "necrosis");
                  var class_selectnum;
                  
                  var featureMapsFolder = "img/FeatureMaps/";
                  var featureMapsArray = new Array(186);
                  var featureMapsNumbers = 184;
                  var pathToImgMap = new Map();
                  var ST_FeatureMaps;

                  var ST_highLightedModelNumber = 1;
                  var Class_selector = document.getElementById("class_Selector");


                  //<---------------------------------------------->
                  ST_LoadFeatureMaps();
                  ST_Initialization();

                  function ST_Getvalue() {
                    class_selectnum = Class_selector.value;
                    if (class_selectnum == 1) {
                        ST_2dCtx.drawImage(normal_high, 0, 100, 120, 120);
                        ST_2dCtx.drawImage(normal_low, 0, 400, 120, 120);

                    }
                    if (class_selectnum == 2) {
                        ST_2dCtx.drawImage(tumor_high, 0, 100, 120, 120);
                        ST_2dCtx.drawImage(tumor_low, 0, 400, 120, 120);
                    }
                    if (class_selectnum == 3) {
                        ST_2dCtx.drawImage(necrosis_high, 0, 100, 120, 120);
                        ST_2dCtx.drawImage(necrosis_low, 0, 400, 120, 120);
                    }

                    
                  }

                  function ST_LoadFeatureMaps(){//wendian
                      ST_FeatureMaps = [
                        "img/FeatureMaps/necrosis/10x.png",
                        "img/FeatureMaps/necrosis/40x.png",
                        "img/FeatureMaps/necrosis/High/fe/1.png",
                        "img/FeatureMaps/necrosis/High/fe/2.png",
                        "img/FeatureMaps/necrosis/High/fe/3.png",
                        "img/FeatureMaps/necrosis/High/fe/4.png",
                        "img/FeatureMaps/necrosis/High/fe/5.png",
                        "img/FeatureMaps/necrosis/High/fe/6.png",
                        "img/FeatureMaps/necrosis/High/Pool1/1.png",
                        "img/FeatureMaps/necrosis/High/Pool1/2.png",
                        "img/FeatureMaps/necrosis/High/Pool1/3.png",
                        "img/FeatureMaps/necrosis/High/Pool1/4.png",
                        "img/FeatureMaps/necrosis/High/Pool1/5.png",
                        "img/FeatureMaps/necrosis/High/Pool1/6.png",
                        "img/FeatureMaps/necrosis/High/Pool2/1.png",
                        "img/FeatureMaps/necrosis/High/Pool2/2.png",
                        "img/FeatureMaps/necrosis/High/Pool2/3.png",
                        "img/FeatureMaps/necrosis/High/Pool2/4.png",
                        "img/FeatureMaps/necrosis/High/Pool2/5.png",
                        "img/FeatureMaps/necrosis/High/Pool2/6.png",
                        "img/FeatureMaps/necrosis/High/Pool3/1.png",
                        "img/FeatureMaps/necrosis/High/Pool3/2.png",
                        "img/FeatureMaps/necrosis/High/Pool3/3.png",
                        "img/FeatureMaps/necrosis/High/Pool3/4.png",
                        "img/FeatureMaps/necrosis/High/Pool3/5.png",
                        "img/FeatureMaps/necrosis/High/Pool3/6.png",
                        "img/FeatureMaps/necrosis/High/Pool4/1.png",
                        "img/FeatureMaps/necrosis/High/Pool4/2.png",
                        "img/FeatureMaps/necrosis/High/Pool4/3.png",
                        "img/FeatureMaps/necrosis/High/Pool4/4.png",
                        "img/FeatureMaps/necrosis/High/Pool4/5.png",
                        "img/FeatureMaps/necrosis/High/Pool4/6.png",
                        "img/FeatureMaps/necrosis/Low/ASPP_block/1.png",
                        "img/FeatureMaps/necrosis/Low/ASPP_block/2.png",
                        "img/FeatureMaps/necrosis/Low/ASPP_block/3.png",
                        "img/FeatureMaps/necrosis/Low/ASPP_block/4.png",
                        "img/FeatureMaps/necrosis/Low/ASPP_block/5.png",
                        "img/FeatureMaps/necrosis/Low/ASPP_block/6.png",
                        "img/FeatureMaps/necrosis/Low/Pool1/1.png",
                        "img/FeatureMaps/necrosis/Low/Pool1/2.png",
                        "img/FeatureMaps/necrosis/Low/Pool1/3.png",
                        "img/FeatureMaps/necrosis/Low/Pool1/4.png",
                        "img/FeatureMaps/necrosis/Low/Pool1/5.png",
                        "img/FeatureMaps/necrosis/Low/Pool1/6.png",
                        "img/FeatureMaps/necrosis/Low/Pool2/1.png",
                        "img/FeatureMaps/necrosis/Low/Pool2/2.png",
                        "img/FeatureMaps/necrosis/Low/Pool2/3.png",
                        "img/FeatureMaps/necrosis/Low/Pool2/4.png",
                        "img/FeatureMaps/necrosis/Low/Pool2/5.png",
                        "img/FeatureMaps/necrosis/Low/Pool2/6.png",
                        "img/FeatureMaps/necrosis/Low/Pool3/1.png",
                        "img/FeatureMaps/necrosis/Low/Pool3/2.png",
                        "img/FeatureMaps/necrosis/Low/Pool3/3.png",
                        "img/FeatureMaps/necrosis/Low/Pool3/4.png",
                        "img/FeatureMaps/necrosis/Low/Pool3/5.png",
                        "img/FeatureMaps/necrosis/Low/Pool3/6.png",
                        "img/FeatureMaps/necrosis/Low/Pool4/1.png",
                        "img/FeatureMaps/necrosis/Low/Pool4/2.png",
                        "img/FeatureMaps/necrosis/Low/Pool4/3.png",
                        "img/FeatureMaps/necrosis/Low/Pool4/4.png",
                        "img/FeatureMaps/necrosis/Low/Pool4/5.png",
                        "img/FeatureMaps/necrosis/Low/Pool4/6.png",
                        "img/FeatureMaps/normal/10x.png",
                        "img/FeatureMaps/normal/40x.png",
                        "img/FeatureMaps/normal/High/fe/1.png",
                        "img/FeatureMaps/normal/High/fe/2.png",
                        "img/FeatureMaps/normal/High/fe/3.png",
                        "img/FeatureMaps/normal/High/fe/4.png",
                        "img/FeatureMaps/normal/High/fe/5.png",
                        "img/FeatureMaps/normal/High/fe/6.png",
                        "img/FeatureMaps/normal/High/Pool1/1.png",
                        "img/FeatureMaps/normal/High/Pool1/2.png",
                        "img/FeatureMaps/normal/High/Pool1/3.png",
                        "img/FeatureMaps/normal/High/Pool1/4.png",
                        "img/FeatureMaps/normal/High/Pool1/5.png",
                        "img/FeatureMaps/normal/High/Pool1/6.png",
                        "img/FeatureMaps/normal/High/Pool2/1.png",
                        "img/FeatureMaps/normal/High/Pool2/2.png",
                        "img/FeatureMaps/normal/High/Pool2/3.png",
                        "img/FeatureMaps/normal/High/Pool2/4.png",
                        "img/FeatureMaps/normal/High/Pool2/5.png",
                        "img/FeatureMaps/normal/High/Pool2/6.png",
                        "img/FeatureMaps/normal/High/Pool3/1.png",
                        "img/FeatureMaps/normal/High/Pool3/2.png",
                        "img/FeatureMaps/normal/High/Pool3/3.png",
                        "img/FeatureMaps/normal/High/Pool3/4.png",
                        "img/FeatureMaps/normal/High/Pool3/5.png",
                        "img/FeatureMaps/normal/High/Pool3/6.png",
                        "img/FeatureMaps/normal/High/Pool4/1.png",
                        "img/FeatureMaps/normal/High/Pool4/2.png",
                        "img/FeatureMaps/normal/High/Pool4/3.png",
                        "img/FeatureMaps/normal/High/Pool4/4.png",
                        "img/FeatureMaps/normal/High/Pool4/5.png",
                        "img/FeatureMaps/normal/High/Pool4/6.png",
                        "img/FeatureMaps/normal/Low/ASPP_block/1.png",
                        "img/FeatureMaps/normal/Low/ASPP_block/2.png",
                        "img/FeatureMaps/normal/Low/ASPP_block/3.png",
                        "img/FeatureMaps/normal/Low/ASPP_block/4.png",
                        "img/FeatureMaps/normal/Low/ASPP_block/5.png",
                        "img/FeatureMaps/normal/Low/ASPP_block/6.png",
                        "img/FeatureMaps/normal/Low/Pool1/1.png",
                        "img/FeatureMaps/normal/Low/Pool1/2.png",
                        "img/FeatureMaps/normal/Low/Pool1/3.png",
                        "img/FeatureMaps/normal/Low/Pool1/4.png",
                        "img/FeatureMaps/normal/Low/Pool1/5.png",
                        "img/FeatureMaps/normal/Low/Pool1/6.png",
                        "img/FeatureMaps/normal/Low/Pool2/1.png",
                        "img/FeatureMaps/normal/Low/Pool2/2.png",
                        "img/FeatureMaps/normal/Low/Pool2/3.png",
                        "img/FeatureMaps/normal/Low/Pool2/4.png",
                        "img/FeatureMaps/normal/Low/Pool2/5.png",
                        "img/FeatureMaps/normal/Low/Pool2/6.png",
                        "img/FeatureMaps/normal/Low/Pool3/1.png",
                        "img/FeatureMaps/normal/Low/Pool3/2.png",
                        "img/FeatureMaps/normal/Low/Pool3/3.png",
                        "img/FeatureMaps/normal/Low/Pool3/4.png",
                        "img/FeatureMaps/normal/Low/Pool3/5.png",
                        "img/FeatureMaps/normal/Low/Pool3/6.png",
                        "img/FeatureMaps/normal/Low/Pool4/1.png",
                        "img/FeatureMaps/normal/Low/Pool4/2.png",
                        "img/FeatureMaps/normal/Low/Pool4/3.png",
                        "img/FeatureMaps/normal/Low/Pool4/4.png",
                        "img/FeatureMaps/normal/Low/Pool4/5.png",
                        "img/FeatureMaps/normal/Low/Pool4/6.png",
                        "img/FeatureMaps/tumor/10x.png",
                        "img/FeatureMaps/tumor/40x.png",
                        "img/FeatureMaps/tumor/High/fe/1.png",
                        "img/FeatureMaps/tumor/High/fe/2.png",
                        "img/FeatureMaps/tumor/High/fe/3.png",
                        "img/FeatureMaps/tumor/High/fe/4.png",
                        "img/FeatureMaps/tumor/High/fe/5.png",
                        "img/FeatureMaps/tumor/High/fe/6.png",
                        "img/FeatureMaps/tumor/High/Pool1/1.png",
                        "img/FeatureMaps/tumor/High/Pool1/2.png",
                        "img/FeatureMaps/tumor/High/Pool1/3.png",
                        "img/FeatureMaps/tumor/High/Pool1/4.png",
                        "img/FeatureMaps/tumor/High/Pool1/5.png",
                        "img/FeatureMaps/tumor/High/Pool1/6.png",
                        "img/FeatureMaps/tumor/High/Pool2/1.png",
                        "img/FeatureMaps/tumor/High/Pool2/2.png",
                        "img/FeatureMaps/tumor/High/Pool2/3.png",
                        "img/FeatureMaps/tumor/High/Pool2/4.png",
                        "img/FeatureMaps/tumor/High/Pool2/5.png",
                        "img/FeatureMaps/tumor/High/Pool2/6.png",
                        "img/FeatureMaps/tumor/High/Pool3/1.png",
                        "img/FeatureMaps/tumor/High/Pool3/2.png",
                        "img/FeatureMaps/tumor/High/Pool3/3.png",
                        "img/FeatureMaps/tumor/High/Pool3/4.png",
                        "img/FeatureMaps/tumor/High/Pool3/5.png",
                        "img/FeatureMaps/tumor/High/Pool3/6.png",
                        "img/FeatureMaps/tumor/High/Pool4/1.png",
                        "img/FeatureMaps/tumor/High/Pool4/2.png",
                        "img/FeatureMaps/tumor/High/Pool4/3.png",
                        "img/FeatureMaps/tumor/High/Pool4/4.png",
                        "img/FeatureMaps/tumor/High/Pool4/5.png",
                        "img/FeatureMaps/tumor/High/Pool4/6.png",
                        "img/FeatureMaps/tumor/Low/ASPP_block/1.png",
                        "img/FeatureMaps/tumor/Low/ASPP_block/2.png",
                        "img/FeatureMaps/tumor/Low/ASPP_block/3.png",
                        "img/FeatureMaps/tumor/Low/ASPP_block/4.png",
                        "img/FeatureMaps/tumor/Low/ASPP_block/5.png",
                        "img/FeatureMaps/tumor/Low/ASPP_block/6.png",
                        "img/FeatureMaps/tumor/Low/Pool1/1.png",
                        "img/FeatureMaps/tumor/Low/Pool1/2.png",
                        "img/FeatureMaps/tumor/Low/Pool1/3.png",
                        "img/FeatureMaps/tumor/Low/Pool1/4.png",
                        "img/FeatureMaps/tumor/Low/Pool1/5.png",
                        "img/FeatureMaps/tumor/Low/Pool1/6.png",
                        "img/FeatureMaps/tumor/Low/Pool2/1.png",
                        "img/FeatureMaps/tumor/Low/Pool2/2.png",
                        "img/FeatureMaps/tumor/Low/Pool2/3.png",
                        "img/FeatureMaps/tumor/Low/Pool2/4.png",
                        "img/FeatureMaps/tumor/Low/Pool2/5.png",
                        "img/FeatureMaps/tumor/Low/Pool2/6.png",
                        "img/FeatureMaps/tumor/Low/Pool3/1.png",
                        "img/FeatureMaps/tumor/Low/Pool3/2.png",
                        "img/FeatureMaps/tumor/Low/Pool3/3.png",
                        "img/FeatureMaps/tumor/Low/Pool3/4.png",
                        "img/FeatureMaps/tumor/Low/Pool3/5.png",
                        "img/FeatureMaps/tumor/Low/Pool3/6.png",
                        "img/FeatureMaps/tumor/Low/Pool4/1.png",
                        "img/FeatureMaps/tumor/Low/Pool4/2.png",
                        "img/FeatureMaps/tumor/Low/Pool4/3.png",
                        "img/FeatureMaps/tumor/Low/Pool4/4.png",
                        "img/FeatureMaps/tumor/Low/Pool4/5.png",
                        "img/FeatureMaps/tumor/Low/Pool4/6.png",
                      ]
                      for(i = 0; i < ST_FeatureMaps.length; i++){
                        
                        var newImg = new Image();
                        newImg.src = ST_FeatureMaps[i];
                        newImg.onload = ST_onFeatureMapLoad;
                        featureMapsArray[i] = newImg;
                      }
                    }
                  function ST_onFeatureMapLoad(){
                    featureMapsNumbers --;
                    if(!featureMapsNumbers){
                      // ST_Initialization();
                      for(i = 0; i < ST_FeatureMaps.length; i ++){
                        pathToImgMap.set(ST_FeatureMaps[i], i);
                      }
                    }
                    
                  }

                  function ST_Initialization() {
                    ST_Scene = new THREE.Scene();
                    ST_Scene.background = new THREE.Color(0xffffff);
                    ST_highlightModelNumber = -1;
                    ST_Canvas = document.getElementById("ST_featureTest");
                    ST_2dCanvas = document.getElementById("ST_MA_2d");
                    ST_2dCtx = ST_2dCanvas.getContext('2d');
                    ST_canvasGroup = document.getElementById("ST_canvaGroup");
                    ST_CanvasAspect = ST_Canvas.width / ST_Canvas.height;
                    ST_d = 40;
                    ST_Camera = new THREE.OrthographicCamera(-ST_d * ST_CanvasAspect, ST_d * ST_CanvasAspect, ST_d, - ST_d, 1, 1000);
                    ST_Camera.lookAt(ST_Scene.position);

                    ST_canvasStyle = ST_Canvas.style;
                    ST_Canvas2ElementStyle = ST_2dCanvas.style;
                    ST_canvasGroupStyle = ST_canvasGroup.style;

                    ST_Renderer = new THREE.WebGLRenderer({
                      canvas: ST_Canvas,
                      antialias: true,
                      alpha: true,
                    });
                    ST_Renderer.setClearColor(0x000000, 0); // the default

                    ST_SceneAndLight();
                    ST_SetCamera();

                    ST_ConvIdleMaterial = new THREE.MeshLambertMaterial({ color: 0x00ff00, emissive: 0x3c7029 });
                    ST_PollingIdleMaterial = new THREE.MeshLambertMaterial({ color: 0x00ffff, emissive: 0x0071b3 });
                    ST_Conv_1x1_IdleMaterial = new THREE.MeshLambertMaterial({ color: 0xf60404, emissive: 0x7b2828 });
                    ST_highlightMaterial = new THREE.MeshLambertMaterial({ color: 0xf68504, emissive: 0xbb6c2a });
                    ST_Atrous_IdleMaterial = new THREE.MeshLambertMaterial({ color: 0xce5f13, emissive: 0x7c3e13 });
                    ST_ConcatenatedFeatureMap_IdleMaterial = new THREE.MeshLambertMaterial({ color: 0xf4f45f, emissive: 0x9e9e09 });
                    ST_AttentionFeatureMap_IdleMaterial = new THREE.MeshLambertMaterial({ color: 0x725688, emissive: 0x7f4ea4 });
                    ST_neuralnetwork_IdleMaterial = new THREE.MeshLambertMaterial({color:0xf60404,emissive: 0x7b2828 })
                    //https://threejs.org/docs/#api/en/materials/MeshLambertMaterial


                    ST_layersType = ["Conv", "Conv", "Pooling", "Conv", "Conv", "Pooling", "Conv", "Conv", "Conv", "Pooling", "Conv", "Conv", "Conv", "Pooling", "Conv", "Conv", "Conv", "Conv"
                      , "Conv", "Pooling", "Conv", "Conv", "Pooling", "Conv", "Conv", "Conv", "Pooling", "Conv", "Conv", "Conv", "Pooling", "Conv", "Conv", "Conv"
                      , "Conv_1x1", "Atrous", "Concatenated", "Attention", "Conv", "Conv", "Conv", "Pooling", "Neu","Neu","Neu"];
                    ST_layersSize = [14, 14, 12, 12, 12, 10, 10, 10, 10, 8, 8, 8, 8, 6, 6, 6, 6];

                    var ST_elementStyle = ST_2dCanvas.style;

                    ST_elementStyle.position = "relative";
                    ST_elementStyle.up = "600";
                    ST_DrawCanvas();
                    ST_ShowModelArchitecture();

                    var ST_CanvasRect = ST_Canvas.getBoundingClientRect();
                    var ST_deltaY = 0;

                    let ST_canvas1AbsolutePosition_y = window.pageYOffset + ST_CanvasRect.top - 290;
                    let ST_canvas1AbsolutePosition_X = window.pageXOffset + ST_CanvasRect.left + 500;

                     //calculate canvas2's offset
                    ST_offset = ST_canvas1AbsolutePosition_y + ST_deltaY;
                    ST_text2 = ST_offset.toString() + "px";
                    ST_elementStyle.top = ST_elementStyle.up = ST_text2;

                    ST_offset = ST_canvas1AbsolutePosition_X - 500;
                    ST_text2 = ST_offset.toString() + "px";
                    ST_elementStyle.right = ST_elementStyle.left = ST_text2;
                    ST_elementStyle.zIndex = "2";
                    ST_canvasGroupStyle.position = "relative";
                    ST_Canvas2ElementStyle.top = ST_Canvas2ElementStyle.up = "0px";
                    ST_Canvas2ElementStyle.right = ST_Canvas2ElementStyle.left = "0px";



                  }

                  function ST_DrawCanvas() {
                    var count = 0;

                    normal_high = new Image();
                    normal_high.src = "img/FeatureMaps/normal/40x.png";
                    normal_high.onload = on_normal_high_loaded;
                    function on_normal_high_loaded() {
                      ST_onImageLoaded();
                    }
                    normal_low = new Image();
                    normal_low.src = "img/FeatureMaps/normal/10x.png";
                    normal_low.onload = on_normal_low_loaded;
                    function on_normal_low_loaded() {
                      ST_onImageLoaded();
                    }

                    tumor_high = new Image();
                    tumor_high.src = "img/FeatureMaps/tumor/40x.png";
                    tumor_high.onload = on_tumor_high_loaded;
                    function on_tumor_high_loaded() {
                      ST_onImageLoaded();
                    }
                    tumor_low = new Image();
                    tumor_low.src = "img/FeatureMaps/tumor/10x.png";
                    tumor_low.onload = on_tumor_low_loaded;
                    function on_tumor_low_loaded() {
                      ST_onImageLoaded();
                    }

                    necrosis_high = new Image();
                    necrosis_high.src = "img/FeatureMaps/necrosis/40x.png";
                    necrosis_high.onload = on_necrosis_high_loaded;
                    function on_necrosis_high_loaded() {
                      ST_onImageLoaded();
                    }
                    necrosis_low = new Image();
                    necrosis_low.src = "img/FeatureMaps/necrosis/10x.png";
                    necrosis_low.onload = on_necrosis_low_loaded;
                    function on_necrosis_low_loaded() {
                      ST_onImageLoaded();
                    }


                  

                    img_model_bricks = new Image();
                    img_model_bricks.src = "img/model/network_model_bricks.png";
                    img_model_bricks.onload = on_model_bricks_loaded;
                    function on_model_bricks_loaded() {
                      ST_onImageLoaded();
                    }




                    img_model_text = new Image();
                    img_model_text.src = "img/model/network_model_text.png";
                    img_model_text.onload = on_model_text_loaded;
                    function on_model_text_loaded() {
                      ST_onImageLoaded();
                    }


                    img_model_arrow1 = new Image();
                    img_model_arrow1.src = "img/model/concate.png";
                    img_model_arrow1.onload = on_model_arrow1_loaded;
                    function on_model_arrow1_loaded() {
                      ST_onImageLoaded();
                    }


                    img_model_arrow2 = new Image();
                    img_model_arrow2.src = "img/model/Mblock.png";
                    img_model_arrow2.onload = on_model_arrow2_loaded;
                    function on_model_arrow2_loaded() {
                      ST_onImageLoaded();
                    }


                    img_model_aspp = new Image();
                    img_model_aspp.src = "img/model/network_model_aspp.png";
                    img_model_aspp.onload = on_model_aspp_loaded;
                    function on_model_aspp_loaded() {
                      ST_onImageLoaded();
                    }


                    img_model_dashed = new Image();
                    img_model_dashed.src = "img/model/dash1.png";
                    img_model_dashed.onload = on_model_dashed_loaded;
                    function on_model_dashed_loaded() {
                      ST_onImageLoaded();
                    }

                    img_white = new Image();
                    img_white.src = "img/featuremap/White.png";
                    img_white.onload = on_white_loaded;
                    function on_white_loaded() {
                      ST_onImageLoaded();
                    }
                    ST_img_model_singlearrow = new Image();
                    ST_img_model_singlearrow.src = "img/model/singlearrow.png";
                    ST_img_model_singlearrow.onload = ST_on_model_singlearrow;
                    function ST_on_model_singlearrow() {
                      ST_onImageLoaded();
                  }

                    ST_2dCtx.fillStyle = "black";
                    ST_2dCtx.font = 'normal  bold 16px "Arial"';
                    ST_2dCtx.font = 'normal  bold 14px "Arial"';


                    



                    var ST_imagePaths = [
                      "img/model/network_model_arrows.png",
                      "img/model/network_model_bricks.png",
                      "img/model/network_model_neural.png",
                      "img/model/network_model_text.png",
                      "img/model/network_model_arrow1.png",
                      "img/model/network_model_arrow2.png",
                      "img/model/network_model_aspp.png",
                      "img/featuremap/White.png",
                      "img/featuremap/ASPP_dashboard.png",
                    ]
                    


                    function ST_onImageLoaded() {
                      count += 1;
                      if (count >= ST_imagePaths.length) {
                        ST_draw2dImage();
                      }
                    }

                    //https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/drawImage
                    function ST_draw2dImage() {
                      ST_imageLoaded = true;
                      ST_2dCtx.drawImage(img_model_arrow1, 290, 140, 150, 310);
                      ST_2dCtx.drawImage(img_model_mblock, 470, 220, 210, 90);
                      ST_2dCtx.drawImage(img_model_dashed, 325, 372, 80, 150);
                      ST_2dCtx.drawImage(normal_high, 0, 100, 120, 120);
                      ST_2dCtx.drawImage(normal_low, 0, 400, 120, 120);
                      ST_2dCtx.drawImage(ST_img_model_singlearrow, 70, 405, 170, 100);
                      ST_2dCtx.drawImage(ST_img_model_singlearrow, 70, 105, 170, 100);
                    }
                  }

                  function ST_SceneAndLight() {
                    let ST_pointLight = new THREE.PointLight(0xffffff);
                    ST_pointLight.position.set(20, 100, 0);
                    ST_Scene.add(ST_pointLight);
                  }

                  function ST_SetCamera() {
                    ST_Camera.position.z = 50;
                    ST_Camera.position.x = 30;
                    ST_Camera.position.y = 5;
                    ST_Camera.lookAt(new THREE.Vector3(0, 0, 0));
                    ST_Camera.up.set(0, 0, 0);
                  }

                  function ST_ShowModelArchitecture() {
                    var ST_startPositionX = -43;
                    var ST_marginOfPositionX = 1;
                    var i;
                    for (i = 0; i < ST_layersSize.length; i++) {
                      let ST_tempgemoetry = new THREE.BoxGeometry(.95, ST_layersSize[i] * 1.5, ST_layersSize[i] * 1.5);
                      let ST_cube;

                      if (ST_layersType[i] == "Conv") {
                        ST_cube = new THREE.Mesh(ST_tempgemoetry, ST_ConvIdleMaterial);
                      }
                      else if (ST_layersType[i] == "Pooling") {
                        ST_cube = new THREE.Mesh(ST_tempgemoetry, ST_PollingIdleMaterial);
                      }
                      else {
                        ST_cube = new THREE.Mesh(ST_tempgemoetry, ST_ConvIdleMaterial);
                      }
                      ST_cube.position.x = ST_startPositionX + i * ST_marginOfPositionX;
                      ST_cube.rotation.y -= 0;
                      ST_cube.position.y += 20;
                      ST_cube.rotation.x += .17;
                      ST_cube.rotation.z -= .1;
                      ST_tempLayers.push(ST_cube);
                      ST_Scene.add(ST_cube);
                    }

                    for (i = 0; i < ST_layersSize.length; i++) {
                      let ST_tempgemoetry = new THREE.BoxGeometry(.95, ST_layersSize[i] * 1.5, ST_layersSize[i] * 1.5);
                      let ST_cube;

                      if (ST_layersType[i] == "Conv") {
                        ST_cube = new THREE.Mesh(ST_tempgemoetry, ST_ConvIdleMaterial);
                      }
                      else if (ST_layersType[i] == "Pooling") {
                        ST_cube = new THREE.Mesh(ST_tempgemoetry, ST_PollingIdleMaterial);
                      }
                      else {
                        ST_cube = new THREE.Mesh(ST_tempgemoetry, ST_ConvIdleMaterial);
                      }
                      ST_cube.position.x = ST_startPositionX + i * ST_marginOfPositionX;
                      ST_cube.rotation.y -= 0;
                      ST_cube.position.y -= 20;
                      ST_cube.rotation.x += .17;
                      ST_cube.rotation.z -= .1;
                      ST_tempLayers.push(ST_cube);
                      ST_Scene.add(ST_cube);
                    }
                    //1x1 Conv
                    let ST_Conv_1x1_Geometry = new THREE.BoxGeometry(6, 5, 5);
                    let ST_cube_1x1Conv = new THREE.Mesh(ST_Conv_1x1_Geometry, ST_ConvIdleMaterial);
                    ST_tempLayers.push(ST_cube_1x1Conv);
                    ST_Scene.add(ST_cube_1x1Conv);
                    ST_cube_1x1Conv.rotation.x += .17;
                    ST_cube_1x1Conv.rotation.z -= .1;
                    ST_cube_1x1Conv.position.x = ST_startPositionX + 21 * ST_marginOfPositionX + 2;
                    ST_cube_1x1Conv.position.y -= 17;
                    ST_cube_1x1Conv.position.z += 2;

                    //Atrous Feature Maps
                    let ST_Atrous_Geometry = new THREE.BoxGeometry(6, 5, 5);
                    let ST_cube_Atrous = new THREE.Mesh(ST_Atrous_Geometry, ST_Atrous_IdleMaterial);
                    ST_tempLayers.push(ST_cube_Atrous);
                    ST_Scene.add(ST_cube_Atrous);
                    ST_cube_Atrous.rotation.x += .17;
                    ST_cube_Atrous.rotation.z -= .1;
                    ST_cube_Atrous.position.x = ST_startPositionX + 21 * ST_marginOfPositionX + 2;
                    ST_cube_Atrous.position.y -= 23;
                    ST_cube_Atrous.position.z += 2;

                    //Concatenated Feature Maps
                    let ST_ConcatenatedFeatureMap_Geometry = new THREE.BoxGeometry(2, 8, 6);
                    let ST_cube_ConcatenatedFeatureMap = new THREE.Mesh(ST_ConcatenatedFeatureMap_Geometry, ST_ConcatenatedFeatureMap_IdleMaterial);
                    ST_tempLayers.push(ST_cube_ConcatenatedFeatureMap);
                    ST_Scene.add(ST_cube_ConcatenatedFeatureMap);
                    ST_cube_ConcatenatedFeatureMap.rotation.x += .17;
                    ST_cube_ConcatenatedFeatureMap.rotation.z -= .1;
                    ST_cube_ConcatenatedFeatureMap.position.x = ST_startPositionX + 21 * ST_marginOfPositionX + 2 + 13;
                    //ST_cube_ConcatenatedFeatureMap.position.y -= 23;
                    ST_cube_ConcatenatedFeatureMap.position.z -= 0.5;

                    let ST_AttentionFeatureMap_Geometry = new THREE.BoxGeometry(2, 8, 6);
                    let ST_cube_AttentionFeatureMap = new THREE.Mesh(ST_AttentionFeatureMap_Geometry, ST_AttentionFeatureMap_IdleMaterial);
                    ST_tempLayers.push(ST_cube_AttentionFeatureMap);
                    ST_Scene.add(ST_cube_AttentionFeatureMap);
                    ST_cube_AttentionFeatureMap.rotation.x += .17;
                    ST_cube_AttentionFeatureMap.rotation.z -= .1;
                    ST_cube_AttentionFeatureMap.position.x = ST_startPositionX + 21 * ST_marginOfPositionX + 2 + 15 + 20 + 3 +10+5;
                    //ST_cube_ConcatenatedFeatureMap.position.y -= 23;
                    ST_cube_AttentionFeatureMap.position.z += 2;

                    let ST_Conv14_Geometry = new THREE.BoxGeometry(.7, 8, 8);
                    let ST_cube_Conv14 = new THREE.Mesh(ST_Conv14_Geometry, ST_ConvIdleMaterial);
                    ST_tempLayers.push(ST_cube_Conv14);
                    ST_Scene.add(ST_cube_Conv14);
                    ST_cube_Conv14.rotation.x += .17;
                    ST_cube_Conv14.rotation.z -= .1;
                    ST_cube_Conv14.position.x = ST_startPositionX + 21 * ST_marginOfPositionX + 2 + 15 + 25 + 5 +8+5;

                    let ST_Conv15_Geometry = new THREE.BoxGeometry(.7, 8, 8);
                    let ST_cube_Conv15 = new THREE.Mesh(ST_Conv15_Geometry, ST_ConvIdleMaterial);
                    ST_tempLayers.push(ST_cube_Conv15);
                    ST_Scene.add(ST_cube_Conv15);
                    ST_cube_Conv15.rotation.x += .17;
                    ST_cube_Conv15.rotation.z -= .1;
                    ST_cube_Conv15.position.x = ST_startPositionX + 21 * ST_marginOfPositionX + 2 + 15 + 25 + 5 + 1.5 +8+5;

                    let ST_Conv16_Geometry = new THREE.BoxGeometry(.7, 8, 8);
                    let ST_cube_Conv16 = new THREE.Mesh(ST_Conv16_Geometry, ST_ConvIdleMaterial);
                    ST_tempLayers.push(ST_cube_Conv16);
                    ST_Scene.add(ST_cube_Conv16);
                    ST_cube_Conv16.rotation.x += .17;
                    ST_cube_Conv16.rotation.z -= .1;
                    ST_cube_Conv16.position.x = ST_startPositionX + 21 * ST_marginOfPositionX + 2 + 15 + 25 + 5 + 1.5 + 1.5 +8+5;

                    let ST_Polling5_Geometry = new THREE.BoxGeometry(.7, 8, 8);
                    let ST_cube_Polling5 = new THREE.Mesh(ST_Polling5_Geometry, ST_PollingIdleMaterial);
                    ST_tempLayers.push(ST_cube_Polling5);
                    ST_Scene.add(ST_cube_Polling5);
                    ST_cube_Polling5.rotation.x += .17;
                    ST_cube_Polling5.rotation.z -= .1;
                    ST_cube_Polling5.position.x = ST_startPositionX + 21 * ST_marginOfPositionX + 2 + 15 + 25 + 5 + 1.5 + 1.5 + 1.5+5 +8;
                    // ddddd
                    let ST_neuralnetwork_Geometry = new THREE.BoxGeometry(.7, 30, 1);
                    let ST_neuralnetwork = new THREE.Mesh(ST_neuralnetwork_Geometry, ST_neuralnetwork_IdleMaterial);
                    ST_tempLayers.push(ST_neuralnetwork);
                    ST_Scene.add(ST_neuralnetwork);
                    ST_neuralnetwork.rotation.x += .17;
                    ST_neuralnetwork.rotation.z -= .1;
                    ST_neuralnetwork.position.x = ST_startPositionX + 21 * ST_marginOfPositionX+ 2 + 15 + 25 + 5 + 1.5 + 1.5 + 1.5+5 +5 +8;

                    let ST_Geometry = new THREE.BoxGeometry(.7, 30, 1);
                    let ST = new THREE.Mesh(ST_Geometry, ST_neuralnetwork_IdleMaterial);
                    ST_tempLayers.push(ST);
                    ST_Scene.add(ST);
                    ST.rotation.x += .17;
                    ST.rotation.z -= .1;
                    ST.position.x = ST_startPositionX + 21 * ST_marginOfPositionX + 2 + 15 + 25 + 5 + 1.5 + 1.5 + 1.5+7 +8 +5;

                    let ST_output_Geometry = new THREE.BoxGeometry(.7, 5, 1);
                    let ST_output = new THREE.Mesh(ST_output_Geometry, ST_neuralnetwork_IdleMaterial);
                    ST_tempLayers.push(ST_output);
                    ST_Scene.add(ST_output);
                    ST_output.rotation.x += .17;
                    ST_output.rotation.z -= .1;
                    ST_output.position.x = ST_startPositionX + 21 * ST_marginOfPositionX + 2 + 15 + 25 + 5 + 1.5 + 1.5 + 1.5+9 +8 +5;

                    var ST_Canvas2ElementStyle = ST_2dCanvas.style;
                    ST_Canvas2ElementStyle.position = "absolute";
                    var ST_bodyRect = document.body.getBoundingClientRect();
                    var ST_elemRect = ST_Canvas.getBoundingClientRect();
                    ST_offset = ST_elemRect.top - ST_bodyRect.top - 337;
                    ST_text2 = ST_offset.toString() + "px";
                    ST_Canvas2ElementStyle.top = ST_Canvas2ElementStyle.up = ST_text2;
                    ST_offset = ST_elemRect.left - ST_bodyRect.left + 5;
                    ST_text2 = ST_offset.toString() + "px";
                    ST_Canvas2ElementStyle.right = ST_Canvas2ElementStyle.left = ST_text2;
                    ST_Canvas2ElementStyle.zIndex = "2"
                  }

                  if(ST_Renderer)
                    ST_Renderer.render(ST_Scene, ST_Camera);


                  // function showrow(index) { }  //This function called by another js code, so left the empty one here.

                  //https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/drawImage

                  function ST_showFeatureMap(ST_index) {
                    class_selectnum =Class_selector.value;
                    // console.log("classnum:",class_selectnum);
                    
                    if(!ST_imageLoaded)
                      return
                      var ST_highOrLowST_highOrLow = ST_index < 18? 'High':'Low';
                      var path = featureMapsFolder + selectors[class_selectnum] + '/' +ST_highOrLowST_highOrLow + '/';
                      if(ST_index <= 0 || ST_index>36){
                        ST_imgwhite();
                        return;
                      }
                      // Normal-----------------------
                      if(ST_index>=1 && ST_index <=3){
                        path += 'Pool1/';
                      }
                      else if(ST_index>=4 && ST_index <=6){
                        path += 'Pool2/';
                      }
                      else if(ST_index>=7 && ST_index <=10){
                        path += 'Pool3/';
                      }
                      else if(ST_index>=11 && ST_index <=14){
                        path += 'Pool4/';
                      }
                      else if(ST_index>=15 && ST_index <=17){
                        path += 'fe/';
                      }
                      else if(ST_index>=18 && ST_index <=20){
                        path += 'Pool1/';
                      }
                      else if(ST_index>=21 && ST_index <=23){
                        path += 'Pool2/';
                      }
                      else if(ST_index>=24 && ST_index <=27){
                        path += 'Pool3/';
                      }
                      else if(ST_index>=28 && ST_index <=31){
                        path += 'Pool4/';
                      }
                      else if(ST_index>=32 && ST_index <=36){
                        path += 'ASPP_block/';
                      }
                      ST_showconvfeatureup(featureMapsArray[pathToImgMap.get(path + '1.png')],featureMapsArray[pathToImgMap.get(path + '2.png')],featureMapsArray[pathToImgMap.get(path + '3.png')],featureMapsArray[pathToImgMap.get(path + '4.png')],featureMapsArray[pathToImgMap.get(path + '5.png')],featureMapsArray[pathToImgMap.get(path + '6.png')]);
                    
                   }

                  function ST_showconvfeatureup(img1,img2,img3,img4,img5,img6) {
                    if (class_selectnum == 1) {
                      ST_2dCtx.drawImage(img1, 365, 10, 100, 100);
                      ST_2dCtx.drawImage(img2, 470, 10, 100, 100);
                      ST_2dCtx.drawImage(img3, 575, 10, 100, 100);
                      ST_2dCtx.drawImage(img4, 680, 10, 100, 100);
                      ST_2dCtx.drawImage(img5, 785, 10, 100, 100);
                      ST_2dCtx.drawImage(img6, 890, 10, 100, 100); 
                    }
                    else if (class_selectnum == 2) {
                      ST_2dCtx.drawImage(img1, 365, 10, 100, 100);
                      ST_2dCtx.drawImage(img2, 470, 10, 100, 100);
                      ST_2dCtx.drawImage(img3, 575, 10, 100, 100);
                      ST_2dCtx.drawImage(img4, 680, 10, 100, 100);
                      ST_2dCtx.drawImage(img5, 785, 10, 100, 100);
                      ST_2dCtx.drawImage(img6, 890, 10, 100, 100); 
                    }
                    else if (class_selectnum == 3) {
                      ST_2dCtx.drawImage(img1, 365, 10, 100, 100);
                      ST_2dCtx.drawImage(img2, 470, 10, 100, 100);
                      ST_2dCtx.drawImage(img3, 575, 10, 100, 100);
                      ST_2dCtx.drawImage(img4, 680, 10, 100, 100);
                      ST_2dCtx.drawImage(img5, 785, 10, 100, 100);
                      ST_2dCtx.drawImage(img6, 890, 10, 100, 100); 
                    }
                  }
                  function ST_imgwhite(){
                    ST_2dCtx.drawImage(img_white, 365, 10, 100, 100);
                    ST_2dCtx.drawImage(img_white, 470, 10, 100, 100);
                    ST_2dCtx.drawImage(img_white, 575, 10, 100, 100);
                    ST_2dCtx.drawImage(img_white, 680, 10, 100, 100);
                    ST_2dCtx.drawImage(img_white, 785, 10, 100, 100);
                    ST_2dCtx.drawImage(img_white, 890, 10, 100, 100); 
                  }

                  const ST_pickPosition = { x: 0, y: 0 };
                  class ST_PickHelper {
                    constructor() {
                      this.ST_raycaster = new THREE.Raycaster();
                      this.ST_pickedObject = null;
                      this.ST_pickedObjectSavedColor = 0;
                    }
                    ST_pick(normalizedPosition, ST_scene, ST_camera) {
                      if (this.ST_pickedObject) {
                        if (ST_layersType[ST_tempLayers.indexOf(this.ST_pickedObject)] == "Conv") {
                          this.ST_pickedObject.material = ST_ConvIdleMaterial;
                        }
                        else if (ST_layersType[ST_tempLayers.indexOf(this.ST_pickedObject)] == "Pooling") {
                          this.ST_pickedObject.material = ST_PollingIdleMaterial;
                        }
                        else if (ST_layersType[ST_tempLayers.indexOf(this.ST_pickedObject)] == "Conv_1x1") {
                          this.ST_pickedObject.material = ST_ConvIdleMaterial;
                        }
                        else if (ST_layersType[ST_tempLayers.indexOf(this.ST_pickedObject)] == "Atrous") {
                          this.ST_pickedObject.material = ST_Atrous_IdleMaterial;
                        }
                        else if (ST_layersType[ST_tempLayers.indexOf(this.ST_pickedObject)] == "Concatenated") {
                          this.ST_pickedObject.material = ST_ConcatenatedFeatureMap_IdleMaterial;
                        }
                        else if (ST_layersType[ST_tempLayers.indexOf(this.ST_pickedObject)] == "Attention") {
              
                          this.ST_pickedObject.material = ST_AttentionFeatureMap_IdleMaterial;
                        }
                        else if (ST_layersType[ST_tempLayers.indexOf(this.ST_pickedObject)] == "Neu") {
                          this.ST_pickedObject.material = ST_neuralnetwork_IdleMaterial;
                        }
                        this.ST_pickedObject = undefined;
                        ST_highLightModel(-1);
                      }
                      this.ST_raycaster.setFromCamera(normalizedPosition, ST_camera);
                      const ST_intersectedObjects = this.ST_raycaster.intersectObjects(ST_scene.children);
                      if (ST_intersectedObjects.length) {
                        this.ST_pickedObject = ST_intersectedObjects[0].object;
                        this.ST_pickedObjectSavedColor = this.ST_pickedObject.material.emissive.getHex();
                        this.ST_pickedObject.material = ST_highlightMaterial;
                        var ST_indexOfTempLayers = ST_tempLayers.indexOf(this.ST_pickedObject);

                        ST_highlightModelNumber = ST_indexOfTempLayers;
                      }

                      ST_highlightModelNumber = ST_intersectedObjects.length == 0 ? -1 : ST_highlightModelNumber;
                      ST_highLightModel(ST_highlightModelNumber + 1);
                    }
                  }
                  function ST_resizeRendererToDisplaySize(ST_renderer) {
                    const canvas = ST_renderer.domElement;
                    const width = canvas.clientWidth;
                    const height = canvas.clientHeight;
                    const needResize = canvas.width !== width || canvas.height !== height;
                    if (needResize) {
                      ST_renderer.setSize(width, height, false);
                    }
                    return needResize;
                  }
                  function ST_getCanvasRelativePosition(event) {
                    const canvas = ST_Renderer.domElement;
                    const rect = canvas.getBoundingClientRect();
                    return {
                      x: event.clientX - rect.left,
                      y: event.clientY - rect.top,
                    };
                  }

                  function ST_setPickPosition(event) {
                    const canvas = ST_Renderer.domElement;
                    const pos = ST_getCanvasRelativePosition(event);
                    ST_pickPosition.x = (pos.x / canvas.clientWidth) * 2 - 1;
                    ST_pickPosition.y = (pos.y / canvas.clientHeight) * -2 + 1;  // note we flip Y
                  }

                  function ST_clearPickPosition() {
                    ST_highlightModelNumber = -1;
                    ST_pickPosition.x = -100000;
                    ST_pickPosition.y = -100000;
                  }

                  function ST_checkClickPosition() {
                    // ST_showFeatureMap(ST_highlightModelNumber + 1);

                  }

                  function ST_test1() {
                    ST_showFeatureMap(ST_highlightModelNumber + 1);
                  }

                  window.addEventListener('mousemove', ST_test1)
                  window.addEventListener('mousemove', ST_setPickPosition);
                  window.addEventListener('mouseout', ST_clearPickPosition);
                  window.addEventListener('mouseleave', ST_clearPickPosition);
                  window.addEventListener('touchstart', (event) => {
                    event.preventDefault();
                    ST_setPickPosition(event.touches[0]);
                  }, { passive: false });

                  window.addEventListener('touchmove', (event) => {
                    ST_setPickPosition(event.touches[0]);
                  });

                  window.addEventListener('touchend', ST_clearPickPosition);
                  const ST_pickHelper = new ST_PickHelper();


                  function ST_render() {
                    if(!ST_Renderer)
                      return;
                    if (ST_resizeRendererToDisplaySize(ST_Renderer)) {
                      const canvas = ST_Renderer.domElement;
                      ST_Camera.aspect = canvas.clientWidth / canvas.clientHeight;
                      ST_Camera.updateProjectionMatrix();
                    }
                    ST_pickHelper.ST_pick(ST_pickPosition, ST_Scene, ST_Camera);
                    ST_Renderer.render(ST_Scene, ST_Camera);
                    requestAnimationFrame(ST_render);
                    if (!ST_hasPressedModel) {
                      ST_canvasGroupStyle.right = ST_canvasGroupStyle.left = "0px";
                      return;
                    }
                    var bodyRect = document.body.getBoundingClientRect();
                    var elemRect = table ? table.getBoundingClientRect() : 0;
                    var offset = elemRect.top - bodyRect.top - 30;
                  }
                  var ST_currentHighlightIndex = 5;
                  function ST_highLightModel(ST_modelNumber) {
                    if (ST_modelNumber == -1 || ST_modelNumber <= -1 || ST_modelNumber >= ST_tempLayers.length + 1) {
                      var i = 0;
                      for (i = 0; i < ST_tempLayers.length + 1; i++) {
                        if (ST_layersType[i] == "Conv") {
                          ST_tempLayers[i].material = ST_ConvIdleMaterial;
                        }
                        else if (ST_layersType[i] == "Pooling") {
                          ST_tempLayers[i].material = ST_PollingIdleMaterial;
                        }
                        else if (ST_layersType[i] == "Conv_1x1") {
                          ST_tempLayers[i].material = ST_ConvIdleMaterial;
                        }
                        else if (ST_layersType[i] == "Atrous") {
                          ST_tempLayers[i].material = ST_Atrous_IdleMaterial;
                        }
                        else if (ST_layersType[i] == "Concatenated") {
                          ST_tempLayers[i].material = ST_ConcatenatedFeatureMap_IdleMaterial;
                        }
                        else if (ST_layersType[i] == "Attention") {
                          ST_tempLayers[i].material = ST_AttentionFeatureMap_IdleMaterial;
                        }
                      }
                      return;
                    }
                    // // showrow(ST_modelNumber - 1);
                    if (ST_modelNumber == 0)
                      return;
                    if (ST_modelNumber <= 3 && ST_modelNumber >= 1 ) {
                      // console.log("ST_modelNumber:", ST_modelNumber);
                      ST_tempLayers[0].material = ST_highlightMaterial;
                      ST_tempLayers[1].material = ST_highlightMaterial;
                      ST_tempLayers[2].material = ST_highlightMaterial;
                    }
                    else if (ST_modelNumber <= 6 && ST_modelNumber >= 4 ) {
                      // console.log("ST_modelNumber:", ST_modelNumber);
                      ST_tempLayers[3].material = ST_highlightMaterial;
                      ST_tempLayers[4].material = ST_highlightMaterial;
                      ST_tempLayers[5].material = ST_highlightMaterial;
                    }
                    else if (ST_modelNumber <= 10 && ST_modelNumber >= 7 ) {
                      // console.log("ST_modelNumber:", ST_modelNumber);
                      ST_tempLayers[6].material = ST_highlightMaterial;
                      ST_tempLayers[7].material = ST_highlightMaterial;
                      ST_tempLayers[8].material = ST_highlightMaterial;
                      ST_tempLayers[9].material = ST_highlightMaterial;
                    }
                    else if (ST_modelNumber <= 14 && ST_modelNumber >= 11 ) {
                      // console.log("ST_modelNumber:", ST_modelNumber);
                      ST_tempLayers[10].material = ST_highlightMaterial;
                      ST_tempLayers[11].material = ST_highlightMaterial;
                      ST_tempLayers[12].material = ST_highlightMaterial;
                      ST_tempLayers[13].material = ST_highlightMaterial;
                    }
                    else if (ST_modelNumber <= 17 && ST_modelNumber >= 15 ) {
                      // console.log("ST_modelNumber:", ST_modelNumber);
                      ST_tempLayers[15].material = ST_highlightMaterial;
                      ST_tempLayers[16].material = ST_highlightMaterial;
                      ST_tempLayers[14].material = ST_highlightMaterial;
                      // ST_tempLayers[15].material = ST_highlightMaterial;
                    }

                    // down--------------------------------------------------------------------
                    if (ST_modelNumber <= 20 && ST_modelNumber >= 18 ) {
                      // console.log("ST_modelNumber:", ST_modelNumber);
                      ST_tempLayers[17].material = ST_highlightMaterial;
                      ST_tempLayers[18].material = ST_highlightMaterial;
                      ST_tempLayers[19].material = ST_highlightMaterial;
                    }
                    else if (ST_modelNumber <= 23 && ST_modelNumber >= 21 ) {
                      // console.log("ST_modelNumber:", ST_modelNumber);
                      ST_tempLayers[20].material = ST_highlightMaterial;
                      ST_tempLayers[21].material = ST_highlightMaterial;
                      ST_tempLayers[22].material = ST_highlightMaterial;
                    }
                    else if (ST_modelNumber <= 27 && ST_modelNumber >= 24 ) {
                      // console.log("ST_modelNumber:", ST_modelNumber);
                      ST_tempLayers[23].material = ST_highlightMaterial;
                      ST_tempLayers[24].material = ST_highlightMaterial;
                      ST_tempLayers[25].material = ST_highlightMaterial;
                      ST_tempLayers[26].material = ST_highlightMaterial;
                    }
                    else if (ST_modelNumber <= 31 && ST_modelNumber >= 28 ) {
                      // console.log("ST_modelNumber:", ST_modelNumber);
                      ST_tempLayers[27].material = ST_highlightMaterial;
                      ST_tempLayers[28].material = ST_highlightMaterial;
                      ST_tempLayers[29].material = ST_highlightMaterial;
                      ST_tempLayers[30].material = ST_highlightMaterial;
                    }
                    else if (ST_modelNumber <= 36 && ST_modelNumber >= 32 ) {
                      // console.log("ST_modelNumber:", ST_modelNumber);
                      ST_tempLayers[31].material = ST_highlightMaterial;
                      ST_tempLayers[32].material = ST_highlightMaterial;
                      ST_tempLayers[33].material = ST_highlightMaterial;
                      ST_tempLayers[34].material = ST_highlightMaterial;
                      ST_tempLayers[35].material = ST_highlightMaterial;
                    }
                    else if (ST_modelNumber == 37  ) {
                      ST_tempLayers[36].material = ST_ConcatenatedFeatureMap_IdleMaterial;
                    }
                    else if (ST_modelNumber == 38  ) {
                      ST_tempLayers[37].material = ST_AttentionFeatureMap_IdleMaterial;
                    }
                    else if (ST_modelNumber >= 39 && ST_modelNumber<=41  ) {
                      ST_tempLayers[38].material = ST_ConvIdleMaterial;
                      ST_tempLayers[39].material = ST_ConvIdleMaterial;
                      ST_tempLayers[40].material = ST_ConvIdleMaterial;
                    }
                    else if (ST_modelNumber == 42  ) {
                      ST_tempLayers[41].material = ST_PollingIdleMaterial;
                    }
                    else if (ST_modelNumber >= 43 && ST_modelNumber<=45  ) {
                      ST_tempLayers[42].material = ST_neuralnetwork_IdleMaterial;
                      ST_tempLayers[43].material = ST_neuralnetwork_IdleMaterial;
                      ST_tempLayers[44].material = ST_neuralnetwork_IdleMaterial;
                    }
                  }

                  requestAnimationFrame(ST_render);

                </script>
                </p>
                <p>&nbsp;</p>
                <br>
              </div>
              <div style="bottom:700px;position: relative; left : 0px; top: 0px;">

                <script type="text/javascript" src="table.js"></script>
              </div>
            </div>
            <!-- <div class="caption"><b>Figure 1:</b><br> Tumor, necrosis, and normal regions of WSIs.</div> -->
            <script type="module" src=""></script>
          </div>
        </div>

        <h3>2.1.1 Atrous Spatial Pyramid Pooling (ASPP)</h3>
        <p>
          Broadly speaking, the image patches obtained at a higher magnification show the local features of the 
          input image, while those obtained at a lower magnification provide the global features of the input image. 
          For the high-magnification images, the local features can be extracted by the convolutional filter. 
          For the low-magnification images, an ASPP block [<a href="#ref_16">16</a>] [<a href="#ref_17">17</a>] is 
          introduced after the low-magnification feature extractor (Fig. 1) to extend the field-of-view of the global features.
        </p>
        <p>
          The ASPP block comprises a 1x1 convolutional layer and an atrous convolutional layer. Compared to general
          convolutions, atrous convolutions expand the field-of-view without increasing the kernel size or number of
          parameters. The difference between the two convolutions is shown in Fig. 3. Try increasing the kernel
          size and dilation rate in the figure. As you increase the kernel size or the dilation
          rate, you will see that the field-of-view of the atrous convolution increases. Meanwhile, the left-hand
          figure demonstrates the general convolution with the same field-of-view. By comparing the number of the
          blue boxes, which represents the parameters of the convolution kernels, you can see how atrous convolution
          expands the field-of-view without increasing the number of parameters.
        </p>

        <!-- Figure 3 dilation rate -->
        <div class="framed">
          <div class="inside">
            <div class="eyebrow">
              Try increasing the kernel size and dilation rate in the figure and see how atrous 
              convolution expands the field-of-view without increasing the number of parameters.
            </div>
            <div style="text-align: center;">
              <label style="margin-right:100px;font-weight: bold;">General convolution</label>
              <label style="margin-left: 100px;font-weight: bold;">Atrous convolution</label>
            </div>
            <br>
            <canvas id="ASPPLearningCanvas" height="1000" width="730"
              style="width: 100%; width: max-content; display: block; text-align: center;margin:auto auto;"></canvas>
            <div id="board-letsplay" style="width: 600px; margin: auto auto 10px;">
              <div class="l-body" style="width: 100%;margin: auto auto; width: max-content; display: block">
                <br>
                <div style="text-align: center;">
                  <label style="text-align: center;">Kernel size:</label>
                  <label id = "ASPP_KernelSize_General"></label>
                  <label style="text-align: center;margin-left: 210px;"></label>Kernel size:</label>
                  <label id = "ASPP_KernelSize_Atrous"></label>
                </div>
                <br>
                <div style="text-align: center;">
                  <label style="text-align: center;">Field-of-view:</label>
                  <label id = "ASPP_FOV_General"></label>
                  <label style="text-align: center;margin-left: 200px;"></label>Field-of-view:</label>
                  <label id = "ASPP_FOV_Atrous"></label>
                </div>
                <br>
                <div style="text-align: center;">
                  <label style="text-align: center;text-align: center;">Number of parameters:</label>
                  <label id = "ASPP_NOP_General"></label>
                  <label style="text-align: center;text-align: center;margin-left: 150px;"></label>Number of parameters:</label>
                  <label id = "ASPP_NOP_Atrous"></label>
                </div>
                <br>
                <br>
                <br>
                <label style="margin-left: 138px;">ASPP Dilation Rate:</label>
                <button id="ASPPLearingRateDecrement" onclick="OnDecrementBtnClicked()">-</button>
                <input type="number" min="1" max="10" step="1" id="ASPP_DilationRateInput" style="text-align: center;"
                  onChange="OnASPPInput(this.value)">
                <button id="ASPPLearingRateIncrement" onclick="OnIncrementBtnClicked()">+</button>
                <br>

                <label style="margin-left: 150px;">ASPP Kernel Size:</label>
                <button id="ASPPKernelSizeDecrement" onclick="OnKernelSizeDecrementBtnClicked()">-</button>
                <input type="number" min="1" max="10" step="1" id="ASPP_KernelSizeInput" style="text-align: center;"
                  onChange="OnASPPKernelSizeInput(this.value)">
                <button id="ASPPKernelSizeIncrement" onclick="OnKernelSizeIncrementBtnClicked()">+</button>

                
              </div>

              <script>
                //<Initial Condition Setting:---------------------------------->
                var gridLineWidth = 1;                                    
                var widthOfGrid = 18; //10                                
                var numbersOfGridColumnAndRow = 19;//19                  
                var patchColor = '#00c0ff';                            
                var lineWidth_fieldOfView = 2;


                var initialDilationRate = 3;
                var minDilationRate = 2;
                var maxDilationRate = 5;//Math.floor(numbersOfGridColumnAndRow / 2);
                

                var slidingRate = 2; //times per second  i.e. 1s/slidingRate

                var center_x = initialDilationRate; 
                var center_y = initialDilationRate; 

                //var center_general_x = 



                //<Temporary variables:---------------------------------------->
                var currentDilationRate;

                var isSliding = false;                                    
                var isSlidingWindowReseted = true;                        //flag
                var slidingIntervalId;                                   
                var loadingIntervalId;

                var minRowAndColumnNumber = 11;                           
                var maxRowAndColumnNumber = 27;                          

                var minSlideSpeed = .5;                                  
                var maxSlideSpeed = 10;                                 

                var minKernelSize = 2;
                var maxKernelSize = 4;
                var initialKernelSize = 3;
                // var currentKernelSize;
                var currentKernelSize;


                var gridRelativePosition_atrous_x = 0;                         
                var gridRelativePosition_atrous_y = 10;                         

                var gridRelativePosition_general_x = 0;
                var gridRelativePosition_general_y = 10;

                var totalGridWidth;                                      
                var loading_deg = 0;                                     
                var curSelectedImg;                                      


                //<HTML Objects:----------------------------------------------->
                var Input_ASPP_DilationRate = document.getElementById("ASPP_DilationRateInput");
                var ASPP_Canvas = document.getElementById("ASPPLearningCanvas");
                var ASPP_Ctx = ASPP_Canvas.getContext('2d');
                var ASPP_IMGSelector = document.getElementById('ASPP_ImageList');
                var ASPP_Image;                                           //Dilation grid

                var ASPP_LoadingGIF;

                var Input_ASPP_KernelSize = document.getElementById("ASPP_KernelSizeInput");

                var Label_ASPP_KernelSize_Atrous = document.getElementById("ASPP_KernelSize_Atrous");
                var Label_ASPP_KernelSize_General = document.getElementById("ASPP_KernelSize_General");
                var Label_ASPP_FOV_Atrous = document.getElementById("ASPP_FOV_Atrous");
                var Label_ASPP_FOV_General = document.getElementById("ASPP_FOV_General");
                var Label_ASPP_NOP_Atrous = document.getElementById("ASPP_NOP_Atrous");
                var Label_ASPP_NOP_General = document.getElementById("ASPP_NOP_General");

                var canvasWidth = ASPP_Canvas.width;                    
                var canvasHeight = 700;                                   

                //<Initialization---------------------------------------------->

                Initialization_Load_ASPP_BgImage();                    
                //Initialization function
                function ASPPInitialization()                             
                {
                  currentDilationRate = initialDilationRate;
                  // center_x = Math.floor(numbersOfGridColumnAndRow / 2);
                  // center_y = Math.floor(numbersOfGridColumnAndRow / 2);

                  currentKernelSize = initialKernelSize;
                  Input_ASPP_KernelSize.value = initialKernelSize;
                  Input_ASPP_DilationRate.value = initialDilationRate - 1;
                  if (slidingIntervalId)
                    clearInterval(slidingIntervalId);
                  isSlidingWindowReseted = true;
                  isSliding = false;
                  AdjustGrid();
                  RanderCanvas();
                  center_x = currentDilationRate;
                  center_y = currentDilationRate;
                  slidingIntervalId = setInterval(OnSlidingWindowsUpdate, 1000 / slidingRate, 1000 / slidingRate);

                  setLabelByDiationRateAndKernelSize();
                }

                function changeASPPImg() {
                  var x = document.getElementById("ASPP_ImageList").value;
                  ASPP_Image = new Image(60, 45);
                  ASPP_Image.onload = onASPPImageLoaded;
                  ASPP_Image.src = "img/ASPP_result_no_padding/" + x + ".png";
                  curSelectedImg = x;
                  function onASPPImageLoaded() {
                    ASPPInitialization();
                  }
                }

                function setLabelByDiationRateAndKernelSize(){
                  var FOV = currentKernelSize + (currentKernelSize - 1) * (currentDilationRate - 1);
                  Label_ASPP_KernelSize_Atrous.innerHTML = currentKernelSize + " x " + currentKernelSize;
                  Label_ASPP_KernelSize_General.innerHTML = FOV + " x " + FOV;

                  Label_ASPP_FOV_Atrous.innerHTML = FOV + " x " + FOV;
                  Label_ASPP_FOV_General.innerHTML = FOV + " x " + FOV;
                  Label_ASPP_NOP_Atrous.innerHTML =  currentKernelSize * currentKernelSize;
                  Label_ASPP_NOP_General.innerHTML =  FOV * FOV;
                }

                function Initialization_Load_ASPP_BgImage() {
                  ASPP_Image = new Image(60, 45);
                  ASPP_Image.onload = onASPPImageLoaded;
                  ASPP_Image.src = "img/white.png";
                  curSelectedImg = "2p5x";
                  function onASPPImageLoaded() {
                    ASPPInitialization();
                  }

                  ASPP_LoadingGIF = new Image(254, 254);
                  // ASPP_LoadingGIF.src = "img/loadingimage.png";
                }

                function RanderCanvas()//Background image -> grid -> kernal
                {
                  ClearCanvas();
                  DrawASPPGrid();
                  DrawASPPKernal();
                  DrawFieldOfView();
                  setLabelByDiationRateAndKernelSize();
                }

                function ClearCanvas(){
                  ASPP_Ctx.clearRect(0, 0, ASPP_Canvas.width, ASPP_Canvas.height);
                }

                
                function DrawASPPGrid() {
                  for (let i = 0; i < numbersOfGridColumnAndRow + 1; i++) {
                    DrawLine(gridRelativePosition_atrous_x, gridRelativePosition_atrous_y + i * widthOfGrid, gridRelativePosition_atrous_x + numbersOfGridColumnAndRow * widthOfGrid, gridRelativePosition_atrous_y + i * widthOfGrid, gridLineWidth, "black");
                    DrawLine(gridRelativePosition_atrous_x + i * widthOfGrid, gridRelativePosition_atrous_y, gridRelativePosition_atrous_x + i * widthOfGrid, gridRelativePosition_atrous_y + numbersOfGridColumnAndRow * widthOfGrid, gridLineWidth, "black");
                  }

                  for (let i = 0; i < numbersOfGridColumnAndRow + 1; i++) {
                    DrawLine(gridRelativePosition_general_x, gridRelativePosition_general_y + i * widthOfGrid, gridRelativePosition_general_x + numbersOfGridColumnAndRow * widthOfGrid, gridRelativePosition_general_y + i * widthOfGrid, gridLineWidth, "black");
                    DrawLine(gridRelativePosition_general_x + i * widthOfGrid, gridRelativePosition_general_y, gridRelativePosition_general_x + i * widthOfGrid, gridRelativePosition_general_y + numbersOfGridColumnAndRow * widthOfGrid, gridLineWidth, "black");
                  }
                }

                // currentDilationRate Kernal  
                function DrawASPPKernal() {
                  var centerPoint_atrous_x = gridRelativePosition_atrous_x + center_x * widthOfGrid;
                  var centerPoint_atrous_y = gridRelativePosition_atrous_y + center_y * widthOfGrid;
                  ASPP_Ctx.fillStyle = patchColor;
                  for (let i = -1; i < currentKernelSize - 1; i++) {
                    for (let j = -1; j < currentKernelSize - 1; j++) {
                      if(centerPoint_atrous_y + j * widthOfGrid * currentDilationRate + 1 < totalGridWidth)
                        ASPP_Ctx.fillRect(centerPoint_atrous_x + i * widthOfGrid * currentDilationRate + 1, centerPoint_atrous_y + j * widthOfGrid * currentDilationRate + 1, widthOfGrid - 2, widthOfGrid - 2);
                    }
                  }

                  var centerPoint_general_x = gridRelativePosition_general_x + center_x * widthOfGrid;
                  var centerPoint_general_y = gridRelativePosition_general_y + center_y * widthOfGrid;

                  for (let i = (-1) * currentDilationRate; i < currentDilationRate * (currentKernelSize - 2) + 1; i++) {
                    for (let j = (-1) * currentDilationRate; j < currentDilationRate * (currentKernelSize - 2) + 1; j++) {
                      ASPP_Ctx.fillRect(centerPoint_general_x + i * widthOfGrid + 1, centerPoint_general_y + j * widthOfGrid + 1, widthOfGrid - 2, widthOfGrid - 2);
                    }
                  }
                }

                function DrawFieldOfView() {

                  var centerPoint_atrous_x = gridRelativePosition_atrous_x + center_x * widthOfGrid;
                  var centerPoint_atrous_y = gridRelativePosition_atrous_y + center_y * widthOfGrid;


                  var x_upLeft = centerPoint_atrous_x + (-1) * widthOfGrid * currentDilationRate;
                  var y_upLeft = centerPoint_atrous_y + (-1) * widthOfGrid * currentDilationRate;
                  var x_downRight = centerPoint_atrous_x + widthOfGrid * (currentDilationRate * (currentKernelSize - 2) + 1);
                  var y_downRight = centerPoint_atrous_y + widthOfGrid * (currentDilationRate * (currentKernelSize - 2) + 1);

                  DrawLine(x_upLeft, y_upLeft, x_downRight, y_upLeft, lineWidth_fieldOfView, "red");
                  DrawLine(x_upLeft, y_upLeft, x_upLeft, y_downRight, lineWidth_fieldOfView, "red");
                  DrawLine(x_downRight, y_upLeft, x_downRight, y_downRight, lineWidth_fieldOfView, "red");
                  DrawLine(x_upLeft, y_downRight, x_downRight, y_downRight, lineWidth_fieldOfView, "red");

                  centerPoint_atrous_x = gridRelativePosition_general_x + center_x * widthOfGrid;
                  centerPoint_atrous_y = gridRelativePosition_general_y + center_y * widthOfGrid;


                  x_upLeft = centerPoint_atrous_x + (-1) * widthOfGrid * currentDilationRate;
                  y_upLeft = centerPoint_atrous_y + (-1) * widthOfGrid * currentDilationRate;
                  x_downRight = centerPoint_atrous_x + widthOfGrid * (currentDilationRate * (currentKernelSize - 2) + 1);
                  y_downRight = centerPoint_atrous_y + widthOfGrid * (currentDilationRate * (currentKernelSize - 2) + 1);

                  DrawLine(x_upLeft, y_upLeft, x_downRight, y_upLeft, lineWidth_fieldOfView, "red");
                  DrawLine(x_upLeft, y_upLeft, x_upLeft, y_downRight, lineWidth_fieldOfView, "red");
                  DrawLine(x_downRight, y_upLeft, x_downRight, y_downRight, lineWidth_fieldOfView, "red");
                  DrawLine(x_upLeft, y_downRight, x_downRight, y_downRight, lineWidth_fieldOfView, "red");

                }

                //draw grid
                function DrawLine(x_begin, y_begin, x_end, y_end, lineWidth, color) {
                  ASPP_Ctx.lineWidth = lineWidth;
                  ASPP_Ctx.beginPath();
                  ASPP_Ctx.moveTo(x_begin, y_begin);
                  ASPP_Ctx.lineTo(x_end, y_end);
                  ASPP_Ctx.strokeStyle = color;
                  ASPP_Ctx.stroke();
                  ASPP_Ctx.closePath();
                }

                function OnASPPGridReset() {
                  maxDilationRate = Math.floor(numbersOfGridColumnAndRow / 2);
                  OnASPPSlidingReset();
                  currentDilationRate = initialDilationRate;
                  RanderCanvas();
                }

                //Reset sliding window 
                function OnASPPSlidingReset() {
                  isSliding = false;
                  clearInterval(slidingIntervalId);
                  clearInterval(loadingIntervalId);
                  isSlidingWindowReseted = true;

                  center_x = Math.floor(numbersOfGridColumnAndRow / 2);
                  center_y = Math.floor(numbersOfGridColumnAndRow / 2);
                }

                function OnDecrementBtnClicked() {
                  if (currentDilationRate - 1 < minDilationRate) {
                    currentDilationRate = minDilationRate;
                  }
                  else {
                    currentDilationRate -= 1;
                  }
                  Input_ASPP_DilationRate.value = currentDilationRate - 1;
                  RanderCanvas();
                }

                function OnIncrementBtnClicked() {

                  if ( currentDilationRate + 1 > maxDilationRate || (currentDilationRate)*(currentKernelSize - 1) >  numbersOfGridColumnAndRow - currentKernelSize) {
                    return;
                  }
                  else {
                    currentDilationRate += 1;
                  }
                  if(center_y < currentDilationRate){
                    center_y = currentDilationRate;
                  }
                  if(center_x < currentDilationRate){
                    center_x = currentDilationRate;
                  }
                  Input_ASPP_DilationRate.value = currentDilationRate - 1;
                  RanderCanvas();
                }

                function OnKernelSizeDecrementBtnClicked() {
                  if (currentKernelSize - 1 < minKernelSize) {
                    currentKernelSize = minKernelSize;
                  }
                  else {
                    currentKernelSize -= 1;
                  }
                  Input_ASPP_KernelSize.value = currentKernelSize;
                  RanderCanvas();
                }

                function OnKernelSizeIncrementBtnClicked(){
                  if( currentKernelSize + 1 > maxKernelSize || (currentDilationRate - 1) * currentKernelSize + currentKernelSize + 1 > numbersOfGridColumnAndRow){
                    return;
                  }
                  else {
                    currentKernelSize += 1;
                  }


                  var centerPoint_atrous_y = gridRelativePosition_atrous_y + (center_y +1) * widthOfGrid ;

                  if(center_y >= numbersOfGridColumnAndRow - currentDilationRate * (currentKernelSize - 2) - 1){
                    center_y = numbersOfGridColumnAndRow + 1 - (currentKernelSize + (currentKernelSize - 1) * (currentDilationRate - 1)) + currentDilationRate - 1;
                  }

                  var centerPoint_atrous_x = gridRelativePosition_atrous_x + center_x * widthOfGrid;
                  if(centerPoint_atrous_x + (currentKernelSize - 2) * widthOfGrid * (currentDilationRate - 1) + 1 >= gridRelativePosition_atrous_x + totalGridWidth){
                    center_x = numbersOfGridColumnAndRow + 1 - (currentKernelSize + (currentKernelSize - 1) * (currentDilationRate - 1)) + currentDilationRate - 1;
                  }

                  Input_ASPP_KernelSize.value = currentKernelSize;
                  RanderCanvas();
                }

                function OnASPPKernelSizeInput(kernelSize) {
                  kernelSize = parseInt(kernelSize, 10);
                  if (kernelSize > maxKernelSize || kernelSize < minKernelSize) {
                    Input_ASPP_KernelSize.value = currentKernelSize;
                    return;
                  }
                  currentKernelSize = kernelSize;
                  RanderCanvas();
                }


                function OnASPPInput(learningRate) {

                  learningRate = parseInt(learningRate, 10);

                  if (learningRate > maxDilationRate || learningRate < minDilationRate) {
                    Input_ASPP_DilationRate.value = currentDilationRate - 1;
                    return;
                  }
                  currentDilationRate = learningRate + 1;
                  RanderCanvas();
                }

                function OnRowAndColumnNumberDecrementBtnClicked() {
                  if (numbersOfGridColumnAndRow - 1 < minRowAndColumnNumber) return;

                  ClearASPPCanvas();
                  numbersOfGridColumnAndRow -= 1;
                  AdjustGrid();
                  OnASPPGridReset();

                }

                function OnRowAndColumnNumberIncrementBtnClicked() {
                  if (numbersOfGridColumnAndRow + 1 > maxRowAndColumnNumber) return;

                  numbersOfGridColumnAndRow += 1;

                  AdjustGrid();

                  OnASPPGridReset();
                }

                function AdjustGrid() {

                  totalGridWidth = 0;
                  for (let i = 0; i < numbersOfGridColumnAndRow; i++) {
                    totalGridWidth += widthOfGrid;
                  }
                  gridRelativePosition_atrous_x = Math.floor((1 / 2 * canvasWidth - totalGridWidth) / 2) + 1 / 2 * canvasWidth;
                  gridRelativePosition_general_x = Math.floor((1 / 2 * canvasWidth  - totalGridWidth) / 2) ;
                  //gridRelativePosition_general_x
                  ASPP_Canvas.height = 2 * gridRelativePosition_atrous_y + totalGridWidth;
                }

                function OnSlideSpeedDecrementBtnClicked() {
                  if (slidingRate - 0.5 < minSlideSpeed) return;

                  slidingRate -= 0.5;

                  OnASPPGridReset();


                }

                function OnSlidingSpeedIncrementBtnClicked() {
                  if (slidingRate + 0.5 > maxSlideSpeed) return;

                  slidingRate += 0.5;

                  OnASPPGridReset();
                }


                function OnStartTrainingBtnClicked() {
                  if (isSliding) {
                    clearInterval(slidingIntervalId);
                    clearInterval(loadingIntervalId);
                    isSlidingWindowReseted = false;
                  }
                  else {
                    if (isSlidingWindowReseted) {
                      //kernal (currentDilationRate, currentDilationRate); //sidling 
                      center_x = currentDilationRate;
                      center_y = currentDilationRate;
                    }
                    RanderCanvas();
                    slidingIntervalId = setInterval(OnSlidingWindowsUpdate, 1000 / slidingRate, 1000 / slidingRate);
                  }
                  isSliding = !isSliding;
                }

                function OnSlidingWindowsUpdate() {
                  flag_xMeetBound = false;
                  flag_yMeetBound = false;

                  flag_xMeetBound = center_x >= numbersOfGridColumnAndRow - currentDilationRate * (currentKernelSize - 2) - 1;
                  flag_yMeetBound = center_y >= numbersOfGridColumnAndRow - currentDilationRate * (currentKernelSize - 2) - 1;

                  center_x = flag_xMeetBound ? currentDilationRate : center_x + 1;
                  center_y = flag_xMeetBound ? center_y + 1 : center_y;
                  if (flag_xMeetBound && flag_yMeetBound) {
                    center_x = currentDilationRate;
                    center_y = currentDilationRate;
                  }
                  RanderCanvas();
                }

                function ClearASPPCanvas() {
                  ASPP_Ctx.clearRect(0, 0, ASPP_Canvas.width, ASPP_Canvas.height);
                }
              </script>
            </div>
            <div class="caption"><b>Figure 3. </b><br>Differences between general convolution and atrous convolution.</div>

            <script type="module" src=""></script>
          </div>
        </div>

        <h3>2.2 Feature Integration and Magnification Attention Module (FIMAM)</h3>
        <p>
          As described in the Introduction, MMA-CNN incorporates an attention module to adapt the weights of 
          each feature map. Nevertheless, how exactly does the model go about evaluating the importance of each map is not demonstrated. 
          Let us have a closer look at the feature integration and magnification attention module (FIMAM) within MMA-CNN.
        </p>
        <p>
          The module starts by concatenating the feature maps obtained at two different magnifications (one is low and 
          the other is high), as shown in the yellow block in Fig. 1. A magnification-attention block is then applied to the 
          concatenated feature maps to extract attention feature maps containing the most important features of the two 
          views (see the purple block in Fig. 1). Finally, these attention maps are input into the classification module 
          (see Section 2.3) to classify the input image patches. 
        </p>
        <p class="inline-math">
          The magnification-attention block is based on the squeeze-and-excitation concept described in 
          [<a href="#ref_18">18</a>]. Briefly, the concatenated feature maps are squeezed by average pooling $$F_{sq}(.)$$ 
          to obtain the global spatial information by applying two fully-connected layers. An excitation process 
          $$F_{ex}(.,W)$$ is then performed to obtain the weight of each channel. Finally, the concatenated feature maps 
          are channel-wise multiplied by the weights to obtain the attention feature maps.
        </p>
        <p>
          Fig. 4 illustrates this process more clearly. Move your cursor slowly over the feature maps on the left-hand 
          side of the figure. When you hover over a particular feature map, the relevant maps within the module, i.e., the 
          extracted feature map, concatenated feature map, and attention feature map, are all highlighted. When you move to 
          a new feature map, the highlighted maps change accordingly. 
        </p>

        <div class="framed">
          <div class="inside">
            <div class="eyebrow">
              Move your cursor slowly over the feature maps on the left-hand side of the figure. When you hover over a particular 
              feature map, the relevant feature maps within the module are all highlighted.
            </div>
            <div id="board-letsplay" style="width: auto; margin: auto auto 10px;">
              <div>
  
                <!-- <label><b>Class of the region:</b>
                  <select id="class_Selector" style="font-size:15px;text-align:center;margin:0 20px 0 0px;"
                    onchange="FI_Getvalue();">
                    <option value="1" selected>Normal</option>
                    <option value="2">Tumor</option>
                    <option value="3">Necrosis</option>
                  </select>
                </label> -->
<!--   
                <label><b>Image select:</b>
                  <select id="image_Selector" style="font-size:15px;text-align:center;margin:20px 20px 0 0px;"
                    onchange="FI_Getvalue();">
                    <option value="1" selected>1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
  
                  </select>
                </label> -->
  
                <script>
                  // var Class_selector = document.getElementById("class_Selector");
                  // var image_Selector = document.getElementById("image_Selector");
  
                  function FI_HighLightBtn(btn) {
                    btn.color = "#003C9D";
                    btn.style.background = "#fff";
                    btn.border = "2px #003C9D solid";
                    btn.transform = "scale(1.15)";
  
                  }
                 
                </script>
              </div>
              <!-- magnification ==>MG -->
              <div id="FI_canvaGroup" style="position: relative;justify-content:center; align-items:center;">
                <canvas id="FI_model" height="500" width="1000" style="margin: 0 0 0 0;"></canvas>
                <canvas id="FI_picture" height="500" width="1000" style="margin: 0 0 0 0 ;"></canvas>
              </div>
  
              <script>
  
                //FI is abbreviation of "Feature Integration"
                //<Initial Condition Setting:---------------------------------->
                //<Temporary variables:---------------------------------------->
  
                //new interact var  
                var FI_Scene;
                var FI_highlightModelNumber;
                var FI_Canvas;
                var FI_CanvasAspect;                                  //
                var FI_d;                                             //margin, used by camera
                var FI_Camera;                                        //Object of Three.js
                var FI_Renderer;
                var FI_2dCanvas;
                var FI_2dCtx;
                //new interact var
                var FI_ConvIdleMaterial;
  
  
                var FI_tempLayers = [];
                var FI_layersType;
                var FI_layersSize;
  
                var FI_OS = "";
                //var MA_canvasStyle;
                var FI_Canvas2ElementStyle;
  
                var FI_canvasGroup;
                var FI_canvasGroupStyle;
                var FI_hasPressedModel = false;
  
                var FI_imageLoaded = false;
                //<---------------------------------------------->
                FI_Initialization();
  
  
                function FI_Initialization() {
                  FI_Scene = new THREE.Scene();
                  FI_Scene.background = new THREE.Color(0xffffff);
                  FI_highlightModelNumber = -1;
                  FI_Canvas = document.getElementById("FI_model");
                  FI_2dCanvas = document.getElementById("FI_picture");
                  FI_2dCtx = FI_2dCanvas.getContext('2d');
                  FI_canvasGroup = document.getElementById("FI_canvaGroup");
                  FI_CanvasAspect = FI_Canvas.width / FI_Canvas.height;
                  FI_d = 40;
                  FI_Camera = new THREE.OrthographicCamera(- FI_d * FI_CanvasAspect, FI_d * FI_CanvasAspect, FI_d, - FI_d, 1, 1000);
                  FI_Camera.lookAt(FI_Scene.position);
  
                  //MA_canvasStyle = FI_Canvas.style;
                  FI_Canvas2ElementStyle = FI_2dCanvas.style;
                  FI_canvasGroupStyle = FI_canvasGroup.style;
  
                  FI_Renderer = new THREE.WebGLRenderer({
                    canvas: FI_Canvas,
                    antialias: true,
                    alpha: true,
                  });
                  FI_Renderer.setClearColor(0x000000, 0); // the default
  
                  FI_SceneAndLight();
                  FI_SetCamera();
  
                  FI_ConvIdleMaterial = new THREE.MeshLambertMaterial({ color: 0x00ff00, emissive: 0x3c7029 });
                  FI_highlightMaterial = new THREE.MeshLambertMaterial({ color: 0xf68504, emissive: 0xbb6c2a });
                  FI_ConcatenatedFeatureMap_IdleMaterial = new THREE.MeshLambertMaterial({ color: 0xf4f45f, emissive: 0x9e9e09 });
                  FI_AttentionFeatureMap_IdleMaterial = new THREE.MeshLambertMaterial({ color: 0x725688, emissive: 0x7f4ea4 });
                  FI_PollingIdleMaterial = new THREE.MeshLambertMaterial({ color: 0x00ffff, emissive: 0x0071b3 });
  
                  //https://threejs.org/docs/#api/en/materials/MeshLambertMaterial
  
  
                  FI_layersType = ["Concatenated", "Concatenated", "Concatenated", "Concatenated", "Concatenated", "Concatenated", "Concatenated", "Concatenated", "Concatenated", "Concatenated", "Concatenated", "Concatenated", "Attention", "Attention", "Attention", "Attention", "Attention", "Attention", "Conv", "Conv", "Conv", "Pooling"];
                  FI_layersSize = [10, 10, 10, 10, 10, 10];
  
                  var FI_elementStyle = FI_2dCanvas.style;
  
                  FI_elementStyle.position = "relative";
                  FI_elementStyle.up = "600";
                  // MG_DrawCanvas();
                  FI_ShowModelArchitecture();
                  FI_osfunction();
  
                  var FI_CanvasRect = FI_Canvas.getBoundingClientRect();
                  var FI_deltaY = 0;
  
                  var FI_canvas1AbsolutePosition_y = window.pageYOffset + FI_CanvasRect.top - 290;
                  var FI_canvas1AbsolutePosition_X = window.pageXOffset + FI_CanvasRect.left + 500;
  
                  if (FI_OS == "Windows") {
  
                  }
                  else {
                    FI_deltaY = 0;
                  }
                 
                  FI_elementStyle.zIndex = "2";
                  FI_canvasGroupStyle.position = "relative";
                  FI_Canvas2ElementStyle.top = FI_Canvas2ElementStyle.up = "0px";
                  FI_Canvas2ElementStyle.right = FI_Canvas2ElementStyle.left = "0px";
  
                }
                function FI_SceneAndLight() {
                  let FI_pointLight = new THREE.PointLight(0xffffff);
                  FI_pointLight.position.set(60, 120, 0);
                  FI_Scene.add(FI_pointLight);
                }
  
                function FI_SetCamera() {
                  FI_Camera.position.z = 50;
                  FI_Camera.position.x = 30;
                  FI_Camera.position.y = 5;
                  FI_Camera.lookAt(new THREE.Vector3(0, 0, 0));
                  FI_Camera.up.set(0, 0, 0);
                }
  
                function FI_ShowModelArchitecture() {
  
                  var FI_startPositionX = 0;
                  var FI_marginOfPositionX = 1;
                  var i;
  
                  // upper model 3
                  for (i = 0; i < (FI_layersSize.length) / 2; i++) {
                    let FI_tempgemoetry = new THREE.BoxGeometry(.85, FI_layersSize[i] * 1.4, FI_layersSize[i] * 1.4);
                    let FI_cube;
  
                    if (FI_layersType[i] == "Concatenated") {
                      FI_cube = new THREE.Mesh(FI_tempgemoetry, FI_ConcatenatedFeatureMap_IdleMaterial);
                    }
                    else {
                      FI_cube = new THREE.Mesh(FI_tempgemoetry, FI_ConcatenatedFeatureMap_IdleMaterial);
                    }
  
                    FI_cube.position.x = FI_startPositionX + i * FI_marginOfPositionX - 55;
                    FI_cube.rotation.y -= 0;
                    FI_cube.position.y += 14;
                    FI_cube.rotation.x += .17;
                    FI_cube.rotation.z -= .1;
                    FI_tempLayers.push(FI_cube);
                    FI_Scene.add(FI_cube);
                  }
                  // 3
                  for (i = 0; i < (FI_layersSize.length) / 2; i++) {
                    let FI_tempgemoetry = new THREE.BoxGeometry(.85, FI_layersSize[i] * 1.4, FI_layersSize[i] * 1.4);
                    let FI_cube;
  
                    if (FI_layersType[i] == "Concatenated") {
                      FI_cube = new THREE.Mesh(FI_tempgemoetry, FI_ConcatenatedFeatureMap_IdleMaterial);
                    }
                    else {
                      FM_cubeFM_cube = new THREE.Mesh(FI_tempgemoetry, FI_ConcatenatedFeatureMap_IdleMaterial);
                    }
                    FI_cube.position.x = FI_startPositionX + i * FI_marginOfPositionX - 55;
                    FI_cube.rotation.y -= 0;
                    FI_cube.position.y -= 6;
                    FI_cube.rotation.x += .17;
                    FI_cube.rotation.z -= .1;
                    FI_tempLayers.push(FI_cube);
                    FI_Scene.add(FI_cube);
                  }
                  // 6
                  for (i = 0; i < FI_layersSize.length; i++) {
                    let FI_tempgemoetry = new THREE.BoxGeometry(.85, FI_layersSize[i] * 1.4, FI_layersSize[i] * 1.4);
                    let FI_cube;
  
                    if (FI_layersType[i] == "Concatenated") {
                      FI_cube = new THREE.Mesh(FI_tempgemoetry, FI_ConcatenatedFeatureMap_IdleMaterial);
                    }
                    else {
                      FI_cube = new THREE.Mesh(FI_tempgemoetry, FI_ConcatenatedFeatureMap_IdleMaterial);
                    }
  
                    FI_cube.position.x = FI_startPositionX + i * FI_marginOfPositionX -36;
                    FI_cube.rotation.y -= 0;
                    FI_cube.position.y += 7;
                    FI_cube.rotation.x += .17;
                    FI_cube.rotation.z -= .1;
                    FI_tempLayers.push(FI_cube);
                    FI_Scene.add(FI_cube);
                  }
                  // 6
                  for (i = 0; i < FI_layersSize.length; i++) {
                    let FI_tempgemoetry = new THREE.BoxGeometry(.85, FI_layersSize[i] * 1.4, FI_layersSize[i] * 1.4);
                    let FI_cube;
  
                    if (FI_layersType[i] == "Attention") {
                      FI_cube = new THREE.Mesh(FI_tempgemoetry, FI_AttentionFeatureMap_IdleMaterial);
                    }
                    else {
                      FI_cube = new THREE.Mesh(FI_tempgemoetry, FI_AttentionFeatureMap_IdleMaterial);
                    }
                    FI_cube.position.x = FI_startPositionX + i * FI_marginOfPositionX + 40;
                    FI_cube.rotation.y -= 0;
                    FI_cube.position.y += 10;
                    FI_cube.rotation.x += .17;
                    FI_cube.rotation.z -= .1;
                    FI_tempLayers.push(FI_cube);
                    FI_Scene.add(FI_cube);
                  }
                 
                 
                  let FI_Conv14_Geometry1 = new THREE.BoxGeometry(.7, 10, 10);
                  let FI_cube_Conv141 = new THREE.Mesh(FI_Conv14_Geometry1, FI_ConvIdleMaterial);
                  FI_tempLayers.push(FI_cube_Conv141);
                  FI_Scene.add(FI_cube_Conv141);
                  FI_cube_Conv141.rotation.x += .17;
                  FI_cube_Conv141.rotation.z -= .1;
                  FI_cube_Conv141.position.x = FI_startPositionX + i * FI_marginOfPositionX + 48;
                  FI_cube_Conv141.position.y += 10;
                  FI_cube_Conv141.position.z -= .1;
  
  
                  let FI_Conv151_Geometry = new THREE.BoxGeometry(.7, 10, 10);
                  let FI_cube_Conv151 = new THREE.Mesh(FI_Conv151_Geometry, FI_ConvIdleMaterial);
                  FI_tempLayers.push(FI_cube_Conv151);
                  FI_Scene.add(FI_cube_Conv151);
                  FI_cube_Conv151.rotation.x += .17;
                  FI_cube_Conv151.rotation.z -= .1;
                  FI_cube_Conv151.position.x = FI_startPositionX + i * FI_marginOfPositionX + 49;
                  FI_cube_Conv151.position.y += 10;
                  FI_cube_Conv151.position.z -= .1;
  
                  let FI_Conv161_Geometry = new THREE.BoxGeometry(.7, 10, 10);
                  let FI_cube_Conv161 = new THREE.Mesh(FI_Conv161_Geometry, FI_ConvIdleMaterial);
                  FI_tempLayers.push(FI_cube_Conv161);
                  FI_Scene.add(FI_cube_Conv161);
                  FI_cube_Conv161.rotation.x += .17;
                  FI_cube_Conv161.rotation.z -= .1;
                  FI_cube_Conv161.position.x = FI_startPositionX + i * FI_marginOfPositionX + 50;
                  FI_cube_Conv161.position.y += 10;
                  FI_cube_Conv161.position.z -= .1;
  
                  let FI_Polling51_Geometry = new THREE.BoxGeometry(.7, 10, 10);
                  let FI_cube_Polling51 = new THREE.Mesh(FI_Polling51_Geometry, FI_PollingIdleMaterial);
                  FI_tempLayers.push(FI_cube_Polling51);
                  FI_Scene.add(FI_cube_Polling51);
                  FI_cube_Polling51.rotation.x += .17;
                  FI_cube_Polling51.rotation.z -= .1;
                  FI_cube_Polling51.position.y += 10;
                  FI_cube_Polling51.position.z -= .1;
                  FI_cube_Polling51.position.x = FI_startPositionX + i * FI_marginOfPositionX + 51;
  
                  var FI_Canvas2ElementStyle = FI_2dCanvas.style;
                  FI_Canvas2ElementStyle.position = "absolute";
                  var FI_bodyRect = document.body.getBoundingClientRect();
                  var FI_elemRect = FI_Canvas.getBoundingClientRect();
                  offset = FI_elemRect.top - FI_bodyRect.top - 337;
                  text3 = offset.toString() + "px";
                  FI_Canvas2ElementStyle.top = FI_Canvas2ElementStyle.up = text3;
                  offset = FI_elemRect.left - FI_bodyRect.left + 5;
                  text3 = offset.toString() + "px";
                  FI_Canvas2ElementStyle.right = FI_Canvas2ElementStyle.left = text3;
                  FI_Canvas2ElementStyle.zIndex = "2"
                }
  
                FI_DrawCanvas();
                FI_Renderer.render(FI_Scene, FI_Camera);
  
                FI_2dCtx.fillStyle = "blue";
                FI_2dCtx.font = 'normal 14px'
                // FI_2dCtx.fillText('Visualized saliency map ', 662, 285);
                //https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/drawImage
                // function MG_showconvfeatureup(img1, img2, img3) {
                //   if (selectnum_F == 1) {
                //     FI_2dCtx.drawImage(img1, 185, 40, 100, 100);
                //     FI_2dCtx.drawImage(img2, 540, 40, 100, 100);
                //     FI_2dCtx.drawImage(img3, 700, 160, 100, 100);
                //     FI_2dCtx.drawImage(img_white, 447, 140, 102, 12);
                //     FI_2dCtx.drawImage(img_white, 447, 138, 80, 12);
                //     //FI_2dCtx.drawImage(img_122, 283,140,260,100);  
                //   }
                //   else if (selectnum_F == 2) {
                //     FI_2dCtx.drawImage(img1, 185, 40, 100, 100);
                //     FI_2dCtx.drawImage(img2, 540, 40, 100, 100);
                //     FI_2dCtx.drawImage(img3, 700, 160, 100, 100);
                //     FI_2dCtx.drawImage(img_white, 448, 142, 100, 10);
                //     //FI_2dCtx.drawImage(img_white, 283,140,260,80); 
                //   }
                // }
  
                function FI_DrawCanvas() {
                  var FI_count = 0;
                  // console.log("enter:DrawCanvas");
                  
                 
                  testimg3 = new Image();
                  testimg3.src = "img/necrosis/2p5x.png";
                  testimg3.onload = on_model_testimg3;
                  function on_model_testimg3() {
                    FI_onImageLoaded();
                  }
                  concate2 = new Image();
                  concate2.src = "img/model/concate2.png";
                  concate2.onload = on_model_concate2;
                  function on_model_concate2() {
                    FI_onImageLoaded();
                  }
  
                  MG_img_model_arrows = new Image();
                  MG_img_model_arrows.src = "img/model/magblock.png";
                  MG_img_model_arrows.onload = FI_on_model_arrow_loaded;
                  function FI_on_model_arrow_loaded() {
                    FI_onImageLoaded();
                  }

                  MG_img_model_singlearrow = new Image();
                  MG_img_model_singlearrow.src = "img/model/singlearrow.png";
                  MG_img_model_singlearrow.onload = FI_on_model_singlearrow;
                  function FI_on_model_singlearrow() {
                    FI_onImageLoaded();
                  }
                 
                  FI_2dCtx.fillStyle = "black";
                  FI_2dCtx.font = 'normal  bold 16px "Arial"';
                  // FI_2dCtx.fillText('High Feature Extractor ', 5, 155);
  
  
                  var FI_imagePaths = [
                    "img/num.jpg",
                    "img/num2.jpg",
                    "img/necrosis/2p5x.png",
  
                  ]
  
                  function FI_onImageLoaded() {
                    FI_count += 1;
  
                    if (FI_count >= FI_imagePaths.length) {
                      // console.log("123");
                      FI_draw2dImage();
                    }
                  }
  
                  //https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/drawImage
                  function FI_draw2dImage() {
                    FI_imageLoaded = true;
                    // FI_2dCtx.drawImage(testimg, 40, 110, 70, 70);
                    // FI_2dCtx.drawImage(testimg, 40, 240, 70, 70);
                    FI_2dCtx.drawImage(concate2, 230, 170, 90, 70);
                    FI_2dCtx.drawImage(MG_img_model_arrows, 365, 100, 300, 120);
                    FI_2dCtx.drawImage(MG_img_model_singlearrow, 10, 100, 250, 100);
                    FI_2dCtx.drawImage(MG_img_model_singlearrow, 10, 230, 250, 100);
                    FI_2dCtx.drawImage(MG_img_model_singlearrow,760, 150, 250, 100);
                  }
  
  
                }
                function FI_showimage(class_selectnum) {
                  FI_imageLoaded = true;
  
  
  
                }
                FI_2dCtx.fillStyle = "black";
                FI_2dCtx.font = 'italic bold 20px "Computer Modern / Latin Modern"'
                FI_2dCtx.fillText('F  (．)',390,160);
                FI_2dCtx.fillText('F  (．,W)',455,100);
                FI_2dCtx.font = 'italic bold 12px "Computer Modern / Latin Modern"'
                FI_2dCtx.fillText('sq',402,160);
                FI_2dCtx.fillText('ex',467,100);
                FI_2dCtx.font = 'bold 14px "Computer Modern / Latin Modern"'   
                FI_2dCtx.fillText('Extract features',65,140);
                FI_2dCtx.fillText('Extract features',65,270);
                FI_2dCtx.fillText('Classify',850,190);    
                // function FM_showconvfeaturewhite() {
                //   FI_2dCtx.drawImage(img_white, 185, 40, 100, 100);
                //   FI_2dCtx.drawImage(img_white, 540, 40, 100, 100);
                //   FI_2dCtx.drawImage(img_white, 445, 410, 50, 30);
                //   FI_2dCtx.drawImage(img_white, 700, 160, 100, 100);
                //   FI_2dCtx.drawImage(img_white, 447, 140, 102, 12);
                //   FI_2dCtx.drawImage(img_white, 447, 138, 80, 12);
                // }
  
                var class_selectnum;
                
                
  
                const FI_pickPosition = { x: 0, y: 0 };
                class FI_PickHelper {
                  constructor() {
                    this.FI_raycaster = new THREE.Raycaster();
                    this.FI_pickedObject = null;
                    this.FI_pickedObjectSavedColor = 0;
                  }
                  FI_pick(normalizedPosition, scene, camera) {
                    if (this.FI_pickedObject) {
                      if (FI_layersType[FI_tempLayers.indexOf(this.FI_pickedObject)] == "Concatenated") {
                        this.FI_pickedObject.material = FI_ConcatenatedFeatureMap_IdleMaterial;
                      }
                      else if (FI_layersType[FI_tempLayers.indexOf(this.FI_pickedObject)] == "Conv") {
                        this.FI_pickedObject.material = FI_ConvIdleMaterial;
                      }
                      else if (FI_layersType[FI_tempLayers.indexOf(this.FI_pickedObject)] == "Pooling") {
                        this.FI_pickedObject.material = FI_PollingIdleMaterial;
                      }
                      else if (FI_layersType[tempLayers.indexOf(this.FI_pickedObject)] == "Conv_1x1") {
                        this.FI_pickedObject.material = MG_Conv_1x1_IdleMaterial;
                      }
                      else if (FI_layersType[tempLayers.indexOf(this.FI_pickedObject)] == "Atrous") {
                        this.FI_pickedObject.material = MG_Atrous_IdleMaterial;
                      }
                      else if (FI_layersType[tempLayers.indexOf(this.FI_pickedObject)] == "Attention") {
                        this.FI_pickedObject.material = FI_AttentionFeatureMap_IdleMaterial;
                      }
  
                      this.FI_pickedObject = undefined;
                      FI_highLightModel(-1);
                    }
  
                    this.FI_raycaster.setFromCamera(normalizedPosition, camera);
                    // get the list of objects the ray intersected
                    const FI_intersectedObjects = this.FI_raycaster.intersectObjects(scene.children);
                    // console.log("pick : interacted Objects.length : ", FI_intersectedObjects.length);
                    if (FI_intersectedObjects.length) {
                      // pick the first object. It's the closest one
                      this.FI_pickedObject = FI_intersectedObjects[0].object;
                      // save its color
                      this.FI_pickedObjectSavedColor = this.FI_pickedObject.material.emissive.getHex();
                      this.FI_pickedObject.material = FI_highlightMaterial;
                      var FI_indexOfTempLayers = FI_tempLayers.indexOf(this.FI_pickedObject);
  
  
                      FI_highlightModelNumber = FI_indexOfTempLayers;
  
                    }
  
                    FI_highlightModelNumber = FI_intersectedObjects.length == 0 ? -1 : FI_highlightModelNumber;
                    FI_highLightModel(FI_highlightModelNumber + 1);
                  }
                }
  
  
                function FI_resizeRendererToDisplaySize(FI_renderer) {
                  const canvas = FI_renderer.domElement;
                  const width = canvas.clientWidth;
                  const height = canvas.clientHeight;
                  const needResize = canvas.width !== width || canvas.height !== height;
                  if (needResize) {
                    FI_renderer.setSize(width, height, false);
                  }
                  return needResize;
                }
                function FI_getCanvasRelativePosition(event) {
                  const canvas = FI_Renderer.domElement;
                  const rect = canvas.getBoundingClientRect();
                  return {
                    x: event.clientX - rect.left,
                    y: event.clientY - rect.top,
                  };
                }
  
                function FI_setPickPosition(event) {
                  const canvas = FI_Renderer.domElement;
                  const pos = FI_getCanvasRelativePosition(event);
                  FI_pickPosition.x = (pos.x / canvas.clientWidth) * 2 - 1;
                  FI_pickPosition.y = (pos.y / canvas.clientHeight) * -2 + 1;  // note we flip Y
                }
  
                function FI_clearPickPosition() {
                  FI_highlightModelNumber = -1;
                  FI_pickPosition.x = -100000;
                  FI_pickPosition.y = -100000;
                }
  
                function FI_checkClickPosition() {
                  // MG_showfeaturemap(FI_highlightModelNumber + 1);
                }
  
  
                function FI_osfunction() {
                  let os = navigator.userAgent;
                  let finalOs = "";
                  if (os.search('Windows') !== -1) {
                    finalOs = "Windows";
                  }
                  else if (os.search('Mac') !== -1) {
                    finalOs = "MacOS";
                  }
                  else if (os.search('X11') !== -1 && !(os.search('Linux') !== -1)) {
                    finalOs = "UNIX";
                  }
                  else if (os.search('Linux') !== -1 && os.search('X11') !== -1) {
                    finalOs = "Linux"
                  }
                  //document.getElementById('FI_OS').innerHTML = finalOs;
                  FI_OS = finalOs;
  
                }
  
                function FI_test1() {
                  FI_showimage(class_selectnum);
                }
                window.addEventListener('click', FI_checkClickPosition)
                window.addEventListener('mousemove', FI_test1)
                window.addEventListener('mousemove', FI_setPickPosition);
                window.addEventListener('mouseout', FI_clearPickPosition);
                window.addEventListener('mouseleave', FI_clearPickPosition);
                window.addEventListener('touchstart', (event) => {
                  event.preventDefault();
                  FI_setPickPosition(event.touches[0]);
                }, { passive: false });
  
                window.addEventListener('touchmove', (event) => {
                  FI_setPickPosition(event.touches[0]);
                });
  
                window.addEventListener('touchend', FI_clearPickPosition);
                const FI_pickHelper = new FI_PickHelper();
  
  
                function FI_render() {
                  if (FI_resizeRendererToDisplaySize(FI_Renderer)) {
                    const canvas = FI_Renderer.domElement;
                    FI_Camera.aspect = canvas.clientWidth / canvas.clientHeight;
                    FI_Camera.updateProjectionMatrix();
                  }
                  FI_pickHelper.FI_pick(FI_pickPosition, FI_Scene, FI_Camera);
                  FI_Renderer.render(FI_Scene, FI_Camera);
                  requestAnimationFrame(FI_render);
                  if (!FI_hasPressedModel) {
                    FI_canvasGroupStyle.right = FI_canvasGroupStyle.left = "0px";
                    return;
                  }
                  //svar tableWidth = table.offsetWidth;
                  //FI_canvasGroupStyle.right = FI_canvasGroupStyle.left = tableWidth.toString()+"px";
  
                }
                var currentHighlightIndex = 5;
                function FI_highLightModel(FI_modelNumber) {
                  if (FI_modelNumber == -1 || FI_modelNumber <= -1 || FI_modelNumber >= FI_tempLayers.length + 1) {
                    var i = 0;
                    for (i = 0; i < FI_tempLayers.length + 1; i++) {
                      if (FI_layersType[i] == "Conv") {
                        FI_tempLayers[i].material = FI_ConvIdleMaterial;
                      }
                      else if (FI_layersType[i] == "Pooling") {
                        FI_tempLayers[i].material = FI_PollingIdleMaterial;
                      }
                      else if (FI_layersType[i] == "Concatenated") {
                        FI_tempLayers[i].material = FI_ConcatenatedFeatureMap_IdleMaterial;
                      }
                      else if (FI_layersType[i] == "Attention") {
                        FI_tempLayers[i].material = FI_AttentionFeatureMap_IdleMaterial;
                      }
                      else if (FI_layersType[i] == "Conv_1x1") {
                        FI_tempLayers[i].material = MG_Conv_1x1_IdleMaterial;
                      }
                      else if (FI_layersType[i] == "Atrous") {
                        FI_tempLayers[i].material = MG_Atrous_IdleMaterial;
                      }
                    }
  
                    return;
                  }
                  // showrow(FI_modelNumber - 1);
                  if (FI_modelNumber == 0)
                    return;
                  if (FI_modelNumber >= 1 && FI_modelNumber <= 6) {
                    // console.log("FI_modelNumber:", FI_modelNumber);
                    FI_tempLayers[FI_modelNumber - 1].material = FI_highlightMaterial;
                    FI_tempLayers[FI_modelNumber + 5].material = FI_highlightMaterial;
                    FI_tempLayers[FI_modelNumber + 11].material = FI_highlightMaterial;
                  } 
                  else if(FI_modelNumber >=7 && FI_modelNumber <=12){
                    FI_tempLayers[FI_modelNumber - 7].material = FI_highlightMaterial;
                    FI_tempLayers[FI_modelNumber - 1].material = FI_highlightMaterial;
                    FI_tempLayers[FI_modelNumber +5].material = FI_highlightMaterial;
                  }
                  else if(FI_modelNumber >=13 && FI_modelNumber <=18){
                    FI_tempLayers[FI_modelNumber -7].material = FI_highlightMaterial;
                    FI_tempLayers[FI_modelNumber - 13].material = FI_highlightMaterial;
                    FI_tempLayers[FI_modelNumber -1].material = FI_highlightMaterial;
                  }
                  else if(FI_modelNumber >=19 && FI_modelNumber <=21){
                    FI_tempLayers[FI_modelNumber-1].material =FI_ConvIdleMaterial;
                  }
                  else if(FI_modelNumber ==22){
                    FI_tempLayers[FI_modelNumber-1].material =FI_PollingIdleMaterial;
                  }
                  
                    
                }
  
  
                requestAnimationFrame(FI_render);
              </script>
            </div>
            <div class="caption"><b>Figure 4. </b><br>Extracted feature maps in feature integration and magnification attention module.</div>
  
            <script type="module" src=""></script>
          </div>
        </div>

        <h3>2.3 Classification Module (CM)</h3>
        <p>
          As described earlier, the attention feature maps are provided as the input of the CM, which contains three 
          convolutional layers, a max-pooling layer, and three fully-connected layers with a softmax function. The CM 
          classifies the label of each input image patch, and the patches are then mapped back to the high-resolution WSI to 
          obtain a final segmentation result. 
        </p>
      </section>

      <section id="illustrativecasestudy">
        <h2>III. Illustratative Case Study: Cell Segmentation In Liver Histopathology Images</h2>
        <p>
          To demonstrate the usage of MMA-CNN in real-world applications, we present an illustrative 
          histopathology scenario, in which a stained liver whole slide image (WSI) is inspected to detect 
          the possible existence of hepatocellular carcinoma cancer (HCC).
          HCC is the most common liver cancer and accounts for around 75%-85% of
          all liver cancer deaths globally. The WSIs of HCC liver tissues usually contain three different regions including
          normal, tumorous, and necrotic regions. The sizes of the necrotic regions are one of the most important
          indices used to assess the severity of HCC. Consequently, one of the most important jobs of automated 
          HCC detection methods is to segment the tumorous and necrotic regions of the HCC WSIs.
        </p>
        <p>
          The tumorous regions of the HCC WSIs commonly contain a large number of tumor cells with wide trabeculae. 
          In addition, the tumor cells are usually smaller than the normal (i.e., healthy) cells. Regarding the 
          necrotic regions of the WSIs, the nuclei of the dead cells are generally darker and smaller than those of the 
          healthy cells. They may even be non-existent. Besides, severe cell disruptions are often observed. Try 
          clicking the black buttons under the WSI in Fig. 5 to observe different characteristics of the 
          three kinds of regions at different magnifications.
        </p>

        <div class="framed">
          <div class="inside" style="height: 500px;">
            <div class="eyebrow">
              Try clicking the black buttons under the WSI to observe the different characteristics of the three 
              kinds of regions at different magnifications. 
            </div>
            <div id="board-letsplay" style="width: 100%; margin: auto auto;float: left;">
              <div class="containerbox">
                <div class="box-left">
                  <div class="banner"
                    style="margin-bottom: 50px;margin: auto auto; width: max-content; display: block;">
                    <img style="z-index:1;height: 240px;width: 360px;float: left;position: relative;" src="img/1.png"
                      alt="" id="im" />
                    <div class="grid1">
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item" id="reg1"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item" id="reg2"></div>
                      <div class="grid-item" id="reg"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                      <div class="grid-item"></div>
                    </div>
                  </div>

                  <div class="leftimg">
                    <div class="btn-group" style="margin-top: 20px;">
                      <div class="btn btn-primary" style="text-align: center;">
                        <input type="button" value="Tumor" name="Tumorb" style="margin-left:50px;" id="tum">
                        <input type="button" value="Necrosis" name="Necrosisb" id="nec">
                        <input type="button" value="Normal" name="Normal" id="norm"></br>
                        <input type="button" value="X2.5" name="X2.5" style="margin-left:50px;" id="X2p5">
                        <input type="button" value="X10" name="X10" id="X10">
                        <input type="button" value="X40" name="X40" id="X40"></br>
                      </div>
                    </div>
                    <!-- <div class="caption"><b>Figure 5. </b><br> Characteristics of three regions at different magnifications and corresponding details.</div> -->
                    <div class="caption"><b>Figure 5. </b><br>Characteristics of the three kinds of regions at different magnifications.</div>
                  </div>

                </div>
                <div class="box-right" style="align-content: center;position: relative;">
                  <div class="banner">
                    <div class="window">
                      <img style="z-index:1;float:left;" src="" alt="" id="zoom" />
                    </div>
                  </div>
                  <div class="leftimg">
                  </div>
                </div>
              </div>
            </div>
            <script type="module" src=""></script>
          </div>
        </div>

        <p>
          As shown in Fig. 5, the characteristics of the three kinds of tissue regions are not only different from one 
          another at any given magnifications but also vary substantially in themselves from one magnification 
          to another. Consequently, the task of diagnosing HCC using traditional microscope methods is 
          time-consuming, laborious, and highly dependent on the expertise and experience of the pathologists. 
          Fortunately, MMA-CNN provides an automated approach to help pathologists.
          It replicates the typical actions of a pathologist in analyzing the WSIs at different 
          magnifications and combines the information obtained from each magnification to 
          achieve the final diagnosis outcome (i.e., malignant or benign).
        </p>
      </section>

      <section id="experimentalresults">

        <h2>IV. Experimental Results</h2>
        <p>
          For illustration purposes, we utilize MMA-CNN to identify three different kinds of regions in the HCC liver WSI,
          namely, normal, tumorous, and necrotic, where these regions are identified at the patch level of the WSI.
          We will show the results obtained when applying MMA-CNN to several typical HCC WSIs.
        </p>

        <h3>4.1 Dataset</h3>
        <p>
          We obtained 27 stained liver WSIs from the National Cheng Kung University hospital in
          Taiwan. The WSIs were scanned by a Leica scanner at 40x, 10x, and 2.5x magnifications and were annotated by
          an experienced pathologist to indicate the tumorous and necrotic regions.
          The WSIs were randomly assigned to three sets: a training set (15 WSIs), a validation set (five WSIs), and a testing set (seven WSIs).
          Each WSI is split into multiple small patches before inputing into MMA-CNN.
        </p>
        <p>
          To provide a clearer explanation of image labels at different magnifications, we illustrate how the 
          labels of the image patches at the higher magnification are corresponding to the equivalent patches at the 
          lower magnification. Each image patch scanned at the higher magnification is mapped to the 
          corresponding patch scanned at the lower magnification based on the spatial location (e.g., the blue 
          region) of each patch as shown in Fig. 6. Moreover, the labels of the image patches scanned at the higher 
          magnification are directly transferred to the corresponding patches scanned at the lower 
          magnification for label consistency.
        </p>

        <div class="static">
          <figure>
            <img src="img/fig6.gif" alt="Alternative text in case the image cannot be loaded."
            style="margin: auto auto; width: max-content; display: block" />
          </figure>
          <div class="caption" style="text-align: center;"><b>Figure 6. </b>Image labels at different magnifications.</div>
          <script type="module" src=""></script>
        </div>

        <h3>4.2 Magnification-Attention</h3>
        <p>
          As described in Section 2.2, the most important component of MMA-CNN is the magnification-attention 
          block, which allows the weights of the extracted features at each magnification level to be adapted 
          individually. 
          This section demonstrates the importance of the magnification-attention block by showing the 
          saliency maps generated by gradient class activation maps (Grad-CAMs) [<a href="#ref_19">19</a>] 
          with and without the block included in MMA-CNN. 
          The saliency maps indicate the regions of the image patches most closely 
          related to the classification outcome.
        </p>
        <p>
          Fig. 7 shows the saliency maps before and after weighting by the attention weights.
          The upper module in the figure is the proposed FIMAM, while the lower module serves as the 
          comparison without magnification-attention block. Move your cursor slowly over the feature maps to see the 
          saliency maps generated from each relevant feature map displayed alongside. The corresponding weight values are 
          shown beneath the channel-wise attention weights (the green cells) in the upper module. The saliency maps 
          generated from all the attention maps at the corresponding magnification are displayed as the outputs 
          of the two modules for comparisons.
        </p>

        <div class="framed">
          <div class="inside">
            <div class="eyebrow">
              Move your cursor slowly over the feature maps to see the saliency maps generated from each relevant feature 
              map displayed alongside. The corresponding weight values are shown beneath the channel-wise 
              attention weights (the green cells) in the upper module. The saliency maps generated from all the attention 
              maps at the corresponding magnification are displayed as the outputs of the two modules.
            </div>
            <div id="board-letsplay" style="width: auto; margin: auto auto 10px;">
              <div>
  
                <label><b>Class of the region:</b>
                  <select id="FM_class_Selector" style="font-size:15px;text-align:center;margin:0 20px 0 0px;"
                    onchange="FM_Getvalue();">
                    <option value="1" selected>Normal</option>
                    <option value="2">Tumorous</option>
                    <option value="3">Necrotic</option>
                  </select>
                </label>
  
                <!-- <label><b>Image select:</b>
                  <select id="image_Selector" style="font-size:15px;text-align:center;margin:20px 20px 0 0px;"
                    onchange="FM_Getvalue();">
                    <option value="1" selected>1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
  
                  </select> -->
                </label> 
  
                <script>
                  var FM_Class_selector = document.getElementById("FM_class_Selector");
                  // var image_Selector = document.getElementById("image_Selector");
  
                  function FM_HighLightBtn(btn) {
                    btn.color = "#003C9D";
                    btn.style.background = "#fff";
                    btn.border = "2px #003C9D solid";
                    btn.transform = "scale(1.15)";
  
                  }
                  // function IdleBtn(btn) {
  
                  // }
                  
                </script>
              </div>
              <!-- magnification ==>MG -->
              <div id="FM_canvaGroup" style="position: relative;justify-content:center; align-items:center;">
                <canvas id="FM_model" height="700" width="1020" style="margin: 0 0 0 0;"></canvas>
                <canvas id="FM_picture" height="700" width="1020" style="margin: 0 0 0 0 ;"></canvas>
              </div>
              
  
              <script>
  
                //FM is abbreviation of "Feauremap"
                //<Initial Condition Setting:---------------------------------->
                //<Temporary variables:---------------------------------------->
  
                //new interact var  
                var FM_Scene;
                var FM_highlightModelNumber;
                var FM_Canvas;
                var FM_CanvasAspect;                                  //
                var FM_d;                                             //margin, used by camera
                var FM_Camera;                                        //Object of Three.js
                var FM_Renderer;
                var FM_2dCanvas;
                var FM_2dCtx;
                //new interact var
                var FM_ConvIdleMaterial;
  
  
                var FM_tempLayers = [];
                var FM_layersType;
                var FM_layersSize;
  
                var FM_OS = "";
                //var MA_canvasStyle;
                var FM_Canvas2ElementStyle;
  
                var FM_canvasGroup;
                var FM_canvasGroupStyle;
                var FM_hasPressedModel = false;
  
                var FM_imageLoaded = false;
  
                let FM_selectors = new Array("", "Normal","Tumor", "Necrosis");
                var class_selectnum;
                
                var FM_featureMapsFolder = "img/GradCAMs/";
                var FM_featureMapsArray = new Array(186);
                var FM_featureMapsNumbers = 184;
                var FM_pathToImgMap = new Map();
                var FM_FeatureMaps;
  
  
  
  
                //<---------------------------------------------->
                FM_Initialization();
                FM_LoadFeatureMaps();
  
                
                function FM_Getvalue() {
                  var FM_class_selectnum = FM_Class_selector.value;
                  // var image_selectnum = image_Selector.value;
                  // class= normal
                  if (FM_class_selectnum == 1) {
                      FM_2dCtx.drawImage(NH_input, 50, 115, 70, 70);
                      FM_2dCtx.drawImage(NL_input, 50, 245, 70, 70);
                      FM_2dCtx.drawImage(NH_input, 50, 415, 70, 70);
                      FM_2dCtx.drawImage(NL_input, 50, 545, 70, 70);
                  }
                  // class = tumor
                  if (FM_class_selectnum == 2) {
                    FM_2dCtx.drawImage(TH_input, 50, 115, 70, 70);
                    FM_2dCtx.drawImage(TL_input, 50, 245, 70, 70);
                    FM_2dCtx.drawImage(TH_input, 50, 415, 70, 70);
                    FM_2dCtx.drawImage(TL_input, 50, 545, 70, 70);
                  }
                  // class = necrosis
                  if (FM_class_selectnum == 3) {
                    FM_2dCtx.drawImage(NEH_input, 50, 115, 70, 70);
                    FM_2dCtx.drawImage(NEL_input, 50, 245, 70, 70);
                    FM_2dCtx.drawImage(NEH_input, 50, 415, 70, 70);
                    FM_2dCtx.drawImage(NEL_input, 50, 545, 70, 70);
                  }
                }

                function FM_LoadFeatureMaps(){//wendian
                    FM_FeatureMaps = [
                      "img/GradCAMs/Normal/High/original.png",
                      "img/GradCAMs/Normal/High/attention.png",
                      "img/GradCAMs/Normal/High/Original/22_0_21921977.png", //normal high original
                      "img/GradCAMs/Normal/High/Original/89_0_8320793.png",
                      "img/GradCAMs/Normal/High/Original/190_0_64340913.png",//4
                      "img/GradCAMs/Normal/High/Attention/22_0_21921977.png",//normal high attention
                      "img/GradCAMs/Normal/High/Attention/89_0_8320793.png",
                      "img/GradCAMs/Normal/High/Attention/190_0_64340913.png",
                      "img/GradCAMs/Normal/Low/original.png",//8
                      "img/GradCAMs/Normal/Low/attention.png",
                      "img/GradCAMs/Normal/Low/Original/10_0_21119788.png",//normal low original
                      "img/GradCAMs/Normal/Low/Original/21_0_6898118.png",
                      "img/GradCAMs/Normal/Low/Original/318_0_6958389.png",
                      "img/GradCAMs/Normal/Low/Attention/10_0_21119788.png",//normal low attention
                      "img/GradCAMs/Normal/Low/Attention/21_0_6898118.png",
                      "img/GradCAMs/Normal/Low/Attention/318_0_6958389.png",
                      "img/GradCAMs/Tumor/High/original.png",//16
                      "img/GradCAMs/Tumor/High/attention.png",
                      "img/GradCAMs/Tumor/High/Original/191_0_66980845.png",//tumor high original
                      "img/GradCAMs/Tumor/High/Original/432_0_1492888.png",
                      "img/GradCAMs/Tumor/High/Original/457_0_72884774.png",
                      "img/GradCAMs/Tumor/High/Attention/191_0_66980845.png",//tumor high attention
                      "img/GradCAMs/Tumor/High/Attention/432_0_1492888.png",
                      "img/GradCAMs/Tumor/High/Attention/457_0_72884774.png",
                      "img/GradCAMs/Tumor/Low/original.png",//24
                      "img/GradCAMs/Tumor/Low/attention.png",
                      "img/GradCAMs/Tumor/Low/Original/105_0_6786828.png",//tumor low original
                      "img/GradCAMs/Tumor/Low/Original/157_0_8547214.png",
                      "img/GradCAMs/Tumor/Low/Original/282_0_114082634.png",
                      "img/GradCAMs/Tumor/Low/Attention/105_0_6786828.png",//tumor low attention
                      "img/GradCAMs/Tumor/Low/Attention/157_0_8547214.png",
                      "img/GradCAMs/Tumor/Low/Attention/282_0_114082634.png",
                      "img/GradCAMs/Necrosis/High/original.png",//32
                      "img/GradCAMs/Necrosis/High/attention.png",
                      "img/GradCAMs/Necrosis/High/Original/200_0_3989364.png",//necrosis high original
                      "img/GradCAMs/Necrosis/High/Original/283_0_8289472.png",
                      "img/GradCAMs/Necrosis/High/Original/339_0_7172379.png",
                      "img/GradCAMs/Necrosis/High/Attention/200_0_3989364.png",//necrosis high attention
                      "img/GradCAMs/Necrosis/High/Attention/283_0_8289472.png",
                      "img/GradCAMs/Necrosis/High/Attention/339_0_7172379.png",
                      "img/GradCAMs/Necrosis/Low/original.png",//40
                      "img/GradCAMs/Necrosis/Low/attention.png",
                      "img/GradCAMs/Necrosis/Low/Original/219_0_29449636.png",//necrosis low original
                      "img/GradCAMs/Necrosis/Low/Original/468_0_8056983.png",
                      "img/GradCAMs/Necrosis/Low/Original/501_0_35553482.png",
                      "img/GradCAMs/Necrosis/Low/Attention/219_0_29449636.png",//necrosis low attention
                      "img/GradCAMs/Necrosis/Low/Attention/468_0_8056983.png",
                      "img/GradCAMs/Necrosis/Low/Attention/501_0_35553482.png",
                      ]
                      for(i = 0; i < FM_FeatureMaps.length; i++){
                        
                        var newImg = new Image();
                        newImg.src = FM_FeatureMaps[i];
                        newImg.onload = FM_onFeatureMapLoad;
                        FM_featureMapsArray[i] = newImg;
                      }
                      // console.log("length : ", FM_FeatureMaps.length);
                    }
                  function FM_onFeatureMapLoad(){
                    FM_featureMapsNumbers --;
                    if(!FM_featureMapsNumbers){
                      // ST_Initialization();
                      for(i = 0; i < FM_FeatureMaps.length; i ++){
                        FM_pathToImgMap.set(FM_FeatureMaps[i], i);

                      }
                    }
                    
                  }

                function FM_Initialization() {
                  FM_Scene = new THREE.Scene();
                  FM_Scene.background = new THREE.Color(0xffffff);
                  FM_highlightModelNumber = -1;
                  FM_Canvas = document.getElementById("FM_model");
                  FM_2dCanvas = document.getElementById("FM_picture");
                  FM_2dCtx = FM_2dCanvas.getContext('2d');
                  FM_canvasGroup = document.getElementById("FM_canvaGroup");
                  FM_CanvasAspect = FM_Canvas.width / FM_Canvas.height;
                  FM_d = 40;
                  FM_Camera = new THREE.OrthographicCamera(- FM_d * FM_CanvasAspect, FM_d * FM_CanvasAspect, FM_d, - FM_d, 1, 1000);
                  FM_Camera.lookAt(FM_Scene.position);
  
                  //MA_canvasStyle = FM_Canvas.style;
                  FM_Canvas2ElementStyle = FM_2dCanvas.style;
                  FM_canvasGroupStyle = FM_canvasGroup.style;
  
                  FM_Renderer = new THREE.WebGLRenderer({
                    canvas: FM_Canvas,
                    antialias: true,
                    alpha: true,
                  });
                  FM_Renderer.setClearColor(0x000000, 0); // the default
  
                  FM_SceneAndLight();
                  FM_SetCamera();
  
                  FM_ConvIdleMaterial = new THREE.MeshLambertMaterial({ color: 0x00ff00, emissive: 0x3c7029 });
                  FM_highlightMaterial = new THREE.MeshLambertMaterial({ color: 0xf68504, emissive: 0xbb6c2a });
                  FM_ConcatenatedFeatureMap_IdleMaterial = new THREE.MeshLambertMaterial({ color: 0xf4f45f, emissive: 0x9e9e09 });
                  FM_AttentionFeatureMap_IdleMaterial = new THREE.MeshLambertMaterial({ color: 0x725688, emissive: 0x7f4ea4 });
                  FM_PollingIdleMaterial = new THREE.MeshLambertMaterial({ color: 0x00ffff, emissive: 0x0071b3 });
  
                  //https://threejs.org/docs/#api/en/materials/MeshLambertMaterial
  
  
                  FM_layersType = ["Concatenated", "Concatenated", "Concatenated", "Concatenated", "Concatenated", "Concatenated", "Concatenated", "Concatenated", "Concatenated", "Concatenated", "Concatenated", "Concatenated", "Attention", "Attention", "Attention", "Attention", "Attention", "Attention", "Concatenated", "Concatenated", "Concatenated", "Concatenated", "Concatenated", "Concatenated", "Concatenated", "Concatenated", "Concatenated", "Concatenated", "Concatenated", "Concatenated", "Attention", "Attention", "Attention", "Attention", "Attention", "Attention"];
                  FM_layersSize = [10, 10, 10, 10, 10, 10];
  
                  var FM_elementStyle = FM_2dCanvas.style;
  
                  FM_elementStyle.position = "relative";
                  FM_elementStyle.up = "600";
                  // MG_DrawCanvas();
                  FM_ShowModelArchitecture();
                  FM_osfunction();
  
                  var FM_CanvasRect = FM_Canvas.getBoundingClientRect();
                  var FM_deltaY = 0;
  
                  var FM_canvas1AbsolutePosition_y = window.pageYOffset + FM_CanvasRect.top - 290;
                  var FM_canvas1AbsolutePosition_X = window.pageXOffset + FM_CanvasRect.left + 500;
  
                  if (FM_OS == "Windows") {
  
                  }
                  else {
                    FM_deltaY = 0;
                  }
                  // //calculate canvas2's offset
                  // offset = FM_canvas1AbsolutePosition_y + FM_deltaY;
                  // text3 = offset.toString() + "px";
                  // FM_elementStyle.top = FM_elementStyle.up = text3;
  
                  // offset = FM_canvas1AbsolutePosition_X - 500;
                  // text3 = offset.toString() + "px";
                  // FM_elementStyle.right = FM_elementStyle.left = text3;
                  FM_elementStyle.zIndex = "2";
                  FM_canvasGroupStyle.position = "relative";
                  FM_Canvas2ElementStyle.top = FM_Canvas2ElementStyle.up = "0px";
                  FM_Canvas2ElementStyle.right = FM_Canvas2ElementStyle.left = "0px";
  
                }
  
  
  
  
                function FM_SceneAndLight() {
                  let FM_pointLight = new THREE.PointLight(0xffffff);
                  FM_pointLight.position.set(60, 120, 0);
                  FM_Scene.add(FM_pointLight);
                }
  
                function FM_SetCamera() {
                  FM_Camera.position.z = 50;
                  FM_Camera.position.x = 30;
                  FM_Camera.position.y = 5;
                  FM_Camera.lookAt(new THREE.Vector3(0, 0, 0));
                  FM_Camera.up.set(0, 0, 0);
                }
  
                function FM_ShowModelArchitecture() {
  
                  var FM_startPositionX = 0;
                  var FM_marginOfPositionX = 1;
                  var i;
  
                  // upper model 3
                  for (i = 0; i < (FM_layersSize.length) / 2; i++) {
                    let FM_tempgemoetry = new THREE.BoxGeometry(.85, FM_layersSize[i] * 1, FM_layersSize[i] * 1);
                    let FM_cube;
  
                    if (FM_layersType[i] == "Concatenated") {
                      FM_cube = new THREE.Mesh(FM_tempgemoetry, FM_ConcatenatedFeatureMap_IdleMaterial);
                    }
                    else {
                      FM_cube = new THREE.Mesh(FM_tempgemoetry, FM_ConcatenatedFeatureMap_IdleMaterial);
                    }
  
                    FM_cube.position.x = FM_startPositionX + i * FM_marginOfPositionX - 30;
                    FM_cube.rotation.y -= 0;
                    FM_cube.position.y += 23;
                    FM_cube.rotation.x += .17;
                    FM_cube.rotation.z -= .1;
                    FM_tempLayers.push(FM_cube);
                    FM_Scene.add(FM_cube);
                  }
                  // 3
                  for (i = 0; i < (FM_layersSize.length) / 2; i++) {
                    let FM_tempgemoetry = new THREE.BoxGeometry(.85, FM_layersSize[i] * 1, FM_layersSize[i] * 1);
                    let FM_cube;
  
                    if (FM_layersType[i] == "Concatenated") {
                      FM_cube = new THREE.Mesh(FM_tempgemoetry, FM_ConcatenatedFeatureMap_IdleMaterial);
                    }
                    else {
                      FM_cubeFM_cube = new THREE.Mesh(FM_tempgemoetry, FM_ConcatenatedFeatureMap_IdleMaterial);
                    }
  
                    FM_cube.position.x = FM_startPositionX + i * FM_marginOfPositionX - 30;
                    FM_cube.rotation.y -= 0;
                    FM_cube.position.y += 10;
                    FM_cube.rotation.x += .17;
                    FM_cube.rotation.z -= .1;
                    FM_tempLayers.push(FM_cube);
                    FM_Scene.add(FM_cube);
                  }
                  // 6
                  for (i = 0; i < FM_layersSize.length; i++) {
                    let FM_tempgemoetry = new THREE.BoxGeometry(.85, FM_layersSize[i] * 1, FM_layersSize[i] * 1);
                    let FM_cube;
  
                    if (FM_layersType[i] == "Concatenated") {
                      FM_cube = new THREE.Mesh(FM_tempgemoetry, FM_ConcatenatedFeatureMap_IdleMaterial);
                    }
                    else {
                      FM_cube = new THREE.Mesh(FM_tempgemoetry, FM_ConcatenatedFeatureMap_IdleMaterial);
                    }
  
                    FM_cube.position.x = FM_startPositionX + i * FM_marginOfPositionX -15;
                    FM_cube.rotation.y -= 0;
                    FM_cube.position.y += 20;
                    FM_cube.rotation.x += .17;
                    FM_cube.rotation.z -= .1;
                    FM_tempLayers.push(FM_cube);
                    FM_Scene.add(FM_cube);
                  }
                  // 6
                  for (i = 0; i < FM_layersSize.length; i++) {
                    let FM_tempgemoetry = new THREE.BoxGeometry(.85, FM_layersSize[i] * 1, FM_layersSize[i] * 1);
                    let FM_cube;
  
                    if (FM_layersType[i] == "Attention") {
                      FM_cube = new THREE.Mesh(FM_tempgemoetry, FM_AttentionFeatureMap_IdleMaterial);
                    }
                    else {
                      FM_cube = new THREE.Mesh(FM_tempgemoetry, FM_AttentionFeatureMap_IdleMaterial);
                    }
                    FM_cube.position.x = FM_startPositionX + i * FM_marginOfPositionX + 37;
                    FM_cube.rotation.y -= 0;
                    FM_cube.position.y += 21.5;
                    FM_cube.rotation.x += .17;
                    FM_cube.rotation.z -= .1;
                    FM_tempLayers.push(FM_cube);
                    FM_Scene.add(FM_cube);
                  }
                  // lower model
                  for (i = 0; i < (FM_layersSize.length) / 2; i++) {
                    let FM_tempgemoetry = new THREE.BoxGeometry(.85, FM_layersSize[i] * 1, FM_layersSize[i] * 1);
                    let FM_cube;
  
                    if (FM_layersType[i] == "Concatenated") {
                      FM_cube = new THREE.Mesh(FM_tempgemoetry, FM_ConcatenatedFeatureMap_IdleMaterial);
                    }
                    else {
                      FM_cube = new THREE.Mesh(FM_tempgemoetry, FM_ConcatenatedFeatureMap_IdleMaterial);
                    }
  
                    FM_cube.position.x = FM_startPositionX + i * FM_marginOfPositionX - 30;
                    FM_cube.rotation.y -= 0;
                    FM_cube.position.y -= 13;
                    FM_cube.rotation.x += .17;
                    FM_cube.rotation.z -= .1;
                    FM_tempLayers.push(FM_cube);
                    FM_Scene.add(FM_cube);
                  }
                  for (i = 0; i < (FM_layersSize.length) / 2; i++) {
                    let FM_tempgemoetry = new THREE.BoxGeometry(.85, FM_layersSize[i] * 1, FM_layersSize[i] * 1);
                    let FM_cube;
  
                    if (FM_layersType[i] == "Concatenated") {
                      FM_cube = new THREE.Mesh(FM_tempgemoetry, FM_ConcatenatedFeatureMap_IdleMaterial);
                    }
                    else {
                      FM_cube = new THREE.Mesh(FM_tempgemoetry, FM_ConcatenatedFeatureMap_IdleMaterial);
                    }
  
                    FM_cube.position.x = FM_startPositionX + i * FM_marginOfPositionX - 30;
                    FM_cube.rotation.y -= 0;
                    FM_cube.position.y -= 25;
                    FM_cube.rotation.x += .17;
                    FM_cube.rotation.z -= .1;
                    FM_tempLayers.push(FM_cube);
                    FM_Scene.add(FM_cube);
                  }
                  for (i = 0; i < FM_layersSize.length; i++) {
                    let FM_tempgemoetry = new THREE.BoxGeometry(.85, FM_layersSize[i] * 1, FM_layersSize[i] * 1);
                    let FM_cube;
  
                    if (FM_layersType[i] == "Concatenated") {
                      FM_cube = new THREE.Mesh(FM_tempgemoetry, FM_ConcatenatedFeatureMap_IdleMaterial);
                    }
                    else {
                      FM_cube = new THREE.Mesh(FM_tempgemoetry, FM_ConcatenatedFeatureMap_IdleMaterial);
                    }
  
                    FM_cube.position.x = FM_startPositionX + i * FM_marginOfPositionX -15;
                    FM_cube.rotation.y -= 0;
                    FM_cube.position.y -= 15;
                    FM_cube.rotation.x += .17;
                    FM_cube.rotation.z -= .1;
                    FM_tempLayers.push(FM_cube);
                    FM_Scene.add(FM_cube);
                  }
  
                  for (i = 0; i < FM_layersSize.length; i++) {
                    let FM_tempgemoetry = new THREE.BoxGeometry(.85, FM_layersSize[i] * 1, FM_layersSize[i] * 1);
                    let FM_cube;
  
                    if (FM_layersType[i] == "Attention") {
                      FM_cube = new THREE.Mesh(FM_tempgemoetry, FM_AttentionFeatureMap_IdleMaterial);
                    }
                    else {
                      FM_cube = new THREE.Mesh(FM_tempgemoetry, FM_AttentionFeatureMap_IdleMaterial);
                    }
                    FM_cube.position.x = FM_startPositionX + i * FM_marginOfPositionX + 37;
                    FM_cube.rotation.y -= 0;
                    FM_cube.position.y -= 13;
                    FM_cube.rotation.x += .17;
                    FM_cube.rotation.z -= .1;
                    FM_tempLayers.push(FM_cube);
                    FM_Scene.add(FM_cube);
                  }
  
                  var FM_Canvas2ElementStyle = FM_2dCanvas.style;
                  FM_Canvas2ElementStyle.position = "absolute";
                  var FM_bodyRect = document.body.getBoundingClientRect();
                  var FM_elemRect = FM_Canvas.getBoundingClientRect();
                  offset = FM_elemRect.top - FM_bodyRect.top - 337;
                  text3 = offset.toString() + "px";
                  FM_Canvas2ElementStyle.top = FM_Canvas2ElementStyle.up = text3;
                  offset = FM_elemRect.left - FM_bodyRect.left + 5;
                  text3 = offset.toString() + "px";
                  FM_Canvas2ElementStyle.right = FM_Canvas2ElementStyle.left = text3;
                  FM_Canvas2ElementStyle.zIndex = "2"
                }
  
                FM_DrawCanvas();
                FM_Renderer.render(FM_Scene, FM_Camera);
  
                FM_2dCtx.fillStyle = "blue";
                FM_2dCtx.font = 'normal 14px'
                // FM_2dCtx.fillText('Visualized saliency map ', 662, 285);
                //https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/drawImage
                
  
                function FM_DrawCanvas() {
                  var FM_count = 0;
                  // console.log("enter:DrawCanvas");
                  
                  
                  testimg3 = new Image();
                  testimg3.src = "img/necrosis/2p5x.png";
                  testimg3.onload = on_model_testimg3;
                  function on_model_testimg3() {
                    FM_onImageLoaded();
                  }
                  concate2 = new Image();
                  concate2.src = "img/model/concate2.png";
                  concate2.onload = on_model_concate2;
                  function on_model_concate2() {
                    FM_onImageLoaded();
                  }
                  grade_cam = new Image();
                  grade_cam.src = "img/model/gradecam.png";
                  grade_cam.onload = cam;
                  function cam() {
                    FM_onImageLoaded();
                  }
                  MG_img_model_arrows = new Image();
                  MG_img_model_arrows.src = "img/model/magblock.png";
                  MG_img_model_arrows.onload = FM_on_model_arrow_loaded;
                  function FM_on_model_arrow_loaded() {
                    FM_onImageLoaded();
                  }

                  MG_img_model_ar = new Image();
                  MG_img_model_ar.src = "img/model/ar.png";
                  MG_img_model_ar.onload = FM_on_model_ar_loaded;
                  function FM_on_model_ar_loaded() {
                    FM_onImageLoaded();
                  }
                  MG_img_model_singlearrow = new Image();
                  MG_img_model_singlearrow.src = "img/model/singlearrow.png";
                  MG_img_model_singlearrow.onload = FM_on_model_singlearrow;
                  function FM_on_model_singlearrow() {
                    FM_onImageLoaded();
                  }
                  NH_input = new Image();
                  NH_input.src = "img/GradCAMs/Normal/High/input.png";
                  NH_input.onload = normal_highinput;
                  function normal_highinput() {
                    FM_onImageLoaded();
                  }
                  NL_input = new Image();
                  NL_input.src = "img/GradCAMs/Normal/Low/input.png";
                  NL_input.onload = normal_lowinput;
                  function normal_lowinput() {
                    FM_onImageLoaded();
                  }
                  TH_input = new Image();
                  TH_input.src = "img/GradCAMs/Tumor/High/input.png";
                  TH_input.onload = tumor_highinput;
                  function tumor_highinput() {
                    FM_onImageLoaded();
                  }
                  TL_input = new Image();
                  TL_input.src = "img/GradCAMs/Tumor/Low/input.png";
                  TL_input.onload = tumor_lowinput;
                  function tumor_lowinput() {
                    FM_onImageLoaded();
                  }
                  NEH_input = new Image();
                  NEH_input.src = "img/GradCAMs/Necrosis/High/input.png";
                  NEH_input.onload = necrosis_highinput;
                  function necrosis_highinput() {
                    FM_onImageLoaded();
                  }
                  NEL_input = new Image();
                  NEL_input.src = "img/GradCAMs/Necrosis/Low/input.png";
                  NEL_input.onload = necrosis_lowinput;
                  function necrosis_lowinput() {
                    FM_onImageLoaded();
                  }
                  blackbar = new Image();
                  blackbar.src = "img/model/bar.png";
                  blackbar.onload = bar;
                  function bar() {
                    FM_onImageLoaded();
                  }
                  
                  // draw cam
                  function drawcam_high(){

                  }
                  // upper hiigh
                  function draw_upper_high(){
                    if(FM_class_selectnum == 1){
                      var upper_normal_high = new Image(300,150);
                      normal_upper_high.onload=FM_onImageLoaded;
                    }
                  }
                  img_white = new Image();
                  img_white.src = "img/featuremap/White.png";
                  img_white.onload = on_white_loaded;
                  function on_white_loaded() {
                    FM_onImageLoaded();
                  }
                 
                  FM_2dCtx.fillStyle = "black";
                  FM_2dCtx.font = 'normal  bold 16px "Arial"';
                  // FM_2dCtx.fillText('High Feature Extractor ', 5, 155);
  
  
                  var FM_imagePaths = [
                    "img/num.jpg",
                    "img/num2.jpg",
                    "img/necrosis/2p5x.png",
                  ]
  
                  function FM_onImageLoaded() {
                    FM_count += 1;
                    
                    if (FM_count >= FM_imagePaths.length) {
                      // console.log("123");
                      FM_draw2dImage();
                    }
                  }
  
                  //https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/drawImage
                  function FM_draw2dImage() {
                    FM_imageLoaded = true;
                    
                    FM_2dCtx.drawImage(concate2, 300, 160, 90, 70);
                    FM_2dCtx.drawImage(concate2, 300, 470, 90, 70);
                    FM_2dCtx.drawImage(MG_img_model_ar, 475, 380, 270, 180);
                    FM_2dCtx.drawImage(MG_img_model_arrows, 453, 80, 300, 120);

                    FM_2dCtx.drawImage(MG_img_model_singlearrow, 70, 100, 250, 100);
                    FM_2dCtx.drawImage(MG_img_model_singlearrow, 70, 400, 250, 100);
                    FM_2dCtx.drawImage(MG_img_model_singlearrow, 70, 230, 250, 100);
                    FM_2dCtx.drawImage(MG_img_model_singlearrow, 70, 530, 250, 100);

                    FM_2dCtx.drawImage(blackbar, 820, 80, 100, 200);
                    FM_2dCtx.drawImage(blackbar, 820, 380, 100, 200);

                    // FM_2dCtx.drawImage(grade_cam,840, 130, 100, 90);
                    // FM_2dCtx.drawImage(grade_cam, 840, 430, 100, 90);
                    FM_2dCtx.drawImage(NH_input, 50, 115, 70, 70);
                    FM_2dCtx.drawImage(NL_input, 50, 245, 70, 70);
                    FM_2dCtx.drawImage(NH_input, 50, 415, 70, 70);
                    FM_2dCtx.drawImage(NL_input, 50, 545, 70, 70);
                    // original upper
                    FM_2dCtx.drawImage(NH_input, 370, 35, 70, 70);
                    // attention upper
                    FM_2dCtx.drawImage(NH_input, 755, 35, 70, 70);
                    // original lower
                    FM_2dCtx.drawImage(NH_input, 370, 345, 70, 70);
                    // attention lower
                    FM_2dCtx.drawImage(NH_input, 755, 345, 70, 70);
                    // hight magnification upper
                    FM_2dCtx.drawImage(NH_input, 900, 140, 70, 70);
                    // low magnificcation upper
                    FM_2dCtx.drawImage(NH_input, 900, 140, 70, 70);
                    // high magnification lower
                    FM_2dCtx.drawImage(NH_input, 900, 445, 70, 70);
                    // low magnification lower
                    FM_2dCtx.drawImage(NH_input, 900, 445, 70, 70);
                  }
  
  
                }
                function FM_showimage(class_selectnum) {
                  FM_imageLoaded = true;
  
  
  
                }
                FM_2dCtx.fillStyle = "black";
                FM_2dCtx.font = 'italic bold 20px "Computer Modern / Latin Modern"'
                FM_2dCtx.fillText('F  (．)',475,150);
                FM_2dCtx.fillText('F  (．,W)',550,80);
                FM_2dCtx.font = 'italic bold 12px "Computer Modern / Latin Modern"'
                FM_2dCtx.fillText('sq',487,150);
                FM_2dCtx.fillText('ex',562,80);
                FM_2dCtx.font = 'bold 15px "Computer Modern / Latin Modern"'
                FM_2dCtx.fillText('Extract features',130,140);
                FM_2dCtx.fillText('Extract features',130,270);
                FM_2dCtx.fillText('Extract features',130,440);
                FM_2dCtx.fillText('Extract features',130,570);
                // FM_2dCtx.fillText('Grade-Saliency map from ',880,350);
                // FM_2dCtx.fillText('low-magnification',880,370);
                // FM_2dCtx.fillText(' feature maps',890,390);
                // FM_2dCtx.fillText('Grade-Saliency map from ',880,50);
                // FM_2dCtx.fillText('high-magnification',880,70);
                // FM_2dCtx.fillText(' attention maps',890,90);
                FM_2dCtx.fillStyle = "red";
                FM_2dCtx.font = 'normal 15px "Computer Modern / Latin Modern"'
                // FM_2dCtx.fillText('high-magnification',875,160);
                // FM_2dCtx.fillText('low-magnification',875,230);
                // FM_2dCtx.fillText('low-magnification',885,460);
                
               
                // function FM_showconvfeaturewhite() {
                //   FM_2dCtx.drawImage(img_white, 185, 40, 100, 100);
                //   FM_2dCtx.drawImage(img_white, 540, 40, 100, 100);
                //   FM_2dCtx.drawImage(img_white, 445, 410, 50, 30);
                //   FM_2dCtx.drawImage(img_white, 700, 160, 100, 100);
                //   FM_2dCtx.drawImage(img_white, 447, 140, 102, 12);
                //   FM_2dCtx.drawImage(img_white, 447, 138, 80, 12);
                // }

                function FM_showFeatureMap(FM_index) {
                    FM_class_selectnum =FM_Class_selector.value;
                    // console.log("classnum:",class_selectnum);
                    if(!FM_imageLoaded)
                      return
                      var FM_highOrLow ;
                      if(FM_index>=1 &&FM_index<= 3){FM_highOrLow='High';}
                      if(FM_index>=4 &&FM_index<= 6){FM_highOrLow='Low';}
                      if(FM_index-6>=1 &&FM_index-6<= 3){FM_highOrLow='High';}
                      if(FM_index-6>=4 &&FM_index-6<= 6){FM_highOrLow='Low';}
                      if(FM_index-12>=1 &&FM_index-12<= 3){FM_highOrLow='High';}
                      if(FM_index-12>=4 &&FM_index-12<= 6){FM_highOrLow='Low';}
                      if(FM_index-18>=1 &&FM_index-18<= 3){FM_highOrLow='High';}
                      if(FM_index-18>=4 &&FM_index-18<= 6){FM_highOrLow='Low';}
                      if(FM_index-24>=1 &&FM_index-24<= 3){FM_highOrLow='High';}
                      if(FM_index-24>=4 &&FM_index-24<= 6){FM_highOrLow='Low';}
                      var path = FM_featureMapsFolder + FM_selectors[FM_class_selectnum] + '/' +FM_highOrLow + '/';
                      // if(FM_index==1){FM_2dCtx.drawImage(testimg, 930, 480, 70, 70);}
                      // Normal-----------------------
                      if(FM_class_selectnum==1){
                        if(FM_index==1||FM_index==7||FM_index==13||FM_index==19||FM_index==25||FM_index==31){
                        FM_showcam_upper_high(FM_featureMapsArray[2],FM_featureMapsArray[5],FM_featureMapsArray[2],FM_featureMapsArray[2],FM_featureMapsArray[1],FM_featureMapsArray[0]);
                        FM_2dCtx.drawImage(img_white, 635, 127,80,20);
                        FM_2dCtx.fillText('0.219219', 640, 140);
                        FM_2dCtx.fillStyle = "black";
                        FM_2dCtx.font = 'bold 15px "Computer Modern / Latin Modern"';
                        FM_2dCtx.drawImage(img_white, 858, 327,200,80);
                        FM_2dCtx.drawImage(img_white, 858, 30,200,80);
                        FM_2dCtx.fillText('Saliency map from ',880,50);
                        FM_2dCtx.fillText('high-magnification',880,70);
                        FM_2dCtx.fillText(' attention maps',890,90);
                        FM_2dCtx.fillText('Saliency map from ',880,350);
                        FM_2dCtx.fillText('high-magnification',880,370);
                        FM_2dCtx.fillText(' feature maps',890,390);
                        }
                        else if(FM_index==2||FM_index==8||FM_index==14||FM_index==20||FM_index==26||FM_index==32){
                          FM_showcam_upper_high(FM_featureMapsArray[3],FM_featureMapsArray[6],FM_featureMapsArray[3],FM_featureMapsArray[3],FM_featureMapsArray[1],FM_featureMapsArray[0]);
                          FM_2dCtx.drawImage(img_white, 635, 127,80,20);
                          FM_2dCtx.fillText('0.832079', 640, 140);
                          FM_2dCtx.fillStyle = "black";
                          FM_2dCtx.font = 'bold 15px "Computer Modern / Latin Modern"';
                          FM_2dCtx.drawImage(img_white, 858, 327,200,80);
                          FM_2dCtx.drawImage(img_white, 858, 30,200,80);
                          FM_2dCtx.fillText('Saliency map from ',880,50);
                          FM_2dCtx.fillText('high-magnification',880,70);
                          FM_2dCtx.fillText(' attention maps',890,90);
                          FM_2dCtx.fillText('Saliency map from ',880,350);
                          FM_2dCtx.fillText('high-magnification',880,370);
                          FM_2dCtx.fillText(' feature maps',890,390);
                        }
                        else if(FM_index==3||FM_index==9||FM_index==15||FM_index==21||FM_index==27||FM_index==33){
                          FM_showcam_upper_high(FM_featureMapsArray[4],FM_featureMapsArray[7],FM_featureMapsArray[4],FM_featureMapsArray[4],FM_featureMapsArray[1],FM_featureMapsArray[0]);
                          FM_2dCtx.drawImage(img_white, 635, 127,80,20);
                          FM_2dCtx.fillText('0.643409', 640, 140);
                          FM_2dCtx.fillStyle = "black";
                          FM_2dCtx.font = 'bold 15px "Computer Modern / Latin Modern"';
                          FM_2dCtx.drawImage(img_white, 858, 327,200,80);
                          FM_2dCtx.drawImage(img_white, 858, 30,200,80);
                          FM_2dCtx.fillText('Saliency map from ',880,50);
                          FM_2dCtx.fillText('high-magnification',880,70);
                          FM_2dCtx.fillText(' attention maps',890,90);
                          FM_2dCtx.fillText('Saliency map from ',880,350);;
                          FM_2dCtx.fillText('high-magnification',880,370);
                          FM_2dCtx.fillText(' feature maps',890,390);
                        }
                        else if(FM_index==4||FM_index==10||FM_index==16||FM_index==22||FM_index==28||FM_index==34){
                          FM_showcam_upper_high(FM_featureMapsArray[10],FM_featureMapsArray[13],FM_featureMapsArray[10],FM_featureMapsArray[10],FM_featureMapsArray[9],FM_featureMapsArray[8]);
                          FM_2dCtx.drawImage(img_white, 635, 127,80,20);
                          FM_2dCtx.fillText('0.211197', 640, 140);
                          FM_2dCtx.fillStyle = "black";
                          FM_2dCtx.font = 'bold 15px "Computer Modern / Latin Modern"';
                          FM_2dCtx.drawImage(img_white, 858, 327,200,80);
                          FM_2dCtx.drawImage(img_white, 858, 30,200,80);
                          FM_2dCtx.fillText('Saliency map from ',880,350);
                          FM_2dCtx.fillText('low-magnification',880,370);
                          FM_2dCtx.fillText(' feature maps',890,390);
                          FM_2dCtx.fillText('Saliency map from ',880,50);
                          FM_2dCtx.fillText('low-magnification',880,70);
                          FM_2dCtx.fillText(' attention maps',890,90);
                          
                        }
                        else if(FM_index==5||FM_index==11||FM_index==17||FM_index==23||FM_index==29||FM_index==35){
                          FM_showcam_upper_high(FM_featureMapsArray[11],FM_featureMapsArray[14],FM_featureMapsArray[11],FM_featureMapsArray[11],FM_featureMapsArray[9],FM_featureMapsArray[8]);
                          FM_2dCtx.drawImage(img_white, 635, 127,80,20);
                          FM_2dCtx.fillText('0.689811', 640, 140);
                          FM_2dCtx.fillStyle = "black";
                          FM_2dCtx.font = 'bold 15px "Computer Modern / Latin Modern"';
                          FM_2dCtx.drawImage(img_white, 858, 327,200,80);
                          FM_2dCtx.drawImage(img_white, 858, 30,200,80);
                          FM_2dCtx.fillText('Saliency map from ',880,350);
                          FM_2dCtx.fillText('low-magnification',880,370);
                          FM_2dCtx.fillText(' feature maps',890,390);
                          FM_2dCtx.fillText('Saliency map from ',880,50);
                          FM_2dCtx.fillText('low-magnification',880,70);
                          FM_2dCtx.fillText(' attention maps',890,90);
                        }
                        else if(FM_index==6||FM_index==12||FM_index==18||FM_index==24||FM_index==30||FM_index==36){
                          FM_showcam_upper_high(FM_featureMapsArray[12],FM_featureMapsArray[15],FM_featureMapsArray[12],FM_featureMapsArray[12],FM_featureMapsArray[9],FM_featureMapsArray[8]);
                          FM_2dCtx.drawImage(img_white, 635, 127,80,20);
                          FM_2dCtx.fillText('0.695838', 640, 140);
                          FM_2dCtx.fillStyle = "black";
                          FM_2dCtx.font = 'bold 15px "Computer Modern / Latin Modern"';
                          FM_2dCtx.drawImage(img_white, 858, 327,200,80);
                          FM_2dCtx.drawImage(img_white, 858, 30,200,80);
                          FM_2dCtx.fillText('Saliency map from ',880,350);
                          FM_2dCtx.fillText('low-magnification',880,370);
                          FM_2dCtx.fillText(' feature maps',890,390);
                          FM_2dCtx.fillText('Saliency map from ',880,50);
                          FM_2dCtx.fillText('low-magnification',880,70);
                          FM_2dCtx.fillText(' attention maps',890,90);
                        }
                        else{
                          FM_imgwhite();
                        }
                      }
                      if(FM_class_selectnum==2){
                        if(FM_index==1||FM_index==7||FM_index==13||FM_index==19||FM_index==25||FM_index==31){
                          FM_showcam_upper_high(FM_featureMapsArray[18],FM_featureMapsArray[21],FM_featureMapsArray[18],FM_featureMapsArray[18],FM_featureMapsArray[17],FM_featureMapsArray[16]);
                          FM_2dCtx.drawImage(img_white, 635, 127,80,20);
                          FM_2dCtx.fillText('0.669808', 640, 140);
                          FM_2dCtx.fillStyle = "black";
                          FM_2dCtx.font = 'bold 15px "Computer Modern / Latin Modern"';
                          FM_2dCtx.drawImage(img_white, 858, 327,200,80);
                          FM_2dCtx.drawImage(img_white, 858, 30,200,80);
                          FM_2dCtx.fillText('Saliency map from ',880,50);
                          FM_2dCtx.fillText('high-magnification',880,70);
                          FM_2dCtx.fillText(' attention maps',890,90);
                          FM_2dCtx.fillText('Saliency map from ',880,350);
                          FM_2dCtx.fillText('high-magnification',880,370);
                          FM_2dCtx.fillText(' feature maps',890,390);
                        }
                        else if(FM_index==2||FM_index==8||FM_index==14||FM_index==20||FM_index==26||FM_index==32){
                          FM_showcam_upper_high(FM_featureMapsArray[19],FM_featureMapsArray[22],FM_featureMapsArray[19],FM_featureMapsArray[19],FM_featureMapsArray[17],FM_featureMapsArray[16]);
                          FM_2dCtx.drawImage(img_white, 635, 127,80,20);
                          FM_2dCtx.fillText('0.149288', 640, 140);
                          FM_2dCtx.fillStyle = "black";
                          FM_2dCtx.font = 'bold 15px "Computer Modern / Latin Modern"';
                          FM_2dCtx.drawImage(img_white, 858, 327,200,80);
                          FM_2dCtx.drawImage(img_white, 858, 30,200,80);
                          FM_2dCtx.fillText('Saliency map from ',880,50);
                          FM_2dCtx.fillText('high-magnification',880,70);
                          FM_2dCtx.fillText(' attention maps',890,90);
                          FM_2dCtx.fillText('Saliency map from ',880,350);
                          FM_2dCtx.fillText('high-magnification',880,370);
                          FM_2dCtx.fillText(' feature maps',890,390);
                        }
                        else if(FM_index==3||FM_index==9||FM_index==15||FM_index==21||FM_index==27||FM_index==33){
                          FM_showcam_upper_high(FM_featureMapsArray[20],FM_featureMapsArray[23],FM_featureMapsArray[20],FM_featureMapsArray[20],FM_featureMapsArray[17],FM_featureMapsArray[16]);
                          FM_2dCtx.drawImage(img_white, 635, 127,80,20);
                          FM_2dCtx.fillText('0.728847', 640, 140);
                          FM_2dCtx.fillStyle = "black";
                          FM_2dCtx.font = 'bold 15px "Computer Modern / Latin Modern"';
                          FM_2dCtx.drawImage(img_white, 858, 327,200,80);
                          FM_2dCtx.drawImage(img_white, 858, 30,200,80);
                          FM_2dCtx.fillText('Saliency map from ',880,50);
                          FM_2dCtx.fillText('high-magnification',880,70);
                          FM_2dCtx.fillText(' attention maps',890,90);
                          FM_2dCtx.fillText('Saliency map from ',880,350);
                          FM_2dCtx.fillText('high-magnification',880,370);
                          FM_2dCtx.fillText(' feature maps',890,390);
                        }
                        else if(FM_index==4||FM_index==10||FM_index==16||FM_index==22||FM_index==28||FM_index==34){
                          FM_showcam_upper_high(FM_featureMapsArray[26],FM_featureMapsArray[29],FM_featureMapsArray[26],FM_featureMapsArray[26],FM_featureMapsArray[25],FM_featureMapsArray[24]);
                          FM_2dCtx.drawImage(img_white, 635, 127,80,20);
                          FM_2dCtx.fillText('0.678682', 640, 140);
                          FM_2dCtx.fillStyle = "black";
                          FM_2dCtx.font = 'bold 15px "Computer Modern / Latin Modern"';
                          FM_2dCtx.drawImage(img_white, 858, 327,200,80);
                          FM_2dCtx.drawImage(img_white, 858, 30,200,80);
                          FM_2dCtx.fillText('Saliency map from ',880,350);
                          FM_2dCtx.fillText('low-magnification',880,370);
                          FM_2dCtx.fillText(' feature maps',890,390);
                          FM_2dCtx.fillText('Saliency map from ',880,50);
                          FM_2dCtx.fillText('low-magnification',880,70);
                          FM_2dCtx.fillText(' attention maps',890,90);
                        }
                        else if(FM_index==5||FM_index==11||FM_index==17||FM_index==23||FM_index==29||FM_index==35){
                          FM_showcam_upper_high(FM_featureMapsArray[27],FM_featureMapsArray[30],FM_featureMapsArray[27],FM_featureMapsArray[27],FM_featureMapsArray[25],FM_featureMapsArray[24]);
                          FM_2dCtx.drawImage(img_white, 635, 127,80,20);
                          FM_2dCtx.fillText('0.854721', 640, 140);
                          FM_2dCtx.fillStyle = "black";
                          FM_2dCtx.font = 'bold 15px "Computer Modern / Latin Modern"';
                          FM_2dCtx.drawImage(img_white, 858, 327,200,80);
                          FM_2dCtx.drawImage(img_white, 858, 30,200,80);
                          FM_2dCtx.fillText('Saliency map from ',880,350);
                          FM_2dCtx.fillText('low-magnification',880,370);
                          FM_2dCtx.fillText(' feature maps',890,390);
                          FM_2dCtx.fillText('Saliency map from ',880,50);
                          FM_2dCtx.fillText('low-magnification',880,70);
                          FM_2dCtx.fillText(' attention maps',890,90);
                        }
                        else if(FM_index==6||FM_index==12||FM_index==18||FM_index==24||FM_index==30||FM_index==36){
                          FM_showcam_upper_high(FM_featureMapsArray[28],FM_featureMapsArray[31],FM_featureMapsArray[28],FM_featureMapsArray[28],FM_featureMapsArray[25],FM_featureMapsArray[24]);
                          FM_2dCtx.drawImage(img_white, 635, 127,80,20);
                          FM_2dCtx.fillText('0.114082', 640, 140);
                          FM_2dCtx.fillStyle = "black";
                          FM_2dCtx.font = 'bold 15px "Computer Modern / Latin Modern"';
                          FM_2dCtx.drawImage(img_white, 858, 327,200,80);
                          FM_2dCtx.drawImage(img_white, 858, 30,200,80);
                          FM_2dCtx.fillText('Saliency map from ',880,350);
                          FM_2dCtx.fillText('low-magnification',880,370);
                          FM_2dCtx.fillText(' feature maps',890,390);
                          FM_2dCtx.fillText('Saliency map from ',880,50);
                          FM_2dCtx.fillText('low-magnification',880,70);
                          FM_2dCtx.fillText(' attention maps',890,90);
                        }
                        else{
                          FM_imgwhite();
                        }
                      }
                      if(FM_class_selectnum==3){
                        if(FM_index==1||FM_index==7||FM_index==13||FM_index==19||FM_index==25||FM_index==31){
                          FM_showcam_upper_high(FM_featureMapsArray[34],FM_featureMapsArray[37],FM_featureMapsArray[34],FM_featureMapsArray[34],FM_featureMapsArray[33],FM_featureMapsArray[32]);
                          FM_2dCtx.drawImage(img_white, 635, 127,80,20);
                          FM_2dCtx.fillText('0.398936', 640, 140);
                          FM_2dCtx.fillStyle = "black";
                          FM_2dCtx.font = 'bold 15px "Computer Modern / Latin Modern"';
                          FM_2dCtx.drawImage(img_white, 858, 327,200,80);
                          FM_2dCtx.drawImage(img_white, 858, 30,200,80);
                          FM_2dCtx.fillText('Saliency map from ',880,50);
                          FM_2dCtx.fillText('high-magnification',880,70);
                          FM_2dCtx.fillText(' attention maps',890,90);
                          FM_2dCtx.fillText('Saliency map from ',880,350);
                          FM_2dCtx.fillText('high-magnification',880,370);
                          FM_2dCtx.fillText(' feature maps',890,390);
                        }
                        else if(FM_index==2||FM_index==8||FM_index==14||FM_index==20||FM_index==26||FM_index==32){
                          FM_showcam_upper_high(FM_featureMapsArray[35],FM_featureMapsArray[38],FM_featureMapsArray[35],FM_featureMapsArray[35],FM_featureMapsArray[33],FM_featureMapsArray[32]);
                          FM_2dCtx.drawImage(img_white, 635, 127,80,20);
                          FM_2dCtx.fillText('0.828947', 640, 140);
                          FM_2dCtx.fillStyle = "black";
                          FM_2dCtx.font = 'bold 15px "Computer Modern / Latin Modern"';
                          FM_2dCtx.drawImage(img_white, 858, 327,200,80);
                          FM_2dCtx.drawImage(img_white, 858, 30,200,80);
                          FM_2dCtx.fillText('Saliency map from ',880,50);
                          FM_2dCtx.fillText('high-magnification',880,70);
                          FM_2dCtx.fillText(' attention maps',890,90);
                          FM_2dCtx.fillText('Saliency map from ',880,350);
                          FM_2dCtx.fillText('high-magnification',880,370);
                          FM_2dCtx.fillText(' feature maps',890,390);
                        }
                        else if(FM_index==3||FM_index==9||FM_index==15||FM_index==21||FM_index==27||FM_index==33){
                          FM_showcam_upper_high(FM_featureMapsArray[36],FM_featureMapsArray[39],FM_featureMapsArray[36],FM_featureMapsArray[36],FM_featureMapsArray[33],FM_featureMapsArray[32]);
                          FM_2dCtx.drawImage(img_white, 635, 127,80,20);
                          FM_2dCtx.fillText('0.717237', 640, 140);
                          FM_2dCtx.fillStyle = "black";
                          FM_2dCtx.font = 'bold 15px "Computer Modern / Latin Modern"';
                          FM_2dCtx.drawImage(img_white, 858, 327,200,80);
                          FM_2dCtx.drawImage(img_white, 858, 30,200,80);
                          FM_2dCtx.fillText('Saliency map from ',880,50);
                          FM_2dCtx.fillText('high-magnification',880,70);
                          FM_2dCtx.fillText(' attention maps',890,90);
                          FM_2dCtx.fillText('Saliency map from ',880,350);
                          FM_2dCtx.fillText('high-magnification',880,370);
                          FM_2dCtx.fillText(' feature maps',890,390);
                        }
                        else if(FM_index==4||FM_index==10||FM_index==16||FM_index==22||FM_index==28||FM_index==34){
                          FM_showcam_upper_high(FM_featureMapsArray[42],FM_featureMapsArray[45],FM_featureMapsArray[42],FM_featureMapsArray[42],FM_featureMapsArray[41],FM_featureMapsArray[40]);
                          FM_2dCtx.drawImage(img_white, 635, 127,80,20);
                          FM_2dCtx.fillText('0.398936', 640, 140);
                          FM_2dCtx.fillStyle = "black";
                          FM_2dCtx.font = 'bold 15px "Computer Modern / Latin Modern"';
                          FM_2dCtx.drawImage(img_white, 858, 327,200,80);
                          FM_2dCtx.drawImage(img_white, 858, 30,200,80);
                          FM_2dCtx.fillText('Saliency map from ',880,350);
                          FM_2dCtx.fillText('low-magnification',880,370);
                          FM_2dCtx.fillText(' feature maps',890,390);
                          FM_2dCtx.fillText('Saliency map from ',880,50);
                          FM_2dCtx.fillText('low-magnification',880,70);
                          FM_2dCtx.fillText(' attention maps',890,90);
                        }
                        else if(FM_index==5||FM_index==11||FM_index==17||FM_index==23||FM_index==29||FM_index==35){
                          FM_showcam_upper_high(FM_featureMapsArray[43],FM_featureMapsArray[46],FM_featureMapsArray[43],FM_featureMapsArray[43],FM_featureMapsArray[41],FM_featureMapsArray[40]);
                          FM_2dCtx.drawImage(img_white, 635, 127,80,20);
                          FM_2dCtx.fillText('0.828947', 640, 140);
                          FM_2dCtx.fillStyle = "black";
                          FM_2dCtx.font = 'bold 15px "Computer Modern / Latin Modern"';
                          FM_2dCtx.drawImage(img_white, 858, 327,200,80);
                          FM_2dCtx.drawImage(img_white, 858, 30,200,80);
                          FM_2dCtx.fillText('Saliency map from ',880,350);
                          FM_2dCtx.fillText('low-magnification',880,370);
                          FM_2dCtx.fillText(' feature maps',890,390);
                          FM_2dCtx.fillText('Saliency map from ',880,50);
                          FM_2dCtx.fillText('low-magnification',880,70);
                          FM_2dCtx.fillText(' attention maps',890,90);
                        }
                        else if(FM_index==6||FM_index==12||FM_index==18||FM_index==24||FM_index==30||FM_index==36){
                          FM_showcam_upper_high(FM_featureMapsArray[44],FM_featureMapsArray[47],FM_featureMapsArray[44],FM_featureMapsArray[44],FM_featureMapsArray[41],FM_featureMapsArray[40]);
                          FM_2dCtx.drawImage(img_white, 635, 127,80,20);
                          FM_2dCtx.fillText('0.717237', 640, 140);
                          FM_2dCtx.fillStyle = "black";
                          FM_2dCtx.font = 'bold 15px "Computer Modern / Latin Modern"';
                          FM_2dCtx.drawImage(img_white, 858, 327,200,80);
                          FM_2dCtx.drawImage(img_white, 858, 30,200,80);
                          FM_2dCtx.fillText('Saliency map from ',880,350);
                          FM_2dCtx.fillText('low-magnification',880,370);
                          FM_2dCtx.fillText(' feature maps',890,390);
                          FM_2dCtx.fillText('Saliency map from ',880,50);
                          FM_2dCtx.fillText('low-magnification',880,70);
                          FM_2dCtx.fillText(' attention maps',890,90);
                        }
                        else{
                          FM_imgwhite();
                        }
                      }
                   }
                //upper high 
                function FM_showcam_upper_high(img1,img2,img3,img4,img5,img6) {
                    if (FM_class_selectnum == 1) {
                      // original upper
                      FM_2dCtx.drawImage(img1, 370, 28, 80, 80);
                      // attention upper
                      FM_2dCtx.drawImage(img2, 755, 28, 80, 80);
                      // original lower
                      FM_2dCtx.drawImage(img3, 370, 338, 80, 80);
                      // attention lower
                      FM_2dCtx.drawImage(img4, 755, 338, 80, 80);
                      // hight magnification upper
                      FM_2dCtx.drawImage(img5, 900, 133, 80, 80);
                      // high magnification lower
                      FM_2dCtx.drawImage(img6, 900, 438, 80, 80);
                      
                    }
                    else if (FM_class_selectnum == 2) {
                     // original upper
                      FM_2dCtx.drawImage(img1, 370, 28, 80, 80);
                      // attention upper
                      FM_2dCtx.drawImage(img2, 755, 28, 80, 80);
                      // original lower
                      FM_2dCtx.drawImage(img3, 370, 338, 80, 80);
                      // attention lower
                      FM_2dCtx.drawImage(img4, 755, 338, 80, 80);
                      // hight magnification upper
                      FM_2dCtx.drawImage(img5, 900, 133, 80, 80);
                      // high magnification lower
                      FM_2dCtx.drawImage(img6, 900, 438, 80, 80);
                      
                    }
                    else if (FM_class_selectnum == 3) {
                      // original upper
                      FM_2dCtx.drawImage(img1, 370, 28, 80, 80);
                      // attention upper
                      FM_2dCtx.drawImage(img2, 755, 28, 80, 80);
                      // original lower
                      FM_2dCtx.drawImage(img3, 370, 338, 80, 80);
                      // attention lower
                      FM_2dCtx.drawImage(img4, 755, 338, 80, 80);
                      // hight magnification upper
                      FM_2dCtx.drawImage(img5, 900, 133, 80, 80);
                      // high magnification lower
                      FM_2dCtx.drawImage(img6, 900, 438, 80, 80);
                    }
                }
              
                function FM_imgwhite(){
                  // original upper
                  FM_2dCtx.drawImage(img_white,370, 28, 80, 80);
                  // attention upper
                  FM_2dCtx.drawImage(img_white, 755, 28, 80, 80);
                  // original lower
                  FM_2dCtx.drawImage(img_white, 370, 338, 80, 80);
                  // attention lower
                  FM_2dCtx.drawImage(img_white, 755, 338, 80, 80);
                  // hight magnification upper
                  FM_2dCtx.drawImage(img_white, 900, 133, 80, 80);
                  // low magnificcation upper
                  FM_2dCtx.drawImage(img_white, 900, 133, 80, 80);
                  // high magnification lower
                  FM_2dCtx.drawImage(img_white, 900, 438, 80, 80);
                  // // low magnification lower
                  FM_2dCtx.drawImage(img_white, 370, 28, 80, 80);
                  FM_2dCtx.drawImage(img_white, 638, 127,80,20);
                  //lower
                  FM_2dCtx.drawImage(img_white, 858, 327,200,80);
                  FM_2dCtx.drawImage(img_white, 858, 30,200,80);
                }

                var FM_class_selectnum;
                
  
                const FM_pickPosition = { x: 0, y: 0 };
                class FM_PickHelper {
                  constructor() {
                    this.FM_raycaster = new THREE.Raycaster();
                    this.FM_pickedObject = null;
                    this.FM_pickedObjectSavedColor = 0;
                  }
                  FM_pick(normalizedPosition, scene, camera) {
                    if (this.FM_pickedObject) {
                      if (FM_layersType[FM_tempLayers.indexOf(this.FM_pickedObject)] == "Concatenated") {
                        this.FM_pickedObject.material = FM_ConcatenatedFeatureMap_IdleMaterial;
                       
                      }
                      else if (FM_layersType[FM_tempLayers.indexOf(this.FM_pickedObject)] == "Conv") {
                        this.FM_pickedObject.material = FM_ConvIdleMaterial;
                      }
                      else if (FM_layersType[FM_tempLayers.indexOf(this.FM_pickedObject)] == "Pooling") {
                        this.FM_pickedObject.material = FM_PollingIdleMaterial;
                      }
                      else if (FM_layersType[FM_tempLayers.indexOf(this.FM_pickedObject)] == "Conv_1x1") {
                        this.FM_pickedObject.material = MG_Conv_1x1_IdleMaterial;
                      }
                      else if (FM_layersType[FM_tempLayers.indexOf(this.FM_pickedObject)] == "Atrous") {
                        this.FM_pickedObject.material = MG_Atrous_IdleMaterial;
                      }
                      else if (FM_layersType[FM_tempLayers.indexOf(this.FM_pickedObject)] == "Attention") {
                        this.FM_pickedObject.material = FM_AttentionFeatureMap_IdleMaterial;
                      }
  
                      this.FM_pickedObject = undefined;
                      FM_highLightModel(-1);
                    }
  
                    this.FM_raycaster.setFromCamera(normalizedPosition, camera);
                    // get the list of objects the ray intersected
                    const FM_intersectedObjects = this.FM_raycaster.intersectObjects(scene.children);
                    // console.log("pick : interacted Objects.length : ", FM_intersectedObjects.length);
                    if (FM_intersectedObjects.length) {
                      // pick the first object. It's the closest one
                      this.FM_pickedObject = FM_intersectedObjects[0].object;
                      // save its color
                      this.FM_pickedObjectSavedColor = this.FM_pickedObject.material.emissive.getHex();
                      this.FM_pickedObject.material = FM_highlightMaterial;
                      var FM_indexOfTempLayers = FM_tempLayers.indexOf(this.FM_pickedObject);
  
  
                      FM_highlightModelNumber = FM_indexOfTempLayers;
  
                    }
  
                    FM_highlightModelNumber = FM_intersectedObjects.length == 0 ? -1 : FM_highlightModelNumber;
                    FM_highLightModel(FM_highlightModelNumber + 1);
                  }
                }
  
  
                function FM_resizeRendererToDisplaySize(FM_renderer) {
                  const canvas = FM_renderer.domElement;
                  const width = canvas.clientWidth;
                  const height = canvas.clientHeight;
                  const needResize = canvas.width !== width || canvas.height !== height;
                  if (needResize) {
                    FM_renderer.setSize(width, height, false);
                  }
                  return needResize;
                }
                function FM_getCanvasRelativePosition(event) {
                  const canvas = FM_Renderer.domElement;
                  const rect = canvas.getBoundingClientRect();
                  return {
                    x: event.clientX - rect.left,
                    y: event.clientY - rect.top,
                  };
                }
  
                function FM_setPickPosition(event) {
                  const canvas = FM_Renderer.domElement;
                  const pos = FM_getCanvasRelativePosition(event);
                  FM_pickPosition.x = (pos.x / canvas.clientWidth) * 2 - 1;
                  FM_pickPosition.y = (pos.y / canvas.clientHeight) * -2 + 1;  // note we flip Y
                }
  
                function FM_clearPickPosition() {
                  FM_highlightModelNumber = -1;
                  FM_pickPosition.x = -100000;
                  FM_pickPosition.y = -100000;
                }
  
                function FM_checkClickPosition() {
                  // MG_showfeaturemap(FM_highlightModelNumber + 1);
                }
  
  
                function FM_osfunction() {
                  let os = navigator.userAgent;
                  let finalOs = "";
                  if (os.search('Windows') !== -1) {
                    finalOs = "Windows";
                  }
                  else if (os.search('Mac') !== -1) {
                    finalOs = "MacOS";
                  }
                  else if (os.search('X11') !== -1 && !(os.search('Linux') !== -1)) {
                    finalOs = "UNIX";
                  }
                  else if (os.search('Linux') !== -1 && os.search('X11') !== -1) {
                    finalOs = "Linux"
                  }
                  //document.getElementById('FM_OS').innerHTML = finalOs;
                  FM_OS = finalOs;
  
                }
  
                function FM_test1() {
                  FM_showFeatureMap(FM_highlightModelNumber + 1);
                  // if_uplow(FM_highlightModelNumber);
                }
                window.addEventListener('click', FM_checkClickPosition)
                window.addEventListener('mousemove', FM_test1)
                window.addEventListener('mousemove', FM_setPickPosition);
                window.addEventListener('mouseout', FM_clearPickPosition);
                window.addEventListener('mouseleave', FM_clearPickPosition);
                window.addEventListener('touchstart', (event) => {
                  event.preventDefault();
                  FM_setPickPosition(event.touches[0]);
                }, { passive: false });
  
                window.addEventListener('touchmove', (event) => {
                  FM_setPickPosition(event.touches[0]);
                });
  
                window.addEventListener('touchend', FM_clearPickPosition);
                const FM_pickHelper = new FM_PickHelper();
  
  
                function FM_render() {
                  if (FM_resizeRendererToDisplaySize(FM_Renderer)) {
                    const canvas = FM_Renderer.domElement;
                    FM_Camera.aspect = canvas.clientWidth / canvas.clientHeight;
                    FM_Camera.updateProjectionMatrix();
                  }
                  FM_pickHelper.FM_pick(FM_pickPosition, FM_Scene, FM_Camera);
                  FM_Renderer.render(FM_Scene, FM_Camera);
                  requestAnimationFrame(FM_render);
                  if (!FM_hasPressedModel) {
                    FM_canvasGroupStyle.right = FM_canvasGroupStyle.left = "0px";
                    return;
                  }
                  //svar tableWidth = table.offsetWidth;
                  //FM_canvasGroupStyle.right = FM_canvasGroupStyle.left = tableWidth.toString()+"px";
  
                }
                var currentHighlightIndex = 5;
  
  
                function FM_highLightModel(FM_modelNumber) {
                  if (FM_modelNumber == -1 || FM_modelNumber <= -1 || FM_modelNumber >= FM_tempLayers.length + 1) {
                    var i = 0;
                    for (i = 0; i < FM_tempLayers.length + 1; i++) {
                      if (FM_layersType[i] == "Conv") {
                        FM_tempLayers[i].material = FM_ConvIdleMaterial;
                        // console.log("cov");
                      }
                      else if (FM_layersType[i] == "Pooling") {
                        FM_tempLayers[i].material = FM_PollingIdleMaterial;
                      }
                      else if (FM_layersType[i] == "Concatenated") {
                        FM_tempLayers[i].material = FM_ConcatenatedFeatureMap_IdleMaterial;
                      }
                      else if (FM_layersType[i] == "Attention") {
                        FM_tempLayers[i].material = FM_AttentionFeatureMap_IdleMaterial;
                      }
                      else if (FM_layersType[i] == "Conv_1x1") {
                        FM_tempLayers[i].material = MG_Conv_1x1_IdleMaterial;
                      }
                      else if (FM_layersType[i] == "Atrous") {
                        FM_tempLayers[i].material = MG_Atrous_IdleMaterial;
                      }
                    }
  
                    return;
                  }
                  // showrow(FM_modelNumber - 1);
                  if (FM_modelNumber == 0)
                    return;
                  if (FM_modelNumber >= 1 && FM_modelNumber <= 6) {
                    // console.log("FM_modelNumber:", FM_modelNumber);
                    FM_tempLayers[FM_modelNumber - 1].material = FM_highlightMaterial;
                    FM_tempLayers[FM_modelNumber + 5].material = FM_highlightMaterial;
                    FM_tempLayers[FM_modelNumber + 11].material = FM_highlightMaterial;
                    FM_tempLayers[FM_modelNumber + 17].material = FM_highlightMaterial;
                    FM_tempLayers[FM_modelNumber + 23].material = FM_highlightMaterial;
                    FM_tempLayers[FM_modelNumber + 29].material = FM_highlightMaterial;
                  }
                  else if (FM_modelNumber >= 19 && FM_modelNumber <= 24) {
                    // console.log("FM_modelNumber:", FM_modelNumber);
                    FM_tempLayers[FM_modelNumber - 1].material = FM_highlightMaterial;
                    FM_tempLayers[FM_modelNumber - 19].material = FM_highlightMaterial;
                    FM_tempLayers[FM_modelNumber - 13].material = FM_highlightMaterial;
                    FM_tempLayers[FM_modelNumber - 7].material = FM_highlightMaterial;
                    FM_tempLayers[FM_modelNumber + 5].material = FM_highlightMaterial;
                    FM_tempLayers[FM_modelNumber + 11].material = FM_highlightMaterial;
                  }
                  // else if(FM_modelNumber >=13 && FM_modelNumber <=18){
                  //   FM_tempLayers[FM_modelNumber-1].material =FM_AttentionFeatureMap_IdleMaterial;
                  // }
                  // else if(FM_modelNumber >=31 && FM_modelNumber <=36){
                  //   FM_tempLayers[FM_modelNumber-1].material =FM_AttentionFeatureMap_IdleMaterial;
                  // }
                  else if(FM_modelNumber >=7 && FM_modelNumber <=12){
                    FM_tempLayers[FM_modelNumber - 7].material = FM_highlightMaterial;
                    FM_tempLayers[FM_modelNumber - 1].material = FM_highlightMaterial;
                    FM_tempLayers[FM_modelNumber +5].material = FM_highlightMaterial;
                    FM_tempLayers[FM_modelNumber +11].material = FM_highlightMaterial;
                    FM_tempLayers[FM_modelNumber +17].material = FM_highlightMaterial;
                    FM_tempLayers[FM_modelNumber +23].material = FM_highlightMaterial;
                  }
                  else if(FM_modelNumber >=25 && FM_modelNumber <=30){
                    FM_tempLayers[FM_modelNumber -7].material = FM_highlightMaterial;
                    FM_tempLayers[FM_modelNumber - 1].material = FM_highlightMaterial;
                    FM_tempLayers[FM_modelNumber +5].material = FM_highlightMaterial;
                    FM_tempLayers[FM_modelNumber -19].material = FM_highlightMaterial;
                    FM_tempLayers[FM_modelNumber -25].material = FM_highlightMaterial;
                    FM_tempLayers[FM_modelNumber -13].material = FM_highlightMaterial;
                  }
                  else if(FM_modelNumber >=13 && FM_modelNumber <=18){
                    FM_tempLayers[FM_modelNumber -7].material = FM_highlightMaterial;
                    FM_tempLayers[FM_modelNumber - 1].material = FM_highlightMaterial;
                    FM_tempLayers[FM_modelNumber +5].material = FM_highlightMaterial;
                    FM_tempLayers[FM_modelNumber +11].material = FM_highlightMaterial;
                    FM_tempLayers[FM_modelNumber +17].material = FM_highlightMaterial;
                    FM_tempLayers[FM_modelNumber -13].material = FM_highlightMaterial;
                  }
                  else if(FM_modelNumber >=31 && FM_modelNumber <=36){
                    FM_tempLayers[FM_modelNumber -7].material = FM_highlightMaterial;
                    FM_tempLayers[FM_modelNumber - 1].material = FM_highlightMaterial;
                    FM_tempLayers[FM_modelNumber -25].material = FM_highlightMaterial;
                    FM_tempLayers[FM_modelNumber -31].material = FM_highlightMaterial;
                    FM_tempLayers[FM_modelNumber -19].material = FM_highlightMaterial;
                    FM_tempLayers[FM_modelNumber -13].material = FM_highlightMaterial;
                  }
                    
                }
  
  
                requestAnimationFrame(FM_render);
              </script>
            </div>
            <div class="caption"><b>Figure 7. </b><br>Visualization of the saliency maps of FIMAM. </div>
  
            <script type="module" src=""></script>
          </div>
        </div>

        <p>
          As shown in Fig. 7, the magnification-attention block helps the model focus on the important 
          features, such as the nuclei, trabecular structures, and disrupted cells. For example, when examining 
          the necrotic patches, the attention maps concentrate more on the stained cytoplasm. Furthermore, at the high 
          magnification, the model classifies tumorous patches while paying more attention to the dead cells than the 
          healthy ones. At the low magnification, the saliency maps tend to focus more on the centers of the trabecular 
          structures.
        </p>

        <h3>4.3 Quantitative Results</h3>
        <p>
          To properly demonstrate the effects of the multi-magnification and attention mechanisms of the proposed 
          MMA-CNN model, this section compares the tumor and necrosis detection performance of the full model with 
          that obtained by several alternative versions of the model, in which the multi-magnification or attention 
          mechanisms are deliberately removed. 
        </p>
        <p>
          In general, the aim of MMA-CNN in the illustrative case considered here is to classify the individual
          image patches of liver tissue WSIs and then map the patch-wise classification results back to the WSIs. 
          In evaluating the segmentation and classification performance, we adopt the metrics including accuracy, sensitivity, and intersection of union (IoU) defined as follows:
        </p>


        <div class="formula-wrapper">
          <div class="formula">$$Accuracy=\frac{TP + TN}{TP + TN + FP + FN},$$</div>
          <div class="formula">$$Sensitivity=\frac{TP}{TP+FN},$$</div>
          <div class="formula">$$IoU=\frac{TP}{TP+FN+FP},$$</div>
        </div>

        <p class="inline-math">
          where $$TP$$ is the number of true positive patches, i.e., patches that are correctly classified as 
          tumorous or necrotic patches; $$FP$$ is the number of false positive patches, i.e., normal tissue patches 
          that are misclassified as tumorous or necrotic patches; $$TN$$ is the number of true negative patches, 
          i.e., normal tissue patches that are correctly classified as normal patches; and $$FN$$ is the number 
          of false negative patches, i.e., tumorous or necrotic patches that are misclassified as normal patches.
        </p>
        <p>
          Table 2 summarizes the experimental results obtained using the seven WSIs in the testing set. When a 
          single magnification (i.e., a single network) is used to classify the image patches, the sensitivity is lower 
          than that obtained by using parallel networks based on patches with different magnifications. In other 
          words, the information obtained by using image patches with different magnifications enables the network 
          to classify the tumorous and necrotic regions of the input image patches more properly.
        </p>
        <p>
          It can also be seen that the parallel network combining 40x and 10x magnifications, respectively, 
          outperforms that based on 10x and 2.5x magnifications. In other words, a higher magnification enables 
          the model to acquire more detailed information about the local features of the tissues and improves 
          the segmentation and classification performance. 
        </p>
        <p>
          The bottom two rows of the table show the results of the full MMA-CNN model 
          containing both the multi-magnification and the ASPP mechanisms. All three performance metrics 
          are improved compared with the previous two cases; particularly when the higher magnifications are employed. 
          The superior segmentation and classification performance of the full MMA-CNN model is therefore confirmed.
        </p>


        <div style="margin-bottom: 20px;">
          <table class="tabledata" style="margin: auto auto">
            <thead>
              <tr style="border-top: 3px solid black;">
                <th style="width: 200px">
                  Network
                </th>
                <th id="header" colspan='2' rowspan='2' style="width: 250px;">
                  <span style="float:right; width: 125px;text-align: right;">Metric</span><br />
                  <div style="float:left; padding-left: 40px;">Scale</div>
                </th>
                <th style="border-bottom:2px solid black;">
                  </td>
                <th colspan="2" style="border-bottom:2px solid black; text-align:center;">Tumor</td>
                <th colspan="2" style="border-bottom:2px solid black; text-align:center;">Necrosis</td>
              </tr>
              <tr style="border-bottom:2px black solid;">
                <th style="text-align:center; width: 200px;">Structure</td>
                <td style="text-align:center; width: 200px;">Accuracy</td>
                <td style="text-align:center; width: 200px;">Sensitivity</td>
                <td style="text-align:center; width: 200px;">IoU</td>
                <td style="text-align:center; width: 200px;">Sensitivity</td>
                <td style="text-align:center; width: 200px;">IoU</td>
              </tr>

              <tr style="border:none ;">
                <td style="text-align:center">Single<br>Network</td>
                <td colspan="2" style="width: 25px; text-align:center">40x</td>
                <td style="text-align:center">0.955</td>
                <td style="text-align:center">0.890</td>
                <td style="text-align:center">0.846</td>
                <td style="text-align:center">0.935</td>
                <td style="text-align:center">0.926</td>
              </tr>
              <tr style="border:none ;">
                <td style="text-align:center">Single<br>Network</td>
                <td colspan="2" style="width: 25px; text-align:center">10x</td>
                <td style="text-align:center">0.964</td>
                <td style="text-align:center">0.923</td>
                <td style="text-align:center">0.887</td>
                <td style="text-align:center">0.964</td>
                <td style="text-align:center">0.951</td>
              </tr>
              <tr style="border:none ;">
                <td style="text-align:center">Single<br>Network</td>
                <td colspan="2" style="width: 25px; text-align:center">2.5x</td>
                <td style="text-align:center">0.970</td>
                <td style="text-align:center">0.938</td>
                <td style="text-align:center">0.894</td>
                <td style="text-align:center">0.959</td>
                <td style="text-align:center">0.947</td>
              </tr>
              <tr style="border:none ;">
                <td style="text-align:center">Parallel<br>Networks</td>
                <td colspan="2" style="width: 25px; text-align:center">40x&10x</td>
                <td style="text-align:center">0.980</td>
                <td style="text-align:center">0.968</td>
                <td style="text-align:center">0.936</td>
                <td style="text-align:center">0.967</td>
                <td style="text-align:center">0.950</td>
              </tr>
              <tr style="border:none ;">
                <td style="text-align:center">Parallel<br>Networks</td>
                <td colspan="2" style="width: 25px; text-align:center">10x&2.5x</td>
                <td style="text-align:center">0.974</td>
                <td style="text-align:center">0.985</td>
                <td style="text-align:center">0.913</td>
                <td style="text-align:center">0.973</td>
                <td style="text-align:center">0.954</td>
              </tr>
              <tr style="border:none ;">
                <td style="text-align:center">MMA-<br>CNN</td>
                <td colspan="2" style="width: 25px; text-align:center">40x&10x</td>
                <td style="text-align:center">0.986</td>
                <td style="text-align:center">0.991</td>
                <td style="text-align:center">0.977</td>
                <td style="text-align:center">0.967</td>
                <td style="text-align:center">0.958</td>
              </tr>
              <tr style="border-bottom:2px black solid;">
                <td style="text-align:center">MMA-<br>CNN</td>
                <td colspan="2" style="width: 25px; text-align:center">10x&2.5x</td>
                <td style="text-align:center">0.980</td>
                <td style="text-align:center">0.976</td>
                <td style="text-align:center">0.937</td>
                <td style="text-align:center">0.977</td>
                <td style="text-align:center">0.955</td>
              </tr>
            </thead>
          </table>
          <div class="caption" style="text-align: center;"><b>Table 2. </b><br>Quantitative results.</div>
        </div>

        <p>
          As described in Section 2.3., the patch-wise classification results obtained by MMA-CNN are mapped 
          back to the WSI to obtain the segmentations of the normal, tumorous, and necrotic regions of the image as shown in Fig. 8. 
          Try clicking the toggles and drop-down menus in Fig. 8 to visualize typical segmentation results when 
          using the different models in Table 2.
        </p>

        <div class="framed">
          <div class="inside">
            <div class="eyebrow">
              Try clicking the toggles and drop-down menus to visualize typical segmentation results when using the 
              different models in Table 2.
            </div>
            <div id="segmentation-results" style="width: 1000px; margin: auto auto 10px;">


              <div style="width: 100%;">
                <select id="WSISelector" style="width: 150px; height: 40px;">
                  <option value="1005966" selected>WSI 1</option>
                  <option value="1006685">WSI 2</option>
                  <option value="1006381">WSI 3</option>
                  <option value="1006642">WSI 4</option>
                </select>
                <span>&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp</span>
                <div style="display: inline-block" style="width: 30%;">

                  <p style="display: inline-block">Normal: </p>
                  <label class="switch" style="vertical-align: middle;">
                    <input id="switch_normal" type="checkbox" checked>
                    <span class="slider round"></span>
                  </label>
                  <span>&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp</span>
                </div>
                <div style="display: inline-block" style="width: 30%;">
                  <p style="display: inline-block">Tumorous: </p>
                  <label class="switch" style="vertical-align: middle; margin-left: 10px;">
                    <input id="switch_tumor" type="checkbox" checked>
                    <span class="slider round"></span>
                  </label>
                  <span>&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp</span>
                </div>
                <div style="display: inline-block" style="width: 30%;">
                  <p style="display: inline-block">Necrotic: </p>
                  <label class="switch" style="vertical-align: middle; margin-left: 10px;">
                    <input id="switch_necrosis" type="checkbox" checked>
                    <span class="slider round"></span>
                  </label>
                  <span>&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp</span>
                </div>

              </div>
              <div id="upper_reuslts" style="width: 1000px; margin: auto auto 10px; text-align: center;">
                <div style="display: inline-block;">
                  <select style="display: block; margin: auto auto 10px" disabled>
                    <option value="Ground Truth" selected>Ground Truth</option>
                  </select>
                  <canvas id="upper_left_wsi" style="width: 450px; height: 300px; margin: auto auto 10px;"></canvas>
                </div>
                <div style="display: inline-block;">
                  <select id="MethodSelector_upper_right" style="display: block; margin: auto auto 10px">
                    <option value="2p5x">2.5x</option>
                    <option value="10x">10x</option>
                    <option value="40x" selected>40x</option>
                    <option value="10x_2p5x">2.5x & 10x</option>
                    <option value="40x_10x">10x & 40x</option>
                    <option value="10x_2p5x_ASPP">2.5x & 10x with ASPP</option>
                    <option value="40x_10x_ASPP">10x & 40x with ASPP</option>
                  </select>
                  <canvas id="upper_right_wsi" style="width: 450px; height: 300px; margin: auto auto 10px;"></canvas>
                </div>
                <div id="lower_reuslts" style="width: 1000px; margin: auto auto 10px;">
                  <div style="display: inline-block;">
                    <select id="MethodSelector_lower_left" style="display: block; margin: auto auto 10px">
                      <option value="2p5x">2.5x</option>
                      <option value="10x">10x</option>
                      <option value="40x">40x</option>
                      <option value="10x_2p5x">2.5x & 10x</option>
                      <option value="40x_10x" selected>10x & 40x</option>
                      <option value="10x_2p5x_ASPP">2.5x & 10x with ASPP</option>
                      <option value="40x_10x_ASPP">10x & 40x with ASPP</option>
                    </select>
                    <canvas id="lower_left_wsi" style="width: 450px; height: 300px; margin: auto auto 10px;"></canvas>
                  </div>
                  <div style="display: inline-block;">
                    <select id="MethodSelector_lower_right" style="display: block; margin: auto auto 10px">
                      <option value="2p5x">2.5x</option>
                      <option value="10x">10x</option>
                      <option value="40x">40x</option>
                      <option value="10x_2p5x">2.5x & 10x</option>
                      <option value="40x_10x">10x & 40x</option>
                      <option value="10x_2p5x_ASPP">2.5x & 10x with ASPP</option>
                      <option value="40x_10x_ASPP" selected>10x & 40x with ASPP</option>
                    </select>
                    <canvas id="lower_right_wsi" style="width: 450px; height: 300px; margin: auto auto 10px"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <script type="text/javascript" src='bnt.js'></script>
            <script>
              var switch_normal = document.getElementById("switch_normal")
              var switch_tumor = document.getElementById("switch_tumor")
              var switch_necrosis = document.getElementById("switch_necrosis")
              var wsi_selector = document.getElementById("WSISelector");
              var method_selector_upper_left = document.getElementById("MethodSelector_upper_left");
              var method_selector_upper_right = document.getElementById("MethodSelector_upper_right");
              var method_selector_lower_left = document.getElementById("MethodSelector_lower_left");
              var method_selector_lower_right = document.getElementById("MethodSelector_lower_right");
              var canvas_upper_left = document.getElementById("upper_left_wsi").getContext("2d");
              var canvas_upper_right = document.getElementById("upper_right_wsi").getContext("2d");
              var canvas_lower_left = document.getElementById("lower_left_wsi").getContext("2d");
              var canvas_lower_right = document.getElementById("lower_right_wsi").getContext("2d");

              // Upper Left
              function draw_image_upper_left () {
                canvas_upper_left.drawImage(this, 0, 0, 300, 150);
              }

              function draw_wsi_upper_left () {
                canvas_upper_left.drawImage(this, 0, 0, 300, 150);
                if (switch_normal.checked === true) {
                  var normal_mask = new Image(300, 150);
                  normal_mask.onload = draw_image_upper_left;
                  normal_mask.src = 'img/masks/GT/' +  wsi_selector.value + '_Normal.png';
                }
                if (switch_tumor.checked === true) {
                  var tumor_mask = new Image(300, 150);
                  tumor_mask.onload = draw_image_upper_left;
                  tumor_mask.src = 'img/masks/GT/' +  wsi_selector.value + '_Tumor.png';
                }
                if (switch_necrosis.checked === true) {
                  var necrosis_mask = new Image(300, 150);
                  necrosis_mask.onload = draw_image_upper_left;
                  necrosis_mask.src = 'img/masks/GT/' +  wsi_selector.value + '_Necrosis.png';
                }
              }

              function update_upper_left () {
                var wsi = new Image(300, 150);
                wsi.onload = draw_wsi_upper_left;
                wsi.src = 'img/masks/' + wsi_selector.value + '_WSI.png';
              }

              // Upper Right
              function draw_image_upper_right () {
                canvas_upper_right.drawImage(this, 0, 0, 300, 150);
              }

              function draw_wsi_upper_right () {
                canvas_upper_right.drawImage(this, 0, 0, 300, 150);
                if (switch_normal.checked === true) {
                  var normal_mask = new Image(300, 150);
                  normal_mask.onload = draw_image_upper_right;
                  normal_mask.src = 'img/masks/' + method_selector_upper_right.value + '/' +  wsi_selector.value + '_Normal.png';
                }
                if (switch_tumor.checked === true) {
                  var tumor_mask = new Image(300, 150);
                  tumor_mask.onload = draw_image_upper_right;
                  tumor_mask.src = 'img/masks/' + method_selector_upper_right.value + '/' +  wsi_selector.value + '_Tumor.png';
                }
                if (switch_necrosis.checked === true) {
                  var necrosis_mask = new Image(300, 150);
                  necrosis_mask.onload = draw_image_upper_right;
                  necrosis_mask.src = 'img/masks/' + method_selector_upper_right.value + '/' +  wsi_selector.value + '_Necrosis.png';
                }
              }

              function update_upper_right () {
                var wsi = new Image(300, 150);
                wsi.onload = draw_wsi_upper_right;
                wsi.src = 'img/masks/' + wsi_selector.value + '_WSI.png';
              }

              // Lower Left
              function draw_image_lower_left () {
                canvas_lower_left.drawImage(this, 0, 0, 300, 150);
              }

              function draw_wsi_lower_left () {
                canvas_lower_left.drawImage(this, 0, 0, 300, 150);
                if (switch_normal.checked === true) {
                  var normal_mask = new Image(300, 150);
                  normal_mask.onload = draw_image_lower_left;
                  normal_mask.src = 'img/masks/' + method_selector_lower_left.value + '/' +  wsi_selector.value + '_Normal.png';
                }
                if (switch_tumor.checked === true) {
                  var tumor_mask = new Image(300, 150);
                  tumor_mask.onload = draw_image_lower_left;
                  tumor_mask.src = 'img/masks/' + method_selector_lower_left.value + '/' +  wsi_selector.value + '_Tumor.png';
                }
                if (switch_necrosis.checked === true) {
                  var necrosis_mask = new Image(300, 150);
                  necrosis_mask.onload = draw_image_lower_left;
                  necrosis_mask.src = 'img/masks/' + method_selector_lower_left.value + '/' +  wsi_selector.value + '_Necrosis.png';
                }
              }

              function update_lower_left () {
                var wsi = new Image(300, 150);
                wsi.onload = draw_wsi_lower_left;
                wsi.src = 'img/masks/' + wsi_selector.value + '_WSI.png';
              }

              // Lower Right
              function draw_image_lower_right () {
                canvas_lower_right.drawImage(this, 0, 0, 300, 150);
              }

              function draw_wsi_lower_right () {
                canvas_lower_right.drawImage(this, 0, 0, 300, 150);
                if (switch_normal.checked === true) {
                  var normal_mask = new Image(300, 150);
                  normal_mask.onload = draw_image_lower_right;
                  normal_mask.src = 'img/masks/' + method_selector_lower_right.value + '/' +  wsi_selector.value + '_Normal.png';
                }
                if (switch_tumor.checked === true) {
                  var tumor_mask = new Image(300, 150);
                  tumor_mask.onload = draw_image_lower_right;
                  tumor_mask.src = 'img/masks/' + method_selector_lower_right.value + '/' +  wsi_selector.value + '_Tumor.png';
                }
                if (switch_necrosis.checked === true) {
                  var necrosis_mask = new Image(300, 150);
                  necrosis_mask.onload = draw_image_lower_right;
                  necrosis_mask.src = 'img/masks/' + method_selector_lower_right.value + '/' +  wsi_selector.value + '_Necrosis.png';
                }
              }

              function update_lower_right () {
                var wsi = new Image(300, 150);
                wsi.onload = draw_wsi_lower_right;
                wsi.src = 'img/masks/' + wsi_selector.value + '_WSI.png';
              }

              function update_all_wsi () {
                update_upper_left();
                update_upper_right();
                update_lower_left();
                update_lower_right();
              }

              update_all_wsi();

              switch_normal.onchange = function () {
                update_all_wsi();
              }

              switch_tumor.onchange = function () {
                update_all_wsi();
              }

              switch_necrosis.onchange = function () {
                update_all_wsi();
              }

              wsi_selector.onchange = function () {
                update_all_wsi();
              }
              method_selector_upper_right.onchange = function () {
                update_upper_right();
              }
              method_selector_lower_left.onchange = function () {
                update_lower_left();
              }
              method_selector_lower_right.onchange = function () {
                update_lower_right();
              }


            
            </script>
            <div class="caption"><b>Figure 8. </b><br>The segmentation results of different models shown in Table 2.</div>
          </div>
        </div>
      </section>


      <section id="conclusions">

        <h2>V. Conclusions</h2>
        <p>
          In this article, we have introduced a new CNN structure called MMA-CNN, which leverages multi-magnification 
          and attention mechanisms to improve the classification performance of the CNN by extracting and 
          combining the features of the input image patches obtained from low-resolution (global) and high-resolution (local) 
          views, respectively. We have demonstrated the practical utility of the MMA-CNN model by considering the 
          illustrative case of liver HCC pathology analysis.
        </p>
        <p>
          The results show that by applying both global and local feature information, MMA-CNN achieves better 
          segmentation and classification performance of tumorous and necrotic regions in the liver tissue image than 
          that achieved using global or local features alone. The detection performance is further improved by the 
          inclusion of a magnification-attention block, which provides an expanded field-of-view and allows feature 
          map re-weighting.
        </p>
        <p>
          We believe that MMA-CNN provides an effective tool for not only for HCC pathology analysis but also for many 
          other applications, including disease detection in medicine, defect detection in engineering, and so on. 
          We are looking forward to exploring these potential applications in future studies.
        </p>
      </section>

      

      <section class="references">
        <h2>References</h2>
        <ol>
          <li id="ref_1">
            ImageNet Classification with Deep Convolutional Neural Networks
            <br>
            <span>
              A. Krizhevsky, I. Sutskever, and G. E. Hinton, in Proceedings of Advances in Neural Information Processing Systems, vol. 25, pp. 1097-1105, 2012.
            </span>
          </li>
          <li id="ref_2">
            Very Deep Convolutional Networks for Large-Scale Image Recognition
            <br>
            <span>
              K. Simonyan and A. Zisserman, in Proceedings of the International Conference on Learning Representations, 2015.
            </span>
          </li>
          <li id="ref_3">
            Fast R-CNN
            <br>
            <span>
              R. Girshick, in Proceedings of the IEEE International Conference on Computer Vision, pp. 1440-1448, 2015.
            </span>
          </li>
          <li id="ref_4">
            Faster R-CNN: Towards Real-Time Object Detection with Region Proposal Networks
            <br>
            <span>
              S. Ren, K. He, R. Girshick, and J. Sun, IEEE Transactions on Pattern Analysis and Machine Intelligence, vol. 39, no. 6, pp. 1137-1149, 2017.
            </span>
          </li>
          <li id="ref_5">
            U-net: Convolutional Networks for Biomedical Image Segmentation
            <br>
            <span>
              O. Ronneberger, P. Fischer, and T. Brox, in Proceedings of the Medical Image Computing and Computer-Assisted Intervention, pp. 234-241, 2015.
            </span>
          </li>
          <li id="ref_6">
            Mask R-CNN
            <br>
            <span>
              K. He, G. Gkioxari, P. Dollár, and R. Girshick, in Proceedings of the IEEE International Conference on Computer Vision,  pp. 2980-2988, 2017.
            </span>
          </li>
          <li id="ref_7">
            Pathologic liver tumor detection using feature aligned multi-scale convolutional network
            <br>
            <span>
              T. L. Yang et al., Artificial Intelligence in Medicine, vol. 125, pp. 102244, 2022.
            </span>
          </li>
          <li id="ref_8">
            Imbalance-Effective Active Learning in Nucleus, Lymphocyte and Plasma Cell Detection
            <br>
            <span>
              C. T. Li et al., Interpretable and Annotation-Efficient Learning for Medical Image Computing, pp. 223-232, 2020.
            </span>
          </li>
          <li id="ref_9">
            Deep Ensemble Feature Network for Gastric Section Classification
            <br>
            <span>
              T.-H. Lin et al., IEEE Journal of Biomedical and Health Informatics, vol. 25, no. 1, pp. 77-87, 2021.
            </span>
          </li>
          <li id="ref_10">
            Vegetation Coverage Detection from Very High Resolution Satellite Imagery
            <br>
            <span>
              J. Fan, T. Chen, and S. Lu, 2015 Visual Communications and Image Processing, pp. 1-4, 2015.
            </span>
          </li>
          <li id="ref_11">
            Classifying Histopathology Whole-Slides Using Fusion of Decisions from Deep Convolutional Network on a Collection of Random Multi-Views at Multi-Magnification
            <br>
            <span>
              K. Das, S. P. K. Karri, A. Guha Roy, J. Chatterjee, and D. Sheet, in Proceedings of the IEEE 14th International Symposium on Biomedical Imaging, pp. 1024-1027, 2017.
          </li>
          <li id="ref_12">
            Automatic HCC Detection Using Convolutional Network with Multi-Magnification Input Images
            <br>
            <span>
              W.-C. Huang et al., in Proceedings of the IEEE International Conference on Artificial Intelligence Circuits and Systems, pp. 194-198, 2019.
          </li>
          <li id="ref_13">
            Multi-Magnification Image Search in Digital Pathology
            <br>
            <span>
              M. Rasoolijaberi et al., IEEE Journal of Biomedical and Health Informatics, vol. 26, no. 9, pp. 4611-4622, 2022.
          </li>
          <li id="ref_14">
            Adaptive Weighting Multi-Field-Of-View CNN for Semantic Segmentation in Pathology
            <br>
            <span>
              H. Tokunaga, Y. Teramoto, A. Yoshizawa, and R. Bise, in Proceedings of the IEEE/CVF Conference on Computer Vision and Pattern Recognition, pp. 12589-12598, 2019.
          </li>
          <li id="ref_15">
            Neural Machine Translation by Jointly Learning to Align and Translate
            <br>
            <span>
              D. Bahdanau, K. Cho, and Y. Bengio, in Proceedings of the International Conference on Learning Representations, 2015.
          </li>
          <li id="ref_16">
            DeepLab: Semantic Image Segmentation with Deep Convolutional Nets, Atrous Convolution, and Fully Connected CRFs
            <br>
            <span>
              L.-C. Chen, G. Papandreou, I. Kokkinos, K. Murphy, and A. L. Yuille, IEEE Transactions on Pattern Analysis and Machine Intelligence, vol. 40, no. 4, pp. 834-848, 2018.
          </li>
          <li id="ref_17">
            Hematoxylin and Eosin (H&E) Stained Liver Portal Area Segmentation Using Multi-Scale Receptive Field Convolutional Neural Network
            <br>
            <span>
              Q.-E. Xiao et al., IEEE Journal on Emerging and Selected Topics in Circuits and Systems, vol. 9, no. 4, pp. 623-634, 2019.
          </li>
          <li id="ref_18">
            Squeeze-and-Excitation Networks
            <br>
            <span>
              J. Hu, L. Shen, and G. Sun, in Proceedings of the IEEE Conference on Computer Vision and Pattern Recognition, pp. 7132-7141, 2018.
          </li>
          <li id="ref_19">
            Grad-CAM: Visual Explanations from Deep Networks via Gradient-Based Localization
            <br>
            <span>
              R. R. Selvaraju, M. Cogswell, A. Das, R. Vedantam, D. Parikh, and D. Batra, in Proceedings of the IEEE International Conference on Computer Vision, pp. 618-626, 2017.
          </li>


        </ol>
      </section>
    </div>

  </article><!-- End of aticle -->

  <!-- Scroll to top button -->
  <a class="scroll-top" href="#">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 312.36">
      <path fill="white" d="M0 276.77 253.12 0 512 282.48l-32.65 29.88-226.2-246.83L32.66 306.64z" />
    </svg>
  </a>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      let scrollTopBtn = document.querySelector(".scroll-top");
      window.onscroll = function () { scrollFunction(scrollTopBtn) };

      function scrollFunction(el) {
        if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
          el.style.display = "flex";
        } else {
          el.style.display = "none";
        }
      }
    });
  </script>
</body>

</html>